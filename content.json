[{"title":"Ngrok + Ollama éƒ¨ç½² localhost å¼€æºæ¨¡å‹","date":"2024-12-20T07:26:12.000Z","path":"ai/ngrok-ollama.html","text":"è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯è®°å½•å¦‚ä½•ä½¿ç”¨ ngrok åå‘ä»£ç† ollamaï¼Œæœ¬åœ°éƒ¨ç½²ï¼Œå…¬ç½‘è®¿é—®ï¼Œå®ç°ä¸æœ¬åœ° ollama èŠå¤©ï¼Œå¯ä»¥æ¯”è¾ƒå¤šç§å¼€æºæ¨¡å‹è¿”å›ç»“æœï¼Œä¸ºäº†å¿«é€Ÿé›†æˆåŠä½¿ç”¨ï¼Œä½¿ç”¨åŸºäº ollama å®ç°100%æœ¬åœ°åŒ– RAG åº”ç”¨ chatollama ï¼Œé¡¹ç›®çš„å®ç°åŸç†å¯å‚è€ƒ Youtube æ•™ç¨‹ ï¼›å°† chatollama éƒ¨ç½²åœ¨ docker ä¸Šï¼Œngrok å®ç°åå‘ä»£ç† ollama å’Œ chatollama ç«¯å£ï¼Œé…ç½®å®Œæˆä¹‹åå°±èƒ½å®ç°åœ¨å¤–ç½‘è®¿é—®æˆ‘ä»¬çš„å¼€æºæ¨¡å‹å•¦ğŸ˜„ï¼ŒPSï¼šä»¥ä¸‹çš„æ“ä½œéƒ½æ˜¯åŸºäº Mac ç”µè„‘æ‰§è¡Œçš„ã€‚ç¯å¢ƒå®‰è£…ngrokå…¨çƒåˆ†å¸ƒå¼çš„åå‘ä»£ç†ï¼Œå¯ä»¥åŠ é€Ÿæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæˆ–ç½‘ç»œæœåŠ¡ï¼Œæ— è®ºåœ¨ä½•å¤„è¿è¡Œå®ƒä»¬ï¼Œå¯ä»¥åˆ©ç”¨ ngrok åœ¨å…¬å…±çš„ç«¯ç‚¹å’Œæœ¬åœ°è¿è¡Œçš„ web æœåŠ¡å™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªå®‰å…¨çš„é€šé“ï¼ŒåŸºäº ngrok å°†æœ¬åœ°è¿è¡Œçš„æœåŠ¡å™¨æ˜ å°„åˆ°å…¬å…±ç½‘ç»œï¼Œä»è€Œèƒ½ä»å…¬ç½‘è®¿é—®ã€‚æ³¨å†Œ ngrok (ä¸æ”¯æŒ qq é‚®ç®±)å®‰è£… ngrok ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤1234// æˆ‘è¿™è¾¹å®‰è£…çš„ç‰ˆæœ¬æ˜¯ 3.18.4ï¼Œä¸åŒç³»ç»Ÿå¯¹ç‰ˆæœ¬å…¼å®¹å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®è·Ÿæˆ‘å®‰è£…ä¸€æ ·çš„ç‰ˆæœ¬$ brew install ngrok// é…ç½® token$ ngrok config add-authtoken XXXollamaollama å¸®åŠ©æœ¬åœ°å¼€å‘è€…ä½¿ç”¨å¼€æºå¤§æ¨¡å‹åº”ç”¨å®‰è£… ollamaï¼Œä»å®˜ç½‘ä¸‹è½½ ollama å®‰è£…åŒ…è¿›è¡Œå®‰è£…ï¼š!image.pngå¯ä»¥é€šè¿‡è®¿é—® http://localhost:11434/ ï¼Œç¡®è®¤ ollama æ˜¯å¦å¯åŠ¨æˆåŠŸï¼š **[chatollama](https://github.com/sugarforever/chat-ollama/tree/main) (å®ç°å®Œå…¨æœ¬åœ°åŒ–çš„ RAG åº”ç”¨)**RAG æ¡†æ¶ï¼ŒRetrieval-Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼ŒRAG æ˜¯ä¸€ç§ç»“åˆäº† ä¿¡æ¯æ£€ç´¢ï¼ˆretrievalï¼‰å’Œ ç”Ÿæˆå¼æ¨¡å‹ï¼ˆgenerationï¼‰çš„æ¡†æ¶ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨ç”Ÿæˆå›ç­”æˆ–æ–‡æœ¬æ—¶ï¼Œä¸ä»…ä¾èµ–é¢„è®­ç»ƒçš„è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ GPT ç­‰ï¼‰ï¼Œè¿˜å¼•å…¥å¤–éƒ¨æ–‡æ¡£æˆ–æ•°æ®åº“ä¸­çš„ç›¸å…³ä¿¡æ¯è¿›è¡Œæ£€ç´¢ï¼Œå¢å¼ºç”Ÿæˆå†…å®¹çš„å‡†ç¡®æ€§å’Œå¤šæ ·æ€§ã€‚ollama å¸®åŠ©æœ¬åœ°å¼€å‘è€…ä½¿ç”¨å¼€æºå¤§æ¨¡å‹åº”ç”¨ï¼Œä½¿ç”¨ ollama-js è¿›è¡Œå¼€å‘ChatOllama æ˜¯ä¸€ä¸ªåŸºäº LLMsï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰çš„å¼€æºèŠå¤©æœºå™¨äººå¹³å°ï¼Œæ”¯æŒå¤šç§è¯­è¨€æ¨¡å‹ï¼ŒåŒ…æ‹¬ï¼š- Ollama æœåŠ¡æ¨¡å‹- OpenAI- Azure OpenAI- Anthropic- Moonshot- Gemini- GroqChatOllama æ”¯æŒå¤šç§èŠå¤©ç±»å‹ï¼š- ä¸ LLMs å…è´¹èŠå¤©- åŸºäºçŸ¥è¯†åº“ä¸ LLMs èŠå¤©ChatOllama çš„åŠŸèƒ½åˆ—è¡¨ï¼š- Ollama æ¨¡å‹ç®¡ç†- çŸ¥è¯†åº“ç®¡ç†- èŠå¤©- å•†ä¸š LLMs API å¯†é’¥ç®¡ç†12// ä¸‹è½½ chat-ollama é¡¹ç›®åˆ°æœ¬åœ°$ git clone git@github.com:sugarforever/chat-ollama.gitdockerå®‰è£… docker å®‰è£…æˆåŠŸä¹‹åï¼Œç™»å½•å¯åŠ¨ docker æ¡Œé¢åº”ç”¨docker éƒ¨ç½²æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ chatollama é¡¹ç›®è·¯å¾„1234567$ cd chatollama $ cp .env.example .env// å®‰è£…ä¾èµ–ï¼Œç”¨åˆ°äº† google çš„ä¸€äº›ä¾èµ–åº“ï¼Œç»ˆç«¯éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡$ yarn install $ docker compose up// é¦–æ¬¡è¿è¡Œåœ¨ docker ä¸Šéœ€è¦åˆå§‹åŒ– SQLite æ•°æ®åº“$ docker compose exec chatollama npx prisma migrate devéƒ¨ç½²æˆåŠŸä¹‹åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œdocker å®¹å™¨å†…å¯åŠ¨äº† chatollma åº”ç”¨ï¼Œæš‚åœå’Œå¯åŠ¨æ“ä½œåç»­éƒ½å¯ä»¥ç›´æ¥åœ¨ docker æ¡Œé¢åº”ç”¨ä¸Šæ“ä½œï¼š ngrok å¤šä¸ª éš§é“é…ç½®docker é¡¹ç›®å¯åŠ¨é¡¹ç›® chatollamaï¼Œè®¿é—® http://localhost:3000/ï¼Œç¡®è®¤ chatollama æ˜¯å¦å¯åŠ¨æˆåŠŸï¼šå¦‚æœä»¥ä¸ŠéªŒè¯éƒ½æ²¡é—®é¢˜äº†ï¼Œè¿™è¾¹å¯ä»¥å¼€å§‹ä½¿ç”¨ ngrok è®¾ç½®åå‘ä»£ç†ï¼Œä½¿ç”¨å…¬ç½‘è®¿é—®æˆ‘ä»¬æœ¬åœ°çš„æœåŠ¡å™¨ï¼šæ‰¾åˆ°ç”µè„‘å®‰è£…çš„ ngrok.yml é…ç½®æ–‡ä»¶ï¼Œåœ¨è®¾ç½® authtoken çš„æ—¶å€™ç»ˆç«¯ä¼šè¿”å›å…¶å¯¹åº”çš„è·¯å¾„ï¼Œåœ¨ ngrok.yml é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼Œå®ç°å…è´¹ç‰ˆæœ¬çš„ ngrok ä»£ç†å¤šä¸ªç«¯å£åŠŸèƒ½ï¼š12345678910// åœ¨ ngrok.yml æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®tunnels: allama: addr: 11434 proto: http request_header: add: [\"Host: localhost:11434\"] chatollama: addr: 3000 proto: http12// å¯åŠ¨ ngrok $ ngrok start --allå¯åŠ¨æˆåŠŸåå¯ä»¥åœ¨æµè§ˆå™¨ä¸Šè®¿é—® https://c0e3-222-248-214-8.ngrok-free.appï¼Œç‚¹å‡» view site åˆ™å¯æˆåŠŸè¿›å…¥ chatollama ç½‘ç«™ï¼š è®¿é—® https://87e0-222-248-214-8.ngrok-free.app éªŒè¯ ollama æ˜¯å¦èƒ½è®¿é—®æˆåŠŸï¼Œç‚¹å‡» view site, æ˜¾ç¤º Ollama is runningï¼šé…ç½® ollama æœåŠ¡ï¼Œç¡®ä¿èƒ½æ­£ç¡®ä¸‹è½½é…ç½®æ¨¡å‹ï¼Œç‚¹å‡»ä¿å­˜ï¼Œè¿™æ—¶å€™ç½‘ç«™å°±èƒ½æ­£å¸¸ä½¿ç”¨äº†ï¼Œå¦‚æœæƒ³è¦æ”¯æŒæ›´å¤šçš„æ¨¡å‹åˆ™å¯ä»¥åœ¨è®¾ç½®é‡Œå¡«ä¸Šå¯¹åº”çš„ API Key åŠ è½½å¯¹åº”çš„æ¨¡å‹ç‚¹å‡»æ¨¡å‹é€‰é¡¹ï¼Œæœç´¢ä¸‹è½½æ¨¡å‹ï¼Œollama ç½‘ç«™ä¸Šæ”¯æŒçš„æ¨¡å‹å‡èƒ½ä¸‹è½½ å¼€å¯å¯¹è¯ï¼Œé€‰æ‹©æƒ³è¦çš„æ¨¡å‹ç±»å‹ï¼Œè¿™æ—¶å€™å°±èƒ½è¿›è¡ŒèŠå¤©å•¦ï¼Œç„¶åæˆ‘ä»¬è¿˜èƒ½å¾—åˆ°æ‰€æœ‰æ¨¡å‹çš„å›ç­”ï¼Œé’ˆå¯¹ä¸åŒçš„ç­”æ¡ˆæˆ‘ä»¬å°±èƒ½è¿›è¡Œå‚ç›´çš„å¯¹æ¯”å•¦ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªè‡ªå·±è®¤ä¸ºæ›´å¥½çš„ç­”æ¡ˆï¼š ä»¥ä¸Šæ‰€æœ‰å°±æ˜¯å¦‚ä½•éƒ¨ç½² chatollama é¡¹ç›®ï¼Œå¹¶ä½¿ç”¨ ngrok è¿›è¡Œåå‘ä»£ç†ï¼Œå®ç°å…¬ç½‘è®¿é—®ï¼Œåœ¨ä¸–ç•Œä»»ä½•åœ°æ–¹éƒ½èƒ½ä¸ localhost å¼€æºå¤§æ¨¡å‹èŠå¤©çš„è¯¦ç»†æ•™ç¨‹ã€‚è¿™ä¸ªæ•™ç¨‹åªæ˜¯æ•™æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ï¼Œå…³äº chatollama RAG åº”ç”¨çš„å®ç°å¯ä»¥å‚è€ƒ langchain ç³»åˆ—æ•™ç¨‹ ä»¥åŠç½‘ä¸Šçš„è§†é¢‘æ•™ç¨‹Reference:https://www.youtube.com/playlist?list=PL2fGiugrNoojftjcvaxJfsCEWqUEAPmvehttps://github.com/sugarforever/LangChain-Tutorials","tags":[{"name":"AI","slug":"AI","permalink":"https://orangeschen.cn/tags/AI/"}]},{"title":"ä½¿ç”¨ Pigeon å®ç°è·¨å¹³å°æ–¹æ³•è°ƒç”¨","date":"2023-10-30T12:48:59.000Z","path":"flutter/flutter_pigeon.html","text":"ç®€ä»‹Pigeon æ˜¯åœ¨ Flutter 1.20 å‘å¸ƒçš„ï¼Œä¸ºäº†è§£å†³ Flutter è°ƒç”¨ native ä»£ç è¿‡äºéº»çƒ¦å’Œå›°éš¾ï¼Œéœ€è¦åœ¨å­—ç¬¦ä¸²çš„åŸºç¡€ä¸ŠåŒ¹é…å‡½æ•°åå’Œå‚æ•°ï¼Œé€šè¿‡ä½¿ç”¨è¿™ä¸ªåŒ…å¯ä»¥å®ç°ä¸ native ç±»å‹å®‰å…¨é€šä¿¡Flutter è°ƒç”¨ Native æ–¹æ³• ( @HostApi() )Native è°ƒç”¨ Flutter æ–¹æ³• ( @FlutterApi() )é€šè¿‡è‡ªåŠ¨ç”Ÿæˆå‡å°‘æ‰‹å†™ä»£ç é‡platform_channelsè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯è¯¦ç»†æè¿°äº†å¦‚ä½•ä½¿ç”¨ Pigeon ä» Flutter ç«¯è°ƒç”¨ä¸€ä¸ªåœ¨ Swift/Kotlin ä¸­å®ç°çš„ç®€å• getPlatformVersion æ–¹æ³•ã€‚å®ä¾‹é¡¹ç›®å¯åœ¨æ­¤å¤„è·å¾—ã€‚åˆ›å»º Flutter app12$ flutter create -i swift -a kotlin flutter_pigeonPigeon æ˜¯åšä»€ä¹ˆçš„Java/Objective-C æ¥å£åè®®æ˜¯æ ¹æ® Dart ç«¯å®šä¹‰çš„å‚æ•°å’Œè¿”å›å€¼ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆçš„ã€‚åŸç”ŸåŸºäºè¿™äº›æ¥å£å®ç°ï¼Œå¯ä»¥ä¸ Flutter ç«¯è¿›è¡Œç±»å‹å®‰å…¨é€šä¿¡ã€‚ç±»ä¼¼äºä½¿ç”¨ TypeScript åˆ›å»ºç±»å‹å®šä¹‰æ–‡ä»¶ã€‚å®‰è£…123456# pubspec.yamldev_dependencies: pigeon: ^1.0.0Darté¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªå®šä¹‰ä¸åŸç”Ÿé€šä¿¡çš„ dart æ–‡ä»¶ã€‚åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º pigeon/schema.dart æ–‡ä»¶123456789101112131415161718192021222324// schema.dartimport 'package:pigeon/pigeon.dart';// Flutter è°ƒç”¨åŸç”Ÿä»£ç @HostApi()abstract class Api &#123; String getPlatformVersion();&#125;// åŸç”Ÿè°ƒç”¨ Flutter@FlutterApi()abstract class FlutterApi &#123; void sessionInvalid();&#125;æ–°å»ºè„šæœ¬æ–‡ä»¶ run_pigeon.sh123456789101112131415161718# run_pigeon.h$ flutter pub run pigeon \\ --input pigeon/schema.dart \\ --dart_out lib/api_generated.dart \\ --objc_header_out ios/Runner/Pigeon.h \\ --objc_source_out ios/Runner/Pigeon.m \\ --objc_prefix FLT \\ --java_out android/app/src/main/java/io/flutter/plugins/Pigeon.java \\ --java_package \"io.flutter.plugins\"è¿è¡Œè„šæœ¬è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ¥å£æ–‡ä»¶12$ ./run_pigeon.shè„šæœ¬è¿è¡ŒæˆåŠŸåï¼ŒAndroidã€iOS é¡¹ç›®ä¼šç”Ÿæˆå¯¹åº”çš„æ¥å£æ–‡ä»¶ï¼Œå¦‚å›¾æ‰€ç¤ºï¼šAndroid å’Œ iOS åŸç”Ÿä¸­éœ€è¦åˆ†åˆ«å®ç°å¯¹åº”çš„æ¥å£åè®®KotlinAPI æ¥å£å†™åœ¨ Pigeon ç”Ÿæˆçš„ Java æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªå®ç°å®ƒçš„ç±»ï¼Œå¹¶ä¼ é€’ç»™ setup æ–¹æ³•ã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061// MainActivity.ktclass MainActivity: FlutterActivity() &#123; // å£°æ˜ Flutter Api lateinit var flutterApi: Pigeon.MyApi private class MyApi: Pigeon.Api &#123; override fun getPlatformVersion(result: Pigeon.Result&lt;String&gt;?) &#123; var version = \"Android $&#123;android.os.Build.VERSION.RELEASE&#125;\" result?.success(version) &#125; &#125;override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) // è°ƒç”¨ Flutter Api Timer().schedule(object: TimerTask() &#123; override fun run() &#123; // Platform Channel func å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œè¯¥æ–¹æ³• Handler(Looper.getMainLooper()).post &#123; // Call the desired channel message here. flutterApi.sessionInValid &#123; Log.d(\"Call func\", \"====Call flutter func!===\") &#125; &#125; &#125; &#125;, 1000) &#125; override fun configureFlutterEngine(flutterEngine: FlutterEngine) &#123; super.configureFlutterEngine(flutterEngine) // 2. setup() Pigeon.Api.setup(flutterEngine.dartExecutor.binaryMessenger, MyApi())// setup Flutter apiflutterApi = Pigeon.MyApi(flutterEngine.dartExecutor.binaryMessenger) &#125;&#125;Swiftåœ¨æ¡¥æ¥æ–‡ä»¶ ios/RunnerRunner-Bridging-Header.h æ·»åŠ  import è¯­å¥ï¼Œè®© Pigeon ç”Ÿæˆçš„ Objective-C æ–‡ä»¶å¯¹ Swift å¯è§1234&#x2F;&#x2F; ios &#x2F; Runner &#x2F; Runner-Bridging-Header.h#import &quot;Pigeon.h&quot;ç”±äº API åè®®å†™åœ¨ç”Ÿæˆçš„æ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå®ç°è¯¥åè®®çš„ç±» MyApiåˆ›å»º SwiftPigeonService.swift æ–‡ä»¶ å®ç°åè®®æ–¹æ³•1234567891011121314// SwiftPigeonService.swiftpublic class SwiftPigeonService: NSObject, FLTApi &#123; public func getPlatformVersion(completion: @escaping (String?, FlutterError?) -&gt; Void) &#123; let result = \"iOS \" + UIDevice.current.systemVersion completion(result, nil) &#125;&#125;åœ¨ AppDelegate ä¸­å®ä¾‹åŒ– API å¹¶å°†å…¶ä¼ é€’ç»™ setup æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142// AppDelegate.swift@UIApplicationMain@objc class AppDelegate: FlutterAppDelegate &#123; var _flutterApi: FLTMyApi? override func application( _ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]? ) -&gt; Bool &#123; let controller : FlutterViewController = window?.rootViewController as! FlutterViewController FLTApiSetup(controller.binaryMessenger, SwiftPigeonService()) GeneratedPluginRegistrant.register(with: self) _flutterApi = FLTMyApi(binaryMessenger: controller.binaryMessenger) // æ³¨æ„ï¼šæ–¹æ³•å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œ DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(500)) &#123; self._flutterApi?.sessionInValid(completion: &#123; (error) in print(\"===Native Call flutter func!===\") &#125;) &#125; return super.application(application, didFinishLaunchingWithOptions: launchOptions) &#125;&#125;Flutter è°ƒç”¨åŸç”Ÿæ–¹æ³•åœ¨éœ€è¦è°ƒç”¨åŸç”Ÿæ–¹æ³•å‡½æ•°çš„åœ°æ–¹å¯¼å…¥å¹¶ä½¿ç”¨ Pigeon ç”Ÿæˆçš„ dart æ–‡ä»¶1234567891011121314// home.dartFuture&lt;String?&gt; callNativePlatform() async &#123; // `Api` is a class generated by Pigeon final api = Api(); final res = await api.getPlatformVersion(); return res; &#125;åŸç”Ÿè°ƒç”¨ Flutter æ–¹æ³•Flutterå®ç° @FutterApi() ä¸­çš„åè®®æ–¹æ³•ï¼Œä¾› Native è°ƒç”¨1234567891011121314151617181920// api_flutter.dart// å®ç° Flutter ApiGenerated çš„æ¥å£class FTLApiManager extends MyApi &#123; @override Future&lt;void&gt; sessionInValid() async &#123; if (kDebugMode) &#123; print('====Call session invalid===='); &#125; &#125;&#125;123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// main.dartvoid main() async &#123; runApp(const MyApp());&#125;class MyApp extends StatefulWidget &#123; const MyApp(&#123;Key? key&#125;) : super(key: key); @override _MyAppState createState() =&gt; _MyAppState();&#125;class _MyAppState extends State&lt;MyApp&gt; &#123; @override void initState() &#123; super.initState(); // æ³¨å…¥ method channel MyApi.setup(FTLApiManager()); &#125; @override Widget build(BuildContext context) &#123; return MaterialApp( title: 'Flutter Demo', theme: ThemeData( primarySwatch: Colors.blue, ), home: const HomePage(), ); &#125;&#125;æ€»ç»“Pigeon è‡ªåŠ¨ç”Ÿæˆä½¿ç”¨ MethodChannel ç›¸å…³éƒ¨åˆ†å†…å®¹ã€‚ï¼ˆä¸¥æ ¼æ¥è¯´ï¼ŒPigeon ä½¿ç”¨çš„æ˜¯BasicMessageChannelï¼‰é¢„å®šä¹‰æ¨¡å¼å…è®¸ä¸ native è¿›è¡Œç±»å‹å®‰å…¨é€šä¿¡ç”Ÿæˆçš„ä»£ç æ˜¯ Java/Objective-Cï¼Œä½†æ˜¯ç”±äº Kotlin å¯ä»¥è°ƒç”¨ Javaï¼ŒSwift å¯ä»¥è°ƒç”¨ Objective-Cä¸å¿…äº†è§£ Dart ç«¯ä»£ç  ï¼ˆåªéœ€è°ƒç”¨è‡ªåŠ¨ç”Ÿæˆçš„ APIï¼‰ä¸å¿…äº†è§£åŸç”Ÿä»£ç  ï¼ˆåªéœ€å®ç°è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£ï¼‰å®é™…å®˜æ–¹æ’ä»¶ video_player å·²ç»åœ¨ä½¿ç”¨äº†Native è°ƒç”¨ Platform Channel Method å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œ","tags":[{"name":"Flutter","slug":"Flutter","permalink":"https://orangeschen.cn/tags/Flutter/"},{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Flutter æ¶æ„å±‚","date":"2023-02-04T03:57:10.000Z","path":"flutter/flutter-architecture-introduction.html","text":"Flutter é‡‡ç”¨äº†åˆ†å±‚è®¾è®¡æ¨¡å¼ï¼Œæ•´ä½“æ¶æ„åˆ†ä¸ºä¸‰å±‚ï¼šFrameworkï¼ˆæ¡†æ¶å±‚ï¼‰ã€Engineï¼ˆå¼•æ“ï¼‰ã€Embedderï¼ˆåµŒå…¥ï¼‰ã€‚Flutter è®¾è®¡ä¹‹åˆçš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªèƒ½å¤Ÿç›´æ¥å’Œç³»ç»Ÿåº•å±‚äº¤äº’çš„åŒæ—¶ï¼Œåˆå¯ä»¥åœ¨ä¸åŒå¹³å°é—´ä»£ç å°½å¯èƒ½å¤ç”¨çš„é«˜æ€§èƒ½ UI å·¥å…·é›†ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯è®©æ¶æ„çš„æ¯ä¸€ä¸ªç»„ä»¶éƒ½å˜å¾—å¯æ’æ‹”ã€å¯æ›¿æ¢ã€‚Embedder ï¼ˆåµŒå…¥å±‚ï¼‰ä¸º Engine åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼Œä½œç”¨æ˜¯æŠŠ Engine çš„ Task Runnersï¼ˆä»»åŠ¡è¿è¡Œå™¨ï¼‰è¿è¡Œåœ¨åµŒå…¥å±‚ç®¡ç†çš„çº¿ç¨‹ä¸Šã€‚å°† Flutter åµŒå…¥åˆ° Native å¹³å°ï¼Œä¾‹å¦‚ Androidã€iOSã€‚èŒè´£æ˜¯ä¸ºæ¸²æŸ“ UI åˆ° Surfaceã€å¤„ç†å•å‡»äº‹ä»¶ç­‰äºå¹³å°äº¤äº’çš„è¡Œä¸ºæä¾›ä¸€ä¸ªå…¥å£ï¼Œä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€å–å†³äºå…·ä½“å¹³å°ï¼Œå¯¹äº Android æ¥è¯´ï¼Œé€šå¸¸æ˜¯ C++ å’Œ Javaã€‚Engine ï¼ˆå¼•æ“å±‚ï¼‰Engine æ˜¯ Flutter çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”± C++ å®ç°ã€‚èŒè´£æ˜¯ä¸º Flutter åˆæˆå¹¶æ¸²æŸ“æ•°æ®ï¼Œæä¾›ä¸€ç³»åˆ—åº•å±‚åŸºç¡€èƒ½åŠ›ï¼ŒåŒ…æ‹¬å›¾å½¢ç»˜åˆ¶ï¼ˆSkiaï¼‰ã€æ–‡å­—æ¸²æŸ“ã€æ–‡ä»¶å’Œç½‘ç»œ I/Oã€å¹³å°æ’ä»¶ã€Dart è¿è¡Œæ—¶ç®¡ç†å’Œç¼–è¯‘å·¥å…·é“¾ç­‰ã€‚ä¸»è¦åŠŸèƒ½é€šè¿‡ dart:ui æ¨¡å—å’Œ Framework è¿›è¡ŒåŒå‘äº¤äº’ã€‚Framework ï¼ˆæ¡†æ¶å±‚ï¼‰é€šå¸¸æ¥è¯´å¼€å‘è€…å¹¶ä¸éœ€è¦æ„ŸçŸ¥åˆ° Engine å’Œ Embedder çš„å­˜åœ¨ï¼Œå¦‚æœä¸éœ€è¦è°ƒç”¨å¹³å°çš„ç³»ç»ŸæœåŠ¡ï¼ŒFramework æ˜¯å¼€å‘è€…éœ€è¦ç›´æ¥äº¤äº’çš„ï¼Œå› æ­¤æ˜¯æ•´ä¸ªåˆ†å±‚ç»“æ„çš„æœ€ä¸Šå±‚ã€‚Framewok æ˜¯ç”± Dart å¼€å‘ï¼Œæä¾›äº†ä¸€å¥—å“åº”å¼ UI æ¡†æ¶ï¼ŒFramework æœ¬èº«ä¹Ÿæ˜¯åˆ†å±‚çš„ï¼Œè‡ªåº•å‘ä¸Šè§’è‰²å¦‚ä¸‹ï¼šFoundationã€Animationã€Painting å’Œ Gesture æä¾›äº† Framework å…¬ç”¨çš„åº•å±‚èƒ½åŠ›ï¼Œæ˜¯å¯¹ Engine çš„æŠ½è±¡å’Œå°è£…ã€‚Rendering ä¸»è¦è´Ÿè´£ Render Tree çš„ Layout ç­‰æ“ä½œï¼Œå¹¶æœ€ç»ˆå°†ç»˜åˆ¶æŒ‡ä»¤å‘é€åˆ° Engine è¿›è¡Œç»˜åˆ¶ä¸Šå±æ“ä½œã€‚Widgets æ˜¯å¯¹ Rendering çš„å°è£…ï¼ŒRender Tree è™½ç„¶èƒ½å¤Ÿå†³å®šæœ€ç»ˆçš„ UIï¼Œä½†æ˜¯è¿‡äºå¤æ‚ï¼Œä¸é€‚åˆå¼€å‘è€…ä½¿ç”¨ï¼ŒWidgets é€šè¿‡ç»„åˆæ€æƒ³ï¼Œæä¾›äº†ä¸°å¯Œçš„ Widgets ç»„ä»¶ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚Material å’Œ Cupertino æ˜¯å¯¹ Widgets çš„è¿›ä¸€æ­¥å°è£…ï¼ŒWidgets æä¾›çš„ç»„ä»¶å¯¹äºå¼€å‘è€…æ¥è¯´è¿˜æ˜¯è¿‡äºåŸå§‹ï¼Œè¿™ä¸€å±‚åŸºäº Android å’Œ iOS çš„è®¾è®¡è§„èŒƒæä¾›äº†æ›´å®Œå¤‡çš„ç»„ä»¶ï¼Œä¿è¯å¼€å‘è€…èƒ½å¤Ÿå¼€ç®±å³ç”¨ã€‚ä¸ºä»€ä¹ˆé€‰æ‹©ä½¿ç”¨ Dart ï¼ŸDart è¿è¡Œåœ¨ Dart è™šæ‹Ÿæœºä¸Šï¼Œä½†ä¹Ÿå¯ä»¥ç¼–è¯‘ä¸ºç›´æ¥åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œçš„ ARM ä»£ç ã€‚Dart åŒæ—¶æ”¯æŒé¢„ç¼–è¯‘ï¼ˆAOTï¼‰å’Œè¿è¡Œæ—¶ç¼–è¯‘ï¼ˆJITï¼‰ä¸¤ç§ç¼–è¯‘æ–¹å¼ï¼Œæé«˜å¼€å‘å’Œæ‰§è¡Œç¨‹åºçš„æ•ˆç‡ã€‚Dart å¯ä»¥ä½¿ç”¨éš”ç¦»ï¼ˆisolateï¼‰å®ç°å¤šçº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å…±äº«å†…å­˜ï¼Œåˆ™å¯ä»¥å®ç°å¿«é€Ÿæ— é”åˆ†é…ã€‚Dart è™šæ‹Ÿæœºé‡‡ç”¨äº†åˆ†ä»£åƒåœ¾å›æ”¶æ–¹æ¡ˆï¼Œé€‚ç”¨äº UI æ¡†æ¶ä¸­äº§ç”Ÿå¤§é‡çš„ç»„ä»¶å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€‚å½“ä¸ºåˆ›å»ºçš„å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒDart ä½¿ç”¨æŒ‡é’ˆåœ¨ç°æœ‰çš„å †ä¸Šç§»åŠ¨ï¼Œå¯ä»¥ç¡®ä¿å†…å­˜çš„çº¿æ€§å¢é•¿ï¼Œä»è€ŒèŠ‚çœäº†æŸ¥æ‰¾å¯ç”¨å†…å­˜çš„æ—¶é—´ã€‚æ— éœ€å¼•å…¥ xmlã€jsx è¿™ç±»æ¨¡ç‰ˆæ–‡ä»¶å°†å¸ƒå±€å’Œé€»è¾‘ä»£ç åˆ†ç¦»ã€‚Flutter æ¸²æŸ“ç®¡é“Flutter 3 æ£µæ ‘æ¨¡å‹å¦‚å›¾æ‰€ç¤ºï¼šæ¯ä¸ª Widget éƒ½ä¼šæœ‰å¯¹åº”çš„ Elementï¼Œå¹¶å­˜åœ¨ä¸€æ£µå¯¹åº”çš„ Element Treeã€‚å®é™…ä¸Š Element Tree æ‰æ˜¯å†…å­˜ä¸­çœŸå®å­˜åœ¨çš„æ•°æ®ï¼ŒWidget Tree å’Œ Render Tree éƒ½æ˜¯ç”± Element Tree é©±åŠ¨ç”Ÿæˆçš„ã€‚æ­£æ˜¯ç”±äºè¿™ç§æœºåˆ¶ï¼ŒElement Tree æ‰®æ¼”äº† Flutter ä¸­ Virtual DOM çš„ç®¡ç†è€…è§’è‰²ã€‚å¯¹å¼€å‘è€…æ¥è¯´ Render Tree æ˜¯æœ€åº•å±‚çš„ UI æè¿°ï¼Œä½†å¯¹ Engine æ¥è¯´ï¼ŒRender Tree æ˜¯ Framework å¯¹ UI çš„æœ€ä¸Šå±‚ã€æœ€æŠ½è±¡çš„æè¿°ã€‚Element Tree å’Œ Widget Tree ç›¸å¯¹åº”ï¼Œç”±ä¸€ä¸ªä¸ªå…ƒç´ ç»„æˆï¼Œå¯ä»¥æŠŠå…ƒç´ ç†è§£ä¸ºå±•ç¤ºåœ¨å±å¹•ä¸ŠçœŸæ­£çš„ UI ç»„ä»¶ï¼Œå¼€å‘è€…åœ¨ä»£ç ä¸­åˆ›å»ºçš„ç»„ä»¶ä»…ä»…ä½œä¸º Flutter åˆ›å»ºå…ƒç´ çš„é…ç½®ä¿¡æ¯ï¼Œbuild æ–¹æ³•ä¹‹ååˆ›å»ºï¼Œç”Ÿæˆä¸€ä¸ªä¸ªä¸ç»„ä»¶å¯¹åº”çš„å…ƒç´ ç¤ºä¾‹ï¼Œç”Ÿæˆå…ƒç´ æ ‘ã€‚RenderObject è´Ÿè´£é¡µé¢ä¸­ç»„ä»¶çš„ç»˜åˆ¶å’Œå¸ƒå±€ï¼Œç»„æˆå¯¹åº”çš„ Render Treeï¼ˆæ¸²æŸ“æ ‘ï¼‰ã€‚å½“ Element æŒ‚è½½åˆ°å…ƒç´ æ ‘ä¸Šåï¼Œå°±ä¼šè°ƒç”¨ç»„ä»¶çš„ createRenderObject æ–¹æ³•ç”Ÿæˆå¯¹åº”çš„ RenderObject è¢«å…ƒç´ æ ‘å¼•ç”¨ï¼Œå› æ­¤ä¹Ÿå¸¸è¢«ç§°ä¸ºå…ƒç´ æ ‘çš„å­æ ‘ã€‚RenderObject æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ¯ç§ Element ä¼šæŒ‡å‘ä¸åŒçš„æ¸²æŸ“å¯¹è±¡ã€‚æ¸²æŸ“ç®¡é“ç”±äºé‡‡ç”¨äº†è‡ªæ¸²æŸ“çš„æ–¹å¼ï¼ŒFlutter çš„æ¸²æŸ“ç®¡é“æ˜¯ç‹¬ç«‹äºå¹³å°çš„ã€‚Flutter é€šè¿‡ Embedder è·å–äº†ä¸€ä¸ª Surface æˆ–è€… Texture ä½œä¸ºè‡ªå·±æ¸²æŸ“ç®¡é“çš„æœ€ç»ˆè¾“å‡ºç›®æ ‡ï¼Œæ¸²æŸ“ç®¡é“åˆ†ä¸ºä»¥ä¸‹7ä¸ªæ­¥éª¤ï¼šç”¨æˆ·è¾“å…¥å’ŒåŠ¨ç”»æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œä¸€äº›ç®€å•çš„é™æ€ UI ä¸éœ€è¦å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œä¹Ÿä¸éœ€è¦å±•ç¤ºåŠ¨ç”»ã€‚æ„å»ºã€å¸ƒå±€ã€ç»˜åˆ¶åˆ™ç›´æ¥å…³ç³»åˆ°ä¸‰æ£µæ ‘çš„ç»´æŠ¤å’Œä½¿ç”¨ï¼Œæ˜¯ Framework çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼ŒFlutter åº•å±‚å·¥ä½œæœºåˆ¶çš„å…³é”®ã€‚åˆæˆå’Œæ …æ ¼åŒ–è´Ÿè´£ç»˜åˆ¶æŒ‡ä»¤çš„æœ€ç»ˆæ¶ˆè´¹ï¼Œä¸»è¦é€»è¾‘åœ¨ Engine ä¸­ã€‚","tags":[{"name":"Flutter","slug":"Flutter","permalink":"https://orangeschen.cn/tags/Flutter/"},{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Flutter å†…æ ¸æºç è§£æä¸€Flutter å¯åŠ¨ç¯‡","date":"2022-11-02T06:45:22.000Z","path":"flutter/flutter-source-1.html","text":"Flutter engine æºç ç¼–è¯‘ï¼Œæ³¨æ„ Flutter Framework å¯¹åº”çš„ engine ç‰ˆæœ¬å’Œæºç çš„ engine ç‰ˆæœ¬è¦ä¿æŒä¸€è‡´ã€‚å‡è®¾ä½ å·²ç»æˆåŠŸç¼–è¯‘æºç ï¼Œä»¥ä¸‹ä¸º Flutter 3.0 å¯¹åº”çš„ç‰ˆæœ¬æºç ï¼Œè‹¥ä½ ä½¿ç”¨çš„æ˜¯å…¶ä»–ç‰ˆæœ¬çš„ï¼Œæºç å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›å·®å¼‚ã€‚Flutter æºç ç›®å½•ç»“æ„å¼€å§‹è¿™ç¯‡æ–‡ç« å‰ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®çš„æ˜¯ï¼ŒFramework æºç ä½äº flutter/flutter ä¸­ï¼Œé€šè¿‡ git clone git@github.com:flutter/flutter.git -b stableè·å–çš„ï¼Œå¼€å‘è¿‡ç¨‹ä¸­æ–­ç‚¹è°ƒè¯•çš„æºç æŒ‡çš„å°±æ˜¯è¿™ä¸ªé¡¹ç›®çš„ï¼Œåç»­ç›¸å…³è·¯å¾„ä»¥ flutter è¡¨ç¤ºè¯¥ç›®å½•ï¼›è€Œ Engine å’Œ Embedder çš„æºç ä½äºé€šè¿‡æºç ç¼–è¯‘è·å–åˆ°çš„æºç  flutter_source/src/flutter ç›®å½•ä¸­ï¼Œåç»­ç›¸å…³è·¯å¾„ä»¥ engine è¡¨ç¤ºè¯¥ç›®å½•ã€‚ä»¥ä¸‹ä¸º Framework æºç å®ç°ï¼Œå¼€å‘è€…æ¥è§¦åˆ°çš„ä»£ç å±‚ï¼Œflutter ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šflutter æºç ç»“æ„bin/internal æºç ç»“æ„flutter/packages æºç ç»“æ„å…¶ä¸­Flutter SDK æºç æŒ‡çš„æ˜¯ Dart å®ç°çš„ Framework å±‚çš„æºç ã€‚ä»¥ä¸‹åˆ™ä¸º depot_tools è·å–åˆ°çš„ engine ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº† Engine å’Œ Embedder å±‚çš„ç›¸å…³å®ç°ã€‚flutter/engine ç›®å½•ç»“æ„éœ€è¦å…ˆä½¿ç”¨ ./flutter/tools/gn ç”Ÿæˆæ„å»ºæ‰€éœ€çš„å…ƒæ–‡ä»¶ï¼Œå†ä½¿ç”¨ ninja æ„å»ºå‡ºæœ€ç»ˆçš„äº§ç‰©ï¼Œæ„å»ºå‡ºå¯¹åº”å¹³å°çš„æºç ã€‚./flutter/tools/gn å’Œ ninja å·¥å…·æ„å»ºä¸åŒå¹³å°çš„äº§ç‰©hot_debug_unopt çš„ä½œç”¨æ˜¯æ„å»º flutter å·¥ç¨‹ï¼Œç”Ÿæˆ Dart Kernel æˆ–è€…ç‰¹å®šå¹³å°çš„ AOT æ–‡ä»¶ï¼Œèƒ½åœ¨ x86 æ¶æ„çš„ PC è®¾å¤‡ä¸Šç”Ÿæˆ ARM æ¶æ„çš„æœºå™¨ç ï¼Œç”Ÿæˆæ„å»º Flutter Engine æ‰€éœ€çš„å…ƒæ–‡ä»¶ã€‚ios_debug_unopt/android_denug_unoptå­˜æ”¾æœ€ç»ˆæ„å»ºå‡ºçš„ Engine å’Œ Embedder äº§ç‰©ï¼Œé¡¹ç›®é‡Œé¢ compile_commands.json å­˜å‚¨äº† Engine ä¸­ä»£ç çš„äº¤å‰ç´¢å¼•ï¼Œåç»­æºç è°ƒè¯•éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ã€‚ios_debug_unopt æºç ç»“æ„ï¼Œengine æºç è°ƒè¯•çš„è·¯å¾„Flutter æºç è°ƒè¯•Framework æºç Framework æºç è°ƒè¯•å¾ˆç®€å•ï¼Œåœ¨ flutter é¡¹ç›®ä¸­ç›´æ¥è®¾ç½®æ–­ç‚¹å°±èƒ½è·³è½¬åˆ°å¯¹åº”çš„æºç æ–‡ä»¶åœ°å€æŸ¥çœ‹ã€‚Engine/Embedder æºç 1flutter run ios --local-engine=ios_debug_unopt --local-engine-src-path=/Volumes/TSB\\ 1/OpenCode/engine/srcè¿è¡ŒæˆåŠŸåï¼ŒiOS é¡¹ç›® Generated.xcconfig é…ç½® FLUTTER_ENGINEã€LOCAL_ENGINE æ›´æ–°ä¸º Flutter Engine æºç åœ°å€ï¼Œ å°† LOCAL_ENGINE æºç  flutter_engine.xcodeprojæ‹–åˆ°é¡¹ç›®ä¸­flutter_engine.xcodeproj é¡¹ç›®é‡Œè®¾ç½®æ–­ç‚¹ï¼Œè¿è¡Œä»£ç ï¼Œåˆ™å¯å¼€å§‹è°ƒè¯• Engine/Embedder æºç Flutter å¯åŠ¨æµç¨‹Embedder æ˜¯ Flutter æ¥å…¥åŸç”Ÿå¹³å°çš„å…³é”®ï¼Œä½äºæ•´ä¸ª Flutter æ¶æ„åº•å±‚ï¼Œè´Ÿè´£ Engine çš„åˆ›å»ºã€ç®¡ç†ä¸é”€æ¯ï¼ŒåŒæ—¶ä¹Ÿä¸º Engine æä¾›ç»˜åˆ¶ UI æ¥å£ã€‚åœ¨ Embedder ä¸­ï¼ŒiOS ç«¯çš„ FlutterViewController å’Œ Android ç«¯çš„ FlutterActivityã€FlutterFragment æ˜¯å¼€å‘è€…æœ€å¸¸æ¥è§¦çš„ç±»ã€‚FlutterViewController æºç è§£æFlutterViewController ä¸­æŒæœ‰ä¸¤ä¸ªå…³é”®çš„å¯¹è±¡ FlutterView å’Œ FlutterEngineï¼ŒFlutterEngine è´Ÿè´£ Engine åœ¨ Embedder ä¸­çš„è°ƒç”¨å’Œç®¡ç†ï¼ŒFlutterView åˆ™è´Ÿè´£ Engine ä¸­ UI æ•°æ®çš„ä¸Šå±æ˜¾ç¤ºã€‚1234567891011121314151617181920212223242526272829303132@implementation FlutterViewController &#123; std::unique_ptr&lt;fml::WeakPtrFactory&lt;FlutterViewController&gt;&gt; _weakFactory; // flutterEngine fml::scoped_nsobject&lt;FlutterEngine&gt; _engine; // We keep a separate reference to this and create it ahead of time because we want to be able to // set up a shell along with its platform view before the view has to appear. // flutterView fml::scoped_nsobject&lt;FlutterView&gt; _flutterView; // é—ªå± fml::scoped_nsobject&lt;UIView&gt; _splashScreenView; // flutterView æ¸²æŸ“å›è°ƒ fml::ScopedBlock&lt;void (^)(void)&gt; _flutterViewRenderedCallback; // è®¾å¤‡æ–¹å‘ UIInterfaceOrientationMask _orientationPreferences; // è®¾å¤‡ statusBar æ ·å¼ UIStatusBarStyle _statusBarStyle; flutter::ViewportMetrics _viewportMetrics; BOOL _initialized; BOOL _viewOpaque; BOOL _engineNeedsLaunch; fml::scoped_nsobject&lt;NSMutableSet&lt;NSNumber*&gt;&gt; _ongoingTouches; // This scroll view is a workaround to accommodate iOS 13 and higher. There isn't a way to get // touches on the status bar to trigger scrolling to the top of a scroll view. We place a // UIScrollView with height zero and a content offset so we can get those events. See also: // https://github.com/flutter/flutter/issues/35050 fml::scoped_nsobject&lt;UIScrollView&gt; _scrollView; fml::scoped_nsobject&lt;UIHoverGestureRecognizer&gt; _hoverGestureRecognizer API_AVAILABLE(ios(13.4)); fml::scoped_nsobject&lt;UIPanGestureRecognizer&gt; _panGestureRecognizer API_AVAILABLE(ios(13.4)); fml::scoped_nsobject&lt;UIView&gt; _keyboardAnimationView; MouseState _mouseState;&#125;FlutterViewController å®ç° FlutterViewResponder åè®®ï¼Œå¤„ç†è§¦æ‘¸äº‹ä»¶1234567891011@protocol FlutterViewResponder &lt;NSObject&gt;@property(nonatomic, strong) UIView* view;- (void)touchesBegan:(NSSet*)touches withEvent:(UIEvent*)event;- (void)touchesMoved:(NSSet*)touches withEvent:(UIEvent*)event;- (void)touchesEnded:(NSSet*)touches withEvent:(UIEvent*)event;- (void)touchesCancelled:(NSSet*)touches withEvent:(UIEvent*)event;- (void)touchesEstimatedPropertiesUpdated:(NSSet*)touches;@endå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ–¹å¼æœ‰ä¸¤ç§ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä»¥ä¸‹è¿™ä¸ªæ„é€ æ–¹æ³•æ˜¯ä¸ºäº†åœ¨å­˜åœ¨å¤šä¸ª FlutterViewController çš„æƒ…å†µä¸‹å¤ç”¨ FlutterEngine å¯¹è±¡ã€‚12345678910111213141516171819202122232425262728293031323334- (instancetype)initWithEngine:(FlutterEngine*)engine nibName:(nullable NSString*)nibName bundle:(nullable NSBundle*)nibBundle &#123; NSAssert(engine != nil, @\"Engine is required\"); self = [super initWithNibName:nibName bundle:nibBundle]; if (self) &#123; _viewOpaque = YES; if (engine.viewController) &#123; FML_LOG(ERROR) &lt;&lt; \"The supplied FlutterEngine \" &lt;&lt; [[engine description] UTF8String] &lt;&lt; \" is already used with FlutterViewController instance \" &lt;&lt; [[engine.viewController description] UTF8String] &lt;&lt; \". One instance of the FlutterEngine can only be attached to one \" \"FlutterViewController at a time. Set FlutterEngine.viewController \" \"to nil before attaching it to another FlutterViewController.\"; &#125; // åˆå§‹åŒ–æˆ–è€…æ›¿æ¢å½“å‰çš„ FlutterEngine _engine.reset([engine retain]); _engineNeedsLaunch = NO; // åˆå§‹åŒ–æˆ–è€…æ›¿æ¢å½“å‰çš„ FlutterView _flutterView.reset([[FlutterView alloc] initWithDelegate:_engine opaque:self.isViewOpaque]); _weakFactory = std::make_unique&lt;fml::WeakPtrFactory&lt;FlutterViewController&gt;&gt;(self); // åˆå§‹åŒ–æ­£åœ¨å‘ç”Ÿçš„æ‰‹åŠ¿é›†åˆ _ongoingTouches.reset([[NSMutableSet alloc] init]); /** 1. è®¾ç½® UIInterfaceOrientationMask å’Œ UIStatusBarStyle 2. æ·»åŠ ä¸€äº›åˆ—é€šçŸ¥ Application ç”Ÿå‘½å‘¨æœŸã€é”®ç›˜äº‹ä»¶ã€Accessibility çš„äº‹ä»¶ç­‰ */ [self performCommonViewControllerInitialization]; // å°† FlutterViewController è®¾ç½®ç»™ FlutterEngine [engine setViewController:self]; &#125; return self;&#125;ViewController åˆå§‹åŒ–è®¾ç½®ï¼Œæ·»åŠ é€šçŸ¥æ¶ˆæ¯è®¢é˜…è¿™ä¸‰ä¸ªæ¥å£å…è®¸æˆ‘ä»¬å¯¹ Dart çš„ Navigator ç›´æ¥è¿›è¡Œæ“ä½œï¼Œé€šè¿‡ Platform Channel å®ç°1234567891011- (void)setInitialRoute:(NSString*)route &#123; [[_engine.get() navigationChannel] invokeMethod:@\"setInitialRoute\" arguments:route];&#125;- (void)popRoute &#123; [[_engine.get() navigationChannel] invokeMethod:@\"popRoute\" arguments:nil];&#125;- (void)pushRoute:(NSString*)route &#123; [[_engine.get() navigationChannel] invokeMethod:@\"pushRoute\" arguments:route];&#125;åŠ è½½ view123456789101112131415161718192021- (void)loadView &#123; // åˆå§‹åŒ–å¹¶åˆ›å»º viewï¼Œå­˜åœ¨è¿”å›ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º self.view = GetViewOrPlaceholder(_flutterView.get()); self.view.multipleTouchEnabled = YES; self.view.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight; // åŠ è½½é—ªå±é¡µé¢ å†…éƒ¨ä¼šä¼šåˆ¤æ–­æ˜¯å¦åŠ è½½é—ªå±é¡µ [self installSplashScreenViewIfNecessary]; // åˆå§‹åŒ– scrollView UIScrollView* scrollView = [[UIScrollView alloc] init]; scrollView.autoresizingMask = UIViewAutoresizingFlexibleWidth; // The color shouldn't matter since it is offscreen. scrollView.backgroundColor = UIColor.whiteColor; scrollView.delegate = self; // This is an arbitrary small size. // è®¾ç½®ä»»æ„çš„å°å°ºå¯¸ static constexpr CGFloat kScrollViewContentSize = 2.0; scrollView.contentSize = CGSizeMake(kScrollViewContentSize, kScrollViewContentSize); // This is an arbitrary offset that is not CGPointZero. scrollView.contentOffset = CGPointMake(kScrollViewContentSize, kScrollViewContentSize); [self.view addSubview:scrollView]; _scrollView.reset(scrollView);&#125;12345678910111213141516171819- (void)installSplashScreenViewIfNecessary &#123; // Show the launch screen view again on top of the FlutterView if available. // This launch screen view will be removed once the first Flutter frame is rendered. // å½“é¦–å¸§ Flutter View æ¸²æŸ“æˆåŠŸåï¼Œåˆ™å°†é—ªå±é¡µé¢ç§»é™¤ if (_splashScreenView &amp;&amp; (self.isBeingPresented || self.isMovingToParentViewController)) &#123; [_splashScreenView.get() removeFromSuperview]; _splashScreenView.reset(); return; &#125; // Use the property getter to initialize the default value. UIView* splashScreenView = self.splashScreenView; if (splashScreenView == nil) &#123; return; &#125; splashScreenView.frame = self.view.bounds; // åŠ è½½é—ªå±é¡µ [self.view addSubview:splashScreenView];&#125;SplashScreenView é—ªå±è·å–ï¼Œå±æ€§ getter æ–¹æ³•å®ç°ï¼Œå®ç°æ¯”è¾ƒç®€å•ï¼Œæºç å°±ä¸æ˜¾ç¤ºå‡ºæ¥äº†Surface åˆ›å»ºå’Œé”€æ¯12345678910111213141516171819202122232425#pragma mark - Surface creation and teardown updates- (void)surfaceUpdated:(BOOL)appeared &#123; if (!_engine) &#123; return; &#125; // NotifyCreated/NotifyDestroyed are synchronous and require hops between the UI and raster // thread. // NotifyCreated/NotifyDestroyed æ˜¯åŒæ­¥çš„ï¼Œéœ€è¦åœ¨ UI å’Œ raster çº¿ç¨‹åˆ‡æ¢ if (appeared) &#123; // surface åˆ›å»º [self installFirstFrameCallback]; [_engine.get() platformViewsController]-&gt;SetFlutterView(_flutterView.get()); [_engine.get() platformViewsController]-&gt;SetFlutterViewController(self); [_engine.get() iosPlatformView]-&gt;NotifyCreated(); &#125; else &#123; // surface é”€æ¯ self.displayingFlutterUI = NO; [_engine.get() iosPlatformView]-&gt;NotifyDestroyed(); [_engine.get() platformViewsController]-&gt;SetFlutterView(nullptr); [_engine.get() platformViewsController]-&gt;SetFlutterViewController(nullptr); &#125;&#125;UIViewControllerã€UIApplication ç”Ÿå‘½å‘¨æœŸç›‘å¬åŸç”Ÿç”Ÿå‘½å‘¨æœŸå’Œ Flutter ä¸­ AppLifecycleState çš„å¯¹åº”å…³ç³»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748- (void)viewDidDisappear:(BOOL)animated &#123; TRACE_EVENT0(\"flutter\", \"viewDidDisappear\"); if ([_engine.get() viewController] == self) &#123; // åœæ­¢ vsync åˆ·æ–° [self invalidateDisplayLink]; // // ç¡®ä¿ `physical_view_inset_bottom` æ˜¯ç›®æ ‡å€¼ã€‚ [self ensureViewportMetricsIsCorrect]; // åœæ­¢ surface æ›´æ–° [self surfaceUpdated:NO]; [[_engine.get() lifecycleChannel] sendMessage:@\"AppLifecycleState.paused\"]; // ç§»é™¤æ­£åœ¨æ‰§è¡Œçš„æ‰‹åŠ¿äº‹ä»¶ [self flushOngoingTouches]; [_engine.get() notifyLowMemory]; &#125; [super viewDidDisappear:animated];&#125;- (void)flushOngoingTouches &#123; // è·å–æ­£åœ¨æ‰§è¡Œçš„æ‰€æœ‰æ‰‹åŠ¿äº‹ä»¶ åˆ›å»ºå‡çš„ PointerData åŒ…è£…æˆ packet ç»“æ„ä½“ if (_engine &amp;&amp; _ongoingTouches.get().count &gt; 0) &#123; auto packet = std::make_unique&lt;flutter::PointerDataPacket&gt;(_ongoingTouches.get().count); size_t pointer_index = 0; // If the view controller is going away, we want to flush cancel all the ongoing // touches to the framework so nothing gets orphaned. for (NSNumber* device in _ongoingTouches.get()) &#123; // Create fake PointerData to balance out each previously started one for the framework. flutter::PointerData pointer_data = [self generatePointerDataForFake]; // æ“ä½œç±»å‹ä¸ºå–æ¶ˆ pointer_data.change = flutter::PointerData::Change::kCancel; pointer_data.device = device.longLongValue; pointer_data.pointer_identifier = 0; // Anything we put here will be arbitrary since there are no touches. pointer_data.physical_x = 0; pointer_data.physical_y = 0; pointer_data.physical_delta_x = 0.0; pointer_data.physical_delta_y = 0.0; pointer_data.pressure = 1.0; pointer_data.pressure_max = 1.0; packet-&gt;SetPointerData(pointer_index++, pointer_data); &#125; [_ongoingTouches removeAllObjects]; [_engine.get() dispatchPointerDataPacket:std::move(packet)]; &#125;&#125;æ‰‹åŠ¿äº‹ä»¶å¤„ç†æ ¸å¿ƒä»£ç ä¸º dispatchTouchesæ–¹æ³•ï¼Œå°† Touches åˆ†å‘ç»™ Engine123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129// Dispatches the UITouches to the engine. Usually, the type of change of the touch is determined// from the UITouch's phase. However, FlutterAppDelegate fakes touches to ensure that touch events// in the status bar area are available to framework code. The change type (optional) of the faked// touch is specified in the second argument./// å°† Touches åˆ†é…ç»™å¼•æ“- (void)dispatchTouches:(NSSet*)touches pointerDataChangeOverride:(flutter::PointerData::Change*)overridden_change event:(UIEvent*)event &#123; if (!_engine) &#123; return; &#125; const CGFloat scale = [UIScreen mainScreen].scale; auto packet = std::make_unique&lt;flutter::PointerDataPacket&gt;(touches.count); size_t pointer_index = 0; for (UITouch* touch in touches) &#123; CGPoint windowCoordinates = [touch locationInView:self.view]; flutter::PointerData pointer_data; pointer_data.Clear(); constexpr int kMicrosecondsPerSecond = 1000 * 1000; pointer_data.time_stamp = touch.timestamp * kMicrosecondsPerSecond; pointer_data.change = overridden_change != nullptr ? *overridden_change : PointerDataChangeFromUITouchPhase(touch.phase); pointer_data.kind = DeviceKindFromTouchType(touch); pointer_data.device = reinterpret_cast&lt;int64_t&gt;(touch); // Pointer will be generated in pointer_data_packet_converter.cc. pointer_data.pointer_identifier = 0; pointer_data.physical_x = windowCoordinates.x * scale; pointer_data.physical_y = windowCoordinates.y * scale; // Delta will be generated in pointer_data_packet_converter.cc. pointer_data.physical_delta_x = 0.0; pointer_data.physical_delta_y = 0.0; NSNumber* deviceKey = [NSNumber numberWithLongLong:pointer_data.device]; // Track touches that began and not yet stopped so we can flush them // if the view controller goes away. // åªå¤„ç† tracking starts å’Œ stops äº‹ä»¶ switch (pointer_data.change) &#123; case flutter::PointerData::Change::kDown: [_ongoingTouches addObject:deviceKey]; break; case flutter::PointerData::Change::kCancel: case flutter::PointerData::Change::kUp: [_ongoingTouches removeObject:deviceKey]; break; case flutter::PointerData::Change::kHover: case flutter::PointerData::Change::kMove: // We're only tracking starts and stops. break; case flutter::PointerData::Change::kAdd: case flutter::PointerData::Change::kRemove: // We don't use kAdd/kRemove. break; case flutter::PointerData::Change::kPanZoomStart: case flutter::PointerData::Change::kPanZoomUpdate: case flutter::PointerData::Change::kPanZoomEnd: // We don't send pan/zoom events here break; &#125; // pressure_min is always 0.0 if (@available(iOS 9, *)) &#123; // These properties were introduced in iOS 9.0. pointer_data.pressure = touch.force; pointer_data.pressure_max = touch.maximumPossibleForce; &#125; else &#123; pointer_data.pressure = 1.0; pointer_data.pressure_max = 1.0; &#125; // These properties were introduced in iOS 8.0 pointer_data.radius_major = touch.majorRadius; pointer_data.radius_min = touch.majorRadius - touch.majorRadiusTolerance; pointer_data.radius_max = touch.majorRadius + touch.majorRadiusTolerance; // These properties were introduced in iOS 9.1 if (@available(iOS 9.1, *)) &#123; pointer_data.tilt = M_PI_2 - touch.altitudeAngle; pointer_data.orientation = [touch azimuthAngleInView:nil] - M_PI_2; &#125; if (@available(iOS 13.4, *)) &#123; if (event != nullptr) &#123; pointer_data.buttons = (((event.buttonMask &amp; UIEventButtonMaskPrimary) &gt; 0) ? flutter::PointerButtonMouse::kPointerButtonMousePrimary : 0) | (((event.buttonMask &amp; UIEventButtonMaskSecondary) &gt; 0) ? flutter::PointerButtonMouse::kPointerButtonMouseSecondary : 0); &#125; &#125; packet-&gt;SetPointerData(pointer_index++, pointer_data); &#125; [_engine.get() dispatchPointerDataPacket:std::move(packet)];&#125;- (void)touchesBegan:(NSSet*)touches withEvent:(UIEvent*)event &#123; [self dispatchTouches:touches pointerDataChangeOverride:nullptr event:event];&#125;- (void)touchesMoved:(NSSet*)touches withEvent:(UIEvent*)event &#123; [self dispatchTouches:touches pointerDataChangeOverride:nullptr event:event];&#125;- (void)touchesEnded:(NSSet*)touches withEvent:(UIEvent*)event &#123; [self dispatchTouches:touches pointerDataChangeOverride:nullptr event:event];&#125;- (void)touchesCancelled:(NSSet*)touches withEvent:(UIEvent*)event &#123; [self dispatchTouches:touches pointerDataChangeOverride:nullptr event:event];&#125;- (void)forceTouchesCancelled:(NSSet*)touches &#123; flutter::PointerData::Change cancel = flutter::PointerData::Change::kCancel; [self dispatchTouches:touches pointerDataChangeOverride:&amp;cancel event:nullptr];&#125;é”®ç›˜äº‹ä»¶å¤„ç†ï¼Œè¿™å—å†…å®¹ä¸»è¦æ˜¯é”®ç›˜æ˜¾ç¤ºåŠ¨ç”»PlatformViewsã€FlutterBinaryMessengerã€FlutterTextureRegistryã€FlutterPluginRegistry å…·ä½“å®ç°åœ¨ FlutterEngine ç±»ä¸­ï¼Œåé¢ä¼šå¯¹ FlutterEngine æºç è¿›è¡Œè§£æã€‚FlutterEngine æºç åˆ†æFlutterEngine åœ¨ FlutterViewController ä¸­åˆå§‹åŒ–å®Œæˆç›¸å…³æˆå‘˜å˜é‡çš„é…ç½®ã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455@interface FlutterEngineRegistrar : NSObject &lt;FlutterPluginRegistrar&gt;@property(nonatomic, assign) FlutterEngine* flutterEngine;- (instancetype)initWithPlugin:(NSString*)pluginKey flutterEngine:(FlutterEngine*)flutterEngine;@end@interface FlutterEngine () &lt;FlutterIndirectScribbleDelegate, FlutterTextInputDelegate, FlutterBinaryMessenger&gt;// Maintains a dictionary of plugin names that have registered with the engine. Used by// FlutterEngineRegistrar to implement a FlutterPluginRegistrar.@property(nonatomic, readonly) NSMutableDictionary* pluginPublications;@property(nonatomic, readonly) NSMutableDictionary&lt;NSString*, FlutterEngineRegistrar*&gt;* registrars;@property(nonatomic, readwrite, copy) NSString* isolateId;@property(nonatomic, copy) NSString* initialRoute;@property(nonatomic, retain) id&lt;NSObject&gt; flutterViewControllerWillDeallocObserver;@end@implementation FlutterEngine &#123; fml::scoped_nsobject&lt;FlutterDartProject&gt; _dartProject; std::shared_ptr&lt;flutter::ThreadHost&gt; _threadHost; std::unique_ptr&lt;flutter::Shell&gt; _shell; NSString* _labelPrefix; std::unique_ptr&lt;fml::WeakPtrFactory&lt;FlutterEngine&gt;&gt; _weakFactory; fml::WeakPtr&lt;FlutterViewController&gt; _viewController; fml::scoped_nsobject&lt;FlutterObservatoryPublisher&gt; _publisher; std::shared_ptr&lt;flutter::FlutterPlatformViewsController&gt; _platformViewsController; flutter::IOSRenderingAPI _renderingApi; std::shared_ptr&lt;flutter::ProfilerMetricsIOS&gt; _profiler_metrics; std::shared_ptr&lt;flutter::SamplingProfiler&gt; _profiler; // Channels å†…ç½® Channels fml::scoped_nsobject&lt;FlutterPlatformPlugin&gt; _platformPlugin; fml::scoped_nsobject&lt;FlutterTextInputPlugin&gt; _textInputPlugin; fml::scoped_nsobject&lt;FlutterRestorationPlugin&gt; _restorationPlugin; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _localizationChannel; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _navigationChannel; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _restorationChannel; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _platformChannel; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _platformViewsChannel; fml::scoped_nsobject&lt;FlutterMethodChannel&gt; _textInputChannel; fml::scoped_nsobject&lt;FlutterBasicMessageChannel&gt; _lifecycleChannel; fml::scoped_nsobject&lt;FlutterBasicMessageChannel&gt; _systemChannel; fml::scoped_nsobject&lt;FlutterBasicMessageChannel&gt; _settingsChannel; fml::scoped_nsobject&lt;FlutterBasicMessageChannel&gt; _keyEventChannel; int64_t _nextTextureId; BOOL _allowHeadlessExecution; BOOL _restorationEnabled; FlutterBinaryMessengerRelay* _binaryMessenger; std::unique_ptr&lt;flutter::ConnectionCollection&gt; _connections;&#125;FlutterEngine å¯åŠ¨ï¼Œä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼šcreateShelllaunchEngine12345678910- (BOOL)runWithEntrypoint:(NSString*)entrypoint libraryURI:(NSString*)libraryURI initialRoute:(NSString*)initialRoute entrypointArgs:(NSArray&lt;NSString*&gt;*)entrypointArgs &#123; if ([self createShell:entrypoint libraryURI:libraryURI initialRoute:initialRoute]) &#123; [self launchEngine:entrypoint libraryURI:libraryURI entrypointArgs:entrypointArgs]; &#125; return _shell != nullptr;&#125;123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475- (BOOL)createShell:(NSString*)entrypoint libraryURI:(NSString*)libraryURI initialRoute:(NSString*)initialRoute &#123; if (_shell != nullptr) &#123; FML_LOG(WARNING) &lt;&lt; \"This FlutterEngine was already invoked.\"; return NO; &#125; // è®¾ç½®åˆå§‹åŒ–è·¯ç”± self.initialRoute = initialRoute; auto settings = [_dartProject.get() settings]; if (initialRoute != nil) &#123; self.initialRoute = initialRoute; &#125; else if (settings.route.empty() == false) &#123; self.initialRoute = [NSString stringWithCString:settings.route.c_str() encoding:NSUTF8StringEncoding]; &#125; FlutterView.forceSoftwareRendering = settings.enable_software_rendering; auto platformData = [_dartProject.get() defaultPlatformData]; SetEntryPoint(&amp;settings, entrypoint, libraryURI); // åˆå§‹åŒ– _threadHost NSString* threadLabel = [FlutterEngine generateThreadLabel:_labelPrefix]; _threadHost = std::make_shared&lt;flutter::ThreadHost&gt;(); *_threadHost = [FlutterEngine makeThreadHost:threadLabel]; // Lambda captures by pointers to ObjC objects are fine here because the // create call is synchronous. // è®¾ç½® on_create_platform_view å›è°ƒ flutter::Shell::CreateCallback&lt;flutter::PlatformView&gt; on_create_platform_view = [self](flutter::Shell&amp; shell) &#123; [self recreatePlatformViewController]; return std::make_unique&lt;flutter::PlatformViewIOS&gt;( shell, self-&gt;_renderingApi, self-&gt;_platformViewsController, shell.GetTaskRunners()); &#125;; // è®¾ç½® on_create_rasterizer å›è°ƒ flutter::Shell::CreateCallback&lt;flutter::Rasterizer&gt; on_create_rasterizer = [](flutter::Shell&amp; shell) &#123; return std::make_unique&lt;flutter::Rasterizer&gt;(shell); &#125;; // åˆå§‹åŒ– TaskRunners // engine å¯åŠ¨äº†å››ä¸ª task runner platformã€rasterã€uiã€ioï¼Œä½†å¹¶ä¸ä¸€å®šå¯¹åº”å››ä¸ªçº¿ç¨‹ flutter::TaskRunners task_runners(threadLabel.UTF8String, // label fml::MessageLoop::GetCurrent().GetTaskRunner(), // platform _threadHost-&gt;raster_thread-&gt;GetTaskRunner(), // raster _threadHost-&gt;ui_thread-&gt;GetTaskRunner(), // ui _threadHost-&gt;io_thread-&gt;GetTaskRunner() // io ); _isGpuDisabled = [UIApplication sharedApplication].applicationState == UIApplicationStateBackground; // Create the shell. This is a blocking operation. // åˆ›å»º shell std::unique_ptr&lt;flutter::Shell&gt; shell = flutter::Shell::Create( /*platform_data=*/std::move(platformData), /*task_runners=*/std::move(task_runners), /*settings=*/std::move(settings), /*on_create_platform_view=*/on_create_platform_view, /*on_create_rasterizer=*/on_create_rasterizer, /*is_gpu_disabled=*/_isGpuDisabled); if (shell == nullptr) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not start a shell FlutterEngine with entrypoint: \" &lt;&lt; entrypoint.UTF8String; &#125; else &#123; // å¯åŠ¨ isolate [self setupShell:std::move(shell) withObservatoryPublication:settings.enable_observatory_publication]; if ([FlutterEngine isProfilerEnabled]) &#123; [self startProfiler]; &#125; &#125; return _shell != nullptr;&#125;å¯åŠ¨ Engineï¼Œä»£ç å®ç°è°ƒç”¨ shell çš„ RunEngine æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637383940414243444546- (void)launchEngine:(NSString*)entrypoint libraryURI:(NSString*)libraryOrNil entrypointArgs:(NSArray&lt;NSString*&gt;*)entrypointArgs &#123; // Launch the Dart application with the inferred run configuration. self.shell.RunEngine([_dartProject.get() runConfigurationForEntrypoint:entrypoint libraryOrNil:libraryOrNil entrypointArgs:entrypointArgs]);&#125;void Shell::RunEngine(RunConfiguration run_configuration) &#123; RunEngine(std::move(run_configuration), nullptr);&#125;void Shell::RunEngine( RunConfiguration run_configuration, const std::function&lt;void(Engine::RunStatus)&gt;&amp; result_callback) &#123; auto result = [platform_runner = task_runners_.GetPlatformTaskRunner(), result_callback](Engine::RunStatus run_result) &#123; if (!result_callback) &#123; return; &#125; platform_runner-&gt;PostTask( [result_callback, run_result]() &#123; result_callback(run_result); &#125;); &#125;; FML_DCHECK(is_setup_); FML_DCHECK(task_runners_.GetPlatformTaskRunner()-&gt;RunsTasksOnCurrentThread()); fml::TaskRunner::RunNowOrPostTask( task_runners_.GetUITaskRunner(), fml::MakeCopyable( [run_configuration = std::move(run_configuration), weak_engine = weak_engine_, result]() mutable &#123; if (!weak_engine) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not launch engine with configuration - no engine.\"; result(Engine::RunStatus::Failure); return; &#125; // å¯åŠ¨ engine auto run_result = weak_engine-&gt;Run(std::move(run_configuration)); if (run_result == flutter::Engine::RunStatus::Failure) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not launch engine with configuration.\"; &#125; result(run_result); &#125;));&#125;æ ¸å¿ƒå®ç°ä¸º engine.cc é‡Œçš„ weak_engine-&gt;Run(std::move(run_configuration))ï¼Œæœ€ç»ˆå¯åŠ¨ isolateã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849Engine::RunStatus Engine::Run(RunConfiguration configuration) &#123; if (!configuration.IsValid()) &#123; FML_LOG(ERROR) &lt;&lt; \"Engine run configuration was invalid.\"; return RunStatus::Failure; &#125; last_entry_point_ = configuration.GetEntrypoint(); last_entry_point_library_ = configuration.GetEntrypointLibrary();#if (FLUTTER_RUNTIME_MODE == FLUTTER_RUNTIME_MODE_DEBUG) // This is only used to support restart. last_entry_point_args_ = configuration.GetEntrypointArgs();#endif UpdateAssetManager(configuration.GetAssetManager()); if (runtime_controller_-&gt;IsRootIsolateRunning()) &#123; return RunStatus::FailureAlreadyRunning; &#125; // If the embedding prefetched the default font manager, then set up the // font manager later in the engine launch process. This makes it less // likely that the setup will need to wait for the prefetch to complete. auto root_isolate_create_callback = [&amp;]() &#123; if (settings_.prefetched_default_font_manager) &#123; SetupDefaultFontManager(); &#125; &#125;; // å¯åŠ¨ root isolate if (!runtime_controller_-&gt;LaunchRootIsolate( settings_, // root_isolate_create_callback, // configuration.GetEntrypoint(), // configuration.GetEntrypointLibrary(), // configuration.GetEntrypointArgs(), // configuration.TakeIsolateConfiguration()) // ) &#123; return RunStatus::Failure; &#125; // è·å– isolate id auto service_id = runtime_controller_-&gt;GetRootIsolateServiceID(); if (service_id.has_value()) &#123; std::unique_ptr&lt;PlatformMessage&gt; service_id_message = std::make_unique&lt;flutter::PlatformMessage&gt;( kIsolateChannel, MakeMapping(service_id.value()), nullptr); HandlePlatformMessage(std::move(service_id_message)); &#125; return Engine::RunStatus::Success;&#125;è°ƒç”¨ runtime_controller``LaunchRootIsolate æ–¹æ³• CreateRunningRootIsolate åˆ›å»ºå¹¶å¯åŠ¨ isolate1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859bool RuntimeController::LaunchRootIsolate( const Settings&amp; settings, fml::closure root_isolate_create_callback, std::optional&lt;std::string&gt; dart_entrypoint, std::optional&lt;std::string&gt; dart_entrypoint_library, const std::vector&lt;std::string&gt;&amp; dart_entrypoint_args, std::unique_ptr&lt;IsolateConfiguration&gt; isolate_configuration) &#123; if (root_isolate_.lock()) &#123; FML_LOG(ERROR) &lt;&lt; \"Root isolate was already running.\"; return false; &#125; auto strong_root_isolate = DartIsolate::CreateRunningRootIsolate( settings, // isolate_snapshot_, // std::make_unique&lt;PlatformConfiguration&gt;(this), // DartIsolate::Flags&#123;&#125;, // root_isolate_create_callback, // isolate_create_callback_, // isolate_shutdown_callback_, // dart_entrypoint, // dart_entrypoint_library, // dart_entrypoint_args, // std::move(isolate_configuration), // context_, // spawning_isolate_.lock().get()) // .lock(); if (!strong_root_isolate) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not create root isolate.\"; return false; &#125; // The root isolate ivar is weak. root_isolate_ = strong_root_isolate; // Capture by `this` here is safe because the callback is made by the dart // state itself. The isolate (and its Dart state) is owned by this object and // it will be collected before this object. strong_root_isolate-&gt;SetReturnCodeCallback( [this](uint32_t code) &#123; root_isolate_return_code_ = code; &#125;); if (auto* platform_configuration = GetPlatformConfigurationIfAvailable()) &#123; tonic::DartState::Scope scope(strong_root_isolate); platform_configuration-&gt;DidCreateIsolate(); if (!FlushRuntimeStateToIsolate()) &#123; FML_DLOG(ERROR) &lt;&lt; \"Could not set up initial isolate state.\"; &#125; &#125; else &#123; FML_DCHECK(false) &lt;&lt; \"RuntimeController created without window binding.\"; &#125; FML_DCHECK(Dart_CurrentIsolate() == nullptr); client_.OnRootIsolateCreated(); return true;&#125;åˆ›å»ºå¹¶å¯åŠ¨ isolateCreateRootIsolateRunFromLibrary123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255std::weak_ptr&lt;DartIsolate&gt; DartIsolate::CreateRunningRootIsolate( const Settings&amp; settings, fml::RefPtr&lt;const DartSnapshot&gt; isolate_snapshot, std::unique_ptr&lt;PlatformConfiguration&gt; platform_configuration, Flags isolate_flags, fml::closure root_isolate_create_callback, const fml::closure&amp; isolate_create_callback, const fml::closure&amp; isolate_shutdown_callback, std::optional&lt;std::string&gt; dart_entrypoint, std::optional&lt;std::string&gt; dart_entrypoint_library, const std::vector&lt;std::string&gt;&amp; dart_entrypoint_args, std::unique_ptr&lt;IsolateConfiguration&gt; isolate_configuration, const UIDartState::Context&amp; context, const DartIsolate* spawning_isolate) &#123; if (!isolate_snapshot) &#123; FML_LOG(ERROR) &lt;&lt; \"Invalid isolate snapshot.\"; return &#123;&#125;; &#125; if (!isolate_configuration) &#123; FML_LOG(ERROR) &lt;&lt; \"Invalid isolate configuration.\"; return &#123;&#125;; &#125; isolate_flags.SetNullSafetyEnabled( isolate_configuration-&gt;IsNullSafetyEnabled(*isolate_snapshot)); isolate_flags.SetIsDontNeedSafe(isolate_snapshot-&gt;IsDontNeedSafe()); auto isolate = CreateRootIsolate(settings, // isolate_snapshot, // std::move(platform_configuration), // isolate_flags, // isolate_create_callback, // isolate_shutdown_callback, // context, // spawning_isolate // ) .lock(); if (!isolate) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not create root isolate.\"; return &#123;&#125;; &#125; fml::ScopedCleanupClosure shutdown_on_error([isolate]() &#123; if (!isolate-&gt;Shutdown()) &#123; FML_DLOG(ERROR) &lt;&lt; \"Could not shutdown transient isolate.\"; &#125; &#125;); if (isolate-&gt;GetPhase() != DartIsolate::Phase::LibrariesSetup) &#123; FML_LOG(ERROR) &lt;&lt; \"Root isolate was created in an incorrect phase: \" &lt;&lt; static_cast&lt;int&gt;(isolate-&gt;GetPhase()); return &#123;&#125;; &#125; if (!isolate_configuration-&gt;PrepareIsolate(*isolate.get())) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not prepare isolate.\"; return &#123;&#125;; &#125; if (isolate-&gt;GetPhase() != DartIsolate::Phase::Ready) &#123; FML_LOG(ERROR) &lt;&lt; \"Root isolate not in the ready phase for Dart entrypoint \" \"invocation.\"; return &#123;&#125;; &#125; if (settings.root_isolate_create_callback) &#123; // Isolate callbacks always occur in isolate scope and before user code has // had a chance to run. tonic::DartState::Scope scope(isolate.get()); settings.root_isolate_create_callback(*isolate.get()); &#125; if (root_isolate_create_callback) &#123; root_isolate_create_callback(); &#125; if (!isolate-&gt;RunFromLibrary(dart_entrypoint_library, // dart_entrypoint, // dart_entrypoint_args)) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not run the run main Dart entrypoint.\"; return &#123;&#125;; &#125; if (settings.root_isolate_shutdown_callback) &#123; isolate-&gt;AddIsolateShutdownCallback( settings.root_isolate_shutdown_callback); &#125; shutdown_on_error.Release(); return isolate;&#125;// 1. CreateRootIsolatestd::weak_ptr&lt;DartIsolate&gt; DartIsolate::CreateRootIsolate( const Settings&amp; settings, fml::RefPtr&lt;const DartSnapshot&gt; isolate_snapshot, std::unique_ptr&lt;PlatformConfiguration&gt; platform_configuration, Flags flags, const fml::closure&amp; isolate_create_callback, const fml::closure&amp; isolate_shutdown_callback, const UIDartState::Context&amp; context, const DartIsolate* spawning_isolate) &#123; TRACE_EVENT0(\"flutter\", \"DartIsolate::CreateRootIsolate\"); // The child isolate preparer is null but will be set when the isolate is // being prepared to run. auto isolate_group_data = std::make_unique&lt;std::shared_ptr&lt;DartIsolateGroupData&gt;&gt;( std::shared_ptr&lt;DartIsolateGroupData&gt;(new DartIsolateGroupData( settings, // settings std::move(isolate_snapshot), // isolate snapshot context.advisory_script_uri, // advisory URI context.advisory_script_entrypoint, // advisory entrypoint nullptr, // child isolate preparer isolate_create_callback, // isolate create callback isolate_shutdown_callback // isolate shutdown callback ))); auto isolate_data = std::make_unique&lt;std::shared_ptr&lt;DartIsolate&gt;&gt;( std::shared_ptr&lt;DartIsolate&gt;(new DartIsolate( settings, // settings true, // is_root_isolate std::move(context) // context ))); DartErrorString error; Dart_Isolate vm_isolate = nullptr; auto isolate_flags = flags.Get(); IsolateMaker isolate_maker; if (spawning_isolate) &#123; isolate_maker = [spawning_isolate]( std::shared_ptr&lt;DartIsolateGroupData&gt;* isolate_group_data, std::shared_ptr&lt;DartIsolate&gt;* isolate_data, Dart_IsolateFlags* flags, char** error) &#123; return Dart_CreateIsolateInGroup( /*group_member=*/spawning_isolate-&gt;isolate(), /*name=*/(*isolate_group_data)-&gt;GetAdvisoryScriptEntrypoint().c_str(), /*shutdown_callback=*/ reinterpret_cast&lt;Dart_IsolateShutdownCallback&gt;( DartIsolate::SpawnIsolateShutdownCallback), /*cleanup_callback=*/ reinterpret_cast&lt;Dart_IsolateCleanupCallback&gt;( DartIsolateCleanupCallback), /*child_isolate_data=*/isolate_data, /*error=*/error); &#125;; &#125; else &#123; isolate_maker = [](std::shared_ptr&lt;DartIsolateGroupData&gt;* isolate_group_data, std::shared_ptr&lt;DartIsolate&gt;* isolate_data, Dart_IsolateFlags* flags, char** error) &#123; return Dart_CreateIsolateGroup( (*isolate_group_data)-&gt;GetAdvisoryScriptURI().c_str(), (*isolate_group_data)-&gt;GetAdvisoryScriptEntrypoint().c_str(), (*isolate_group_data)-&gt;GetIsolateSnapshot()-&gt;GetDataMapping(), (*isolate_group_data)-&gt;GetIsolateSnapshot()-&gt;GetInstructionsMapping(), flags, isolate_group_data, isolate_data, error); &#125;; &#125; vm_isolate = CreateDartIsolateGroup(std::move(isolate_group_data), std::move(isolate_data), &amp;isolate_flags, error.error(), isolate_maker); if (error) &#123; FML_LOG(ERROR) &lt;&lt; \"CreateRootIsolate failed: \" &lt;&lt; error.str(); &#125; if (vm_isolate == nullptr) &#123; return &#123;&#125;; &#125; std::shared_ptr&lt;DartIsolate&gt;* root_isolate_data = static_cast&lt;std::shared_ptr&lt;DartIsolate&gt;*&gt;(Dart_IsolateData(vm_isolate)); (*root_isolate_data) -&gt;SetPlatformConfiguration(std::move(platform_configuration)); return (*root_isolate_data)-&gt;GetWeakIsolatePtr();&#125;// 2. RunFromLibrarybool DartIsolate::RunFromLibrary(std::optional&lt;std::string&gt; library_name, std::optional&lt;std::string&gt; entrypoint, const std::vector&lt;std::string&gt;&amp; args) &#123; TRACE_EVENT0(\"flutter\", \"DartIsolate::RunFromLibrary\"); if (phase_ != Phase::Ready) &#123; return false; &#125; tonic::DartState::Scope scope(this); auto library_handle = library_name.has_value() &amp;&amp; !library_name.value().empty() ? ::Dart_LookupLibrary(tonic::ToDart(library_name.value().c_str())) : ::Dart_RootLibrary(); // æŸ¥æ‰¾ entrypoint auto entrypoint_handle = entrypoint.has_value() &amp;&amp; !entrypoint.value().empty() ? tonic::ToDart(entrypoint.value().c_str()) : tonic::ToDart(\"main\"); if (!FindAndInvokeDartPluginRegistrant()) &#123; // TODO(gaaclarke): Remove once the framework PR lands that uses `--source` // to compile the Dart Plugin Registrant // (https://github.com/flutter/flutter/pull/100572). InvokeDartPluginRegistrantIfAvailable(library_handle); &#125; auto user_entrypoint_function = ::Dart_GetField(library_handle, entrypoint_handle); auto entrypoint_args = tonic::ToDart(args); // è°ƒç”¨ entrypoint çš„å‡½æ•°ï¼ŒInvokeMainEntrypoint if (!InvokeMainEntrypoint(user_entrypoint_function, entrypoint_args)) &#123; return false; &#125; phase_ = Phase::Running; return true;&#125;// 1. start_main_isolate_function// 2. _runMainZoned[[nodiscard]] static bool InvokeMainEntrypoint( Dart_Handle user_entrypoint_function, Dart_Handle args) &#123; if (tonic::LogIfError(user_entrypoint_function)) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not resolve main entrypoint function.\"; return false; &#125; Dart_Handle start_main_isolate_function = tonic::DartInvokeField(Dart_LookupLibrary(tonic::ToDart(\"dart:isolate\")), \"_getStartMainIsolateFunction\", &#123;&#125;); if (tonic::LogIfError(start_main_isolate_function)) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not resolve main entrypoint trampoline.\"; return false; &#125; if (tonic::LogIfError(tonic::DartInvokeField( Dart_LookupLibrary(tonic::ToDart(\"dart:ui\")), \"_runMainZoned\", &#123;start_main_isolate_function, user_entrypoint_function, args&#125;))) &#123; FML_LOG(ERROR) &lt;&lt; \"Could not invoke the main entrypoint.\"; return false; &#125; return true;&#125;ç”±ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º engine å¯åŠ¨çš„æ•´ä¸ªæµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šåœ¨ FlutterEngine åˆ›å»º shell æ—¶ä¼šåˆ›å»º UI Task Runnerã€Platform Task Runnerã€IO Task Runner åŠ Raster Task Runner è¿™å››ä¸ª Task Runnerï¼Œæ¯ä¸ª Runner åˆ†åˆ«ä¼šå¤„ç†å…¶å¯¹åº”çš„ä»»åŠ¡thread_host åˆ›å»ºçº¿ç¨‹ï¼Œè´Ÿè´£ä¸åŒçš„å·¥ä½œ12345678910111213141516171819202122232425ThreadHost::ThreadHost(const ThreadHostConfig&amp; host_config) : name_prefix(host_config.name_prefix) &#123; if (host_config.isThreadNeeded(ThreadHost::Type::Platform)) &#123; platform_thread = CreateThread(Type::Platform, host_config.platform_config, host_config); &#125; if (host_config.isThreadNeeded(ThreadHost::Type::UI)) &#123; ui_thread = CreateThread(Type::UI, host_config.ui_config, host_config); &#125; if (host_config.isThreadNeeded(ThreadHost::Type::RASTER)) &#123; raster_thread = CreateThread(Type::RASTER, host_config.raster_config, host_config); &#125; if (host_config.isThreadNeeded(ThreadHost::Type::IO)) &#123; io_thread = CreateThread(Type::IO, host_config.io_config, host_config); &#125; if (host_config.isThreadNeeded(ThreadHost::Type::Profiler)) &#123; profiler_thread = CreateThread(Type::Profiler, host_config.profiler_config, host_config); &#125;&#125;FlutterView æºç è§£æFlutterView å¹¶æ²¡æœ‰å¤ªå¤šåŠŸèƒ½ï¼Œä¸»è¦æ˜¯ä¸¤ç‚¹ï¼šåˆå§‹åŒ–æ—¶ä¼ å…¥ FlutterViewEngineDelegateåˆ›å»º flutter::drawLayerå®é™…ä¸Šï¼Œä» FlutterViewController ä»£ç åˆ›å»ºçš„ FlutterViewï¼Œå¯ä»¥çœ‹å‡ºå®é™…ä¸Š FlutterViewEngineDelegate æ˜¯ç”± FlutterEngine å®ç°çš„ã€‚1_flutterView.reset([[FlutterView alloc] initWithDelegate:_engine opaque:self.isViewOpaque]);1234567891011121314151617@protocol FlutterViewEngineDelegate &lt;NSObject&gt;- (flutter::Rasterizer::Screenshot)takeScreenshot:(flutter::Rasterizer::ScreenshotType)type asBase64Encoded:(BOOL)base64Encode;- (std::shared_ptr&lt;flutter::FlutterPlatformViewsController&gt;&amp;)platformViewsController;/** * A callback that is called when iOS queries accessibility information of the Flutter view. * * This is useful to predict the current iOS accessibility status. For example, there is * no API to listen whether voice control is turned on or off. The Flutter engine uses * this callback to enable semantics in order to catch the case that voice control is * on. */- (void)flutterViewAccessibilityDidCall;@end12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// æ ¹æ®è®¾å¤‡åŠç³»ç»Ÿç‰ˆæœ¬å†³å®šç”¨é‚£ç§æ¸²æŸ“ API å®ç°ï¼ŒCALayer/CAEAGLLayer/CAMetalLayer+ (Class)layerClass &#123; return flutter::GetCoreAnimationLayerClassForRenderingAPI( flutter::GetRenderingAPIForProcess(FlutterView.forceSoftwareRendering));&#125;- (void)drawLayer:(CALayer*)layer inContext:(CGContextRef)context &#123; TRACE_EVENT0(\"flutter\", \"SnapshotFlutterView\"); if (layer != self.layer || context == nullptr) &#123; return; &#125; // è·å– Flutter æ¸²æŸ“çš„æ•°æ®æº auto screenshot = [_delegate takeScreenshot:flutter::Rasterizer::ScreenshotType::UncompressedImage asBase64Encoded:NO]; if (!screenshot.data || screenshot.data-&gt;isEmpty() || screenshot.frame_size.isEmpty()) &#123; return; &#125; NSData* data = [NSData dataWithBytes:const_cast&lt;void*&gt;(screenshot.data-&gt;data()) length:screenshot.data-&gt;size()]; fml::CFRef&lt;CGDataProviderRef&gt; image_data_provider( CGDataProviderCreateWithCFData(reinterpret_cast&lt;CFDataRef&gt;(data))); fml::CFRef&lt;CGColorSpaceRef&gt; colorspace(CGColorSpaceCreateDeviceRGB()); fml::CFRef&lt;CGImageRef&gt; image(CGImageCreate( screenshot.frame_size.width(), // size_t width screenshot.frame_size.height(), // size_t height 8, // size_t bitsPerComponent 32, // size_t bitsPerPixel, 4 * screenshot.frame_size.width(), // size_t bytesPerRow colorspace, // CGColorSpaceRef space static_cast&lt;CGBitmapInfo&gt;(kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big), // CGBitmapInfo bitmapInfo image_data_provider, // CGDataProviderRef provider nullptr, // const CGFloat* decode false, // bool shouldInterpolate kCGRenderingIntentDefault // CGColorRenderingIntent intent )); const CGRect frame_rect = CGRectMake(0.0, 0.0, screenshot.frame_size.width(), screenshot.frame_size.height()); CGContextSaveGState(context); CGContextTranslateCTM(context, 0.0, CGBitmapContextGetHeight(context)); CGContextScaleCTM(context, 1.0, -1.0); CGContextDrawImage(context, frame_rect, image); CGContextRestoreGState(context);&#125;123456789101112131415161718192021222324252627IOSRenderingAPI GetRenderingAPIForProcess(bool force_software) &#123;#if TARGET_OS_SIMULATOR // æ¨¡æ‹Ÿå™¨ä½¿ç”¨ CALayer if (force_software) &#123; return IOSRenderingAPI::kSoftware; &#125;#else if (force_software) &#123; FML_LOG(WARNING) &lt;&lt; \"The --enable-software-rendering is only supported on Simulator targets \" \"and will be ignored.\"; &#125;#endif // TARGET_OS_SIMULATOR#if SHELL_ENABLE_METAL // å¦‚æœå¯ä»¥ä½¿ç”¨ Metal åˆ™ä½¿ç”¨ CAMetalLayer static bool should_use_metal = ShouldUseMetalRenderer(); if (should_use_metal) &#123; return IOSRenderingAPI::kMetal; &#125;#endif // SHELL_ENABLE_METAL // OpenGL will be emulated using software rendering by Apple on the simulator, so we use the // Skia software rendering since it performs a little better than the emulated OpenGL.#if TARGET_OS_SIMULATOR return IOSRenderingAPI::kSoftware;#else // çœŸæœºå¹¶ä¸”ä¸ä½¿ç”¨ Metalï¼Œåˆ™é»˜è®¤ä½¿ç”¨ OpenGL ES CAEAGLLayer return IOSRenderingAPI::kOpenGLES;#endif // TARGET_OS_SIMULATOR&#125;ç”±æ­¤å¯è§ï¼ŒFlutterVIew å…¶å®å°±æ˜¯æä¾›äº†ä¸€ä¸ªç”»å¸ƒæ¥æ˜¾ç¤ºæ¸²æŸ“çš„å†…å®¹ï¼Œå…·ä½“è¯¦ç»†çš„æ¸²æŸ“æ˜¯ç”± FlutterEngine æ¥å®ç°ã€‚æ€»ç»“Flutter è¿è¡Œäº iOS ä¹‹ä¸Šï¼Œä»æºç å±‚é¢çœ‹ï¼Œæ€»ç»“å¦‚ä¸‹ï¼šå¤ç”¨äº†ç°æœ‰çš„ä¸‰ç±» CALayer æ¥ç»˜åˆ¶ç•Œé¢ï¼ŒdrawLayer æ—¶ä¼šè°ƒç”¨ takeScreenshot æ¥è·å– Flutter ç•Œé¢çš„å…‰æ …å›¾ã€‚Flutter è‡ªèº«ä¼šåˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„çº¿ç¨‹ç¯å¢ƒæ¥è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯å››ä¸ª TaskRunnerï¼ŒUI Task Runnerã€Platform Task Runnerã€Raster Task Runnerã€IO Task Runnerã€‚Platform Task Runnerï¼ŒåŸç”Ÿç«¯è·Ÿ Flutter çš„æ‰€æœ‰äº¤äº’éƒ½ä¼šåœ¨ Platform Task Runner è¿›è¡Œå¤„ç†ã€‚FlutterViewController å°†æ‰€æœ‰çš„æ‰‹åŠ¿äº¤äº’ç›¸å…³çš„éƒ½è½¬å‘ç»™ FlutterEngine ã€‚Flutter è¿è¡Œæµç¨‹ä¸ºäº†éªŒè¯æ•´ä¸ªè¿è¡Œæµç¨‹ï¼Œæˆ‘åˆ†åˆ«åœ¨ä¸Šé¢æ‰€æåˆ°çš„ä¸€äº›æ–¹æ³•è®¾ç½®æ–­ç‚¹è¿›è¡Œè°ƒè¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šæ–­ç‚¹æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šå¯¹æ•´ä¸ª Flutter è¿è¡Œçš„æµç¨‹å¯ä»¥å¤§è‡´æ€»ç»“å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ä¾§é‡åœ¨å¼•æ“ä¾§ï¼Œä»…ä¾›å‚è€ƒï¼šåˆ›å»º FlutterViewControlleråˆ›å»º FlutterViewã€åˆ›å»º FlutterEngineåˆ›å»º shellåˆ›å»º Dart VMå¯»æ‰¾ DartLibraryå®šä½åˆ° Entrypointåˆ›å»º engineï¼Œä¼ å…¥ DartLibrary å’Œ EntrypointRuntimeController LaunchRootIsolate åˆ›å»º isolateå¯åŠ¨ engineã€ Dart VMåŠ è½½ DartLibraryï¼Œè¿è¡Œ dart çš„ Entrypointæˆªå– Dart UI çš„ç•Œé¢å¹¶å…‰æ …åŒ–å¹¶ç»˜åˆ¶åˆ° CALayer/CAMetalLayer/CAEAGLLayer","tags":[{"name":"Flutter","slug":"Flutter","permalink":"https://orangeschen.cn/tags/Flutter/"},{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Flutter ä¹¦å•åˆ—è¡¨æ¨è","date":"2022-08-08T12:07:19.000Z","path":"flutter/flutter-books-list.html","text":"ç¬”è€…å¼€å‘çš„æ—¶å€™éƒ½æ˜¯åœ¨ç½‘ä¸Šè¾¹çœ‹ä¸€äº›åšå®¢å­¦ä¹ è¾¹å¼€å‘çš„ï¼Œå¯¹ Flutter è¿˜æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„è®¤è¯†ï¼Œå¼€å‘çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€ç›´å¤„äºæ‘¸ç´¢é˜¶æ®µï¼Œæœ€è¿‘å°±é˜…è¯»äº†ä¸€äº› Flutter ç›¸å…³çš„ä¹¦ï¼Œæƒ³è¦ç³»ç»Ÿå…¨é¢çš„å­¦ä¹ ä¸€ä¸‹ Flutterï¼Œç„¶åå‘ç°å¸‚é¢ä¸Šçš„ä¹¦å¤§å¤šæ•°éƒ½æ˜¯é’ˆå¯¹åˆå­¦è€…çš„ï¼Œä¸»è¦æ˜¯å¸®åŠ©å¼€å‘è€…æ¯”è¾ƒå®Œå–„çš„äº†è§£ Flutter UI å±‚é¢çš„ä¸€äº›å¼€å‘çŸ¥è¯†ï¼Œæœ€å¤šæ¶‰åŠåˆ° Framework å±‚çš„ä¸€äº›æºç åˆ†æï¼Œå…¶ä½™éƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ä¸€äº› API ä½¿ç”¨çš„æ¦‚å¿µã€‚ä»¥ä¸‹å°±æ˜¯æˆ‘é˜…è¯»çš„ä¸€äº›ä¹¦ï¼Œç¿»é˜…çš„è¿™äº›ä¹¦çš„æ—¶å€™ï¼Œå‘ç°éƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥å°±æƒ³å†™ä¸€ç¯‡æ–‡ç« è¿›è¡Œæ€»ç»“æ¨èï¼Œç»™ä¸€äº›éœ€è¦å­¦ä¹  Flutter çš„å¼€å‘è€…æä¾›ä¸€äº›å‚è€ƒæ„è§ã€‚Flutter åŸºç¡€ä¸å®æˆ˜ä»å…¥é—¨åˆ° App è·¨å¹³å°å¼€å‘Flutter æŠ€æœ¯å…¥é—¨ä¸å®æˆ˜ç¬¬2ç‰ˆFlutter è·¨å¹³å°å¼€å‘å…¥é—¨ä¸å®æˆ˜Flutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—Flutter å¼€å‘å®æˆ˜è¯¦è§£Flutter å†…æ ¸æºç å‰–æè¿™ä¸ªåˆ—è¡¨çš„ä¹¦ç±æˆ‘æ˜¯æŒ‰ç…§ä»æ˜“â¡ï¸éš¾æ¥æ’åºçš„ï¼Œå…¶å®åªæœ‰ ã€ŠFlutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—ã€‹å’Œ ã€ŠFlutter å¼€å‘å®æˆ˜è¯¦è§£ã€‹è¿™ä¸¤æœ¬ä¹¦æ˜¯æˆ‘ä»å¤´åˆ°å°¾ä»”ç»†é˜…è¯»å®Œçš„ï¼Œå…¶ä½™çš„æˆ‘éƒ½æ˜¯å¤§æ¦‚ç¿»é˜…äº†ä¸‹ï¼Œåªé’ˆå¯¹ä¸€äº›ä¸åŒçš„ç« èŠ‚é‡ç‚¹å»çœ‹ã€‚å¦‚æœæ˜¯å®Œå…¨é›¶åŸºç¡€çš„ä¸”å‰ç«¯å¼€å‘ç»éªŒæ¯”è¾ƒå°‘çš„è¯»è€…ï¼Œæ¨è ã€ŠFlutter åŸºç¡€ä¸å®æˆ˜ä»å…¥é—¨åˆ° App è·¨å¹³å°å¼€å‘ã€‹è¿™æœ¬ä¹¦ï¼Œè¿™æœ¬ä¹¦æ„Ÿè§‰ä¸»è¦å°±æ˜¯é’ˆå¯¹é›¶åŸºç¡€çš„ï¼Œå±äºæ‰‹æŠŠæ‰‹å¼æ•™å­¦ï¼Œæ¯”è¾ƒé€šä¿—æ˜“æ‡‚ã€‚å¦‚æœæ˜¯å±äºæœ‰ä¸€å®šå‰ç«¯å¼€å‘åŸºç¡€ä½†æ²¡æœ‰ Flutter å¼€å‘ç»éªŒçš„ï¼Œæ¨è ã€ŠFlutter å¼€å‘å®æˆ˜è¯¦è§£ã€‹ è¿™æœ¬ä¹¦ï¼Œå†…å®¹ç›¸å¯¹ ã€ŠFlutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—ã€‹æ›´åŠ å®Œå–„ï¼Œå½“ç„¶å¦‚æœä½ å·²ç»æœ‰ ã€ŠFlutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—ã€‹è¿™æœ¬ä¹¦äº†çš„è¯ï¼Œé‚£å°±æ²¡å¿…è¦å†çœ‹ Flutter å¼€å‘å®æˆ˜è¯¦è§£ã€‹è¿™æœ¬äº†ã€‚æœ€åä¸ç”¨è¯´å•¦ï¼Œå¦‚æœæ˜¯è¦è¿›é˜¶çš„è¯ï¼Œç°åœ¨ä¹Ÿå°±åªæœ‰ ã€ŠFlutter å†…æ ¸æºç å‰–æã€‹è¿™æœ¬ä¹¦äº†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€éš¾å•ƒçš„ä¸€æœ¬ä¹¦ï¼Œä¸è¿‡è¿™æœ¬ä¹¦æˆ‘è¿˜æ²¡çœ‹ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•æä¾›å¤ªå¤šçš„å»ºè®®ã€‚å…³äºæ¯ä¸€æœ¬ä¹¦çš„ç®€ä»‹ï¼Œæˆ‘åœ¨åé¢éƒ½æœ‰åˆ—å‡ºæ¥ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚Flutter åŸºç¡€ä¸å®æˆ˜ä»å…¥é—¨åˆ° App è·¨å¹³å°å¼€å‘ä¹¦åFlutter åŸºç¡€ä¸å®æˆ˜å…¥é—¨åˆ° App è·¨å¹³å°å¼€å‘ä½œè€…èµµé¾™å‡ºç‰ˆæ—¶é—´2021-01-01ç®€ä»‹æœ¬ä¹¦æ—¨åœ¨å¸®åŠ©è¯»è€…å¿«é€Ÿå…¥é—¨ Flutterã€æŒæ¡ Flutter å¼€å‘æŠ€èƒ½ï¼Œä»è€Œå…·å¤‡ä¸€å®šçš„ Flutter è·¨å¹³å°å¼€å‘èƒ½åŠ›ç¤ºä¾‹ä»£ç https://github.com/zhaolongs/flutter_book_jixieæ•´æœ¬ä¹¦å†…å®¹ä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯ UI å±‚é¢çš„çŸ¥è¯†ï¼Œè¿™æœ¬ä¹¦æ¯”è¾ƒé€‚åˆåˆå­¦è€…ï¼Œç®€å•æ˜“æ‡‚ï¼Œè·Ÿå…¶ä»–æ¯”è¾ƒå¤§çš„ä¸åŒæ˜¯è¿™æœ¬ä¹¦æ˜¯å½©å°çš„ï¼Œå›¾æ–‡å¹¶èŒ‚ï¼Œå›¾ç‰‡è¯´æ˜ä¹Ÿå¾ˆè¯¦ç»†ï¼Œå±äºæ‰‹æŠŠæ‰‹æ•™å­¦æŒ‡å¯¼ï¼ŒåŸºç¡€å†…å®¹æ¯”è¾ƒå…¨é¢ä¸”è¯¦ç»†ï¼Œå„ç§ UI å¸ƒå±€åŠä½¿ç”¨æ•™ç¨‹ï¼Œè§£è¯´è¯¦ç»†ï¼Œæˆªå›¾ä¸Šä¹Ÿä¼šæœ‰å¯¹åº”çš„è¯´æ˜æ ‡å¿—ã€‚ä¹¦ä¸­çš„æˆªå›¾ä¸»è¦å°±æ˜¯ä¸€äº›ç¤ºä¾‹çš„æˆªå›¾ï¼Œå…³äºä¸€äº›å†…å®¹ç›¸å…³çš„é€»è¾‘è§†å›¾æ¯”è¾ƒå°‘ï¼Œä¸æ–¹ä¾¿åŠ æ·±è®°å¿†ã€‚ä¸è¿‡å¯èƒ½ä¹Ÿæ˜¯å› ä¸ºï¼Œä¹¦æœ¬å†…å®¹éƒ½æ¯”è¾ƒç®€å•ï¼Œå…¥é—¨çº§åˆ«ï¼Œæ²¡æœ‰å¤ªè¿‡æ·±å…¥çš„ä¸œè¥¿ï¼Œå±äºå·¥å…·ä¹¦ç±»åˆ«äº†ã€‚Flutter æŠ€æœ¯å…¥é—¨ä¸å®æˆ˜ç¬¬2ç‰ˆä¹¦åFlutter æŠ€æœ¯å…¥é—¨ä¸å®æˆ˜ç¬¬2ç‰ˆä½œè€…äº¢å°‘å†›å‡ºç‰ˆæ—¶é—´2019-12-01ç®€ä»‹æœ¬ä¹¦ç”±èµ„æ·±æ¶æ„å¸ˆæ’°å†™ï¼Œè¯¦ç»†è®²è§£ Flutter çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æŠ€å·§ã€‚æ—¢æœ‰åŸºç¡€çŸ¥è¯†ï¼Œåˆæœ‰ä¸°å¯Œç¤ºä¾‹ï¼Œå¹¶åŒ…æ‹¬è¯¦ç»†æ¡ˆä¾‹çš„æ“ä½œæ­¥éª¤ï¼Œå®æ“æ€§å¼ºã€‚è¿˜æœ‰é…å¥—ç½‘ç«™æä¾›äº†å®Œæ•´æ¡ˆä¾‹ä»£ç å’Œè§†é¢‘è¯¾ç¨‹ï¼Œå¯å¸®åŠ©è¯»è€…è½»æ¾æŒæ¡åŸºç¡€çŸ¥è¯†ï¼Œå¿«é€Ÿè¿›å…¥å®æˆ˜ã€‚æ•´æœ¬ä¹¦å†…å®¹ä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯ UI å±‚é¢çš„çŸ¥è¯†ï¼Œé€‚åˆåˆå­¦è€…ã€‚å†…å®¹æ¯”è¾ƒç®€å•ï¼Œé‡Œé¢æ²¡æœ‰ä»€ä¹ˆåº•å±‚çŸ¥è¯†ï¼Œä¸»è¦æ˜¯ UI çš„ä½¿ç”¨ç­‰åŸºç¡€çŸ¥è¯†ï¼Œå…¥é—¨çº§åˆ«ã€‚ç›¸å¯¹äºå…¶ä»–å…¥é—¨çº§åˆ«çš„ä¹¦ï¼Œè¿™æœ¬ä¹¦è¯´å®è¯æ²¡æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Œå±äºæ¯”è¾ƒæ™®é€šçš„äº†ï¼Œæ²¡å‘ç°ä»€ä¹ˆäº®ç‚¹ã€‚Flutter è·¨å¹³å°å¼€å‘å…¥é—¨ä¸å®æˆ˜ä¹¦åFlutter è·¨å¹³å°å¼€å‘å…¥é—¨ä¸å®æˆ˜ä½œè€…å‘æ²»æ´ªå‡ºç‰ˆæ—¶é—´2021-01-01ç®€ä»‹æœ¬ä¹¦å…± 14 ç« ï¼Œæ¶µç›– Flutter è·¨å¹³å°å¼€å‘æ‰€éœ€çš„å„æ–¹é¢çŸ¥è¯†ï¼Œå¾ªåºæ¸è¿›çš„è®²è§£æœ‰åŠ©äºè¯»è€…æ›´æ·±å…¥åœ°å­¦ä¹  Flutter çŸ¥è¯†é€‚åˆåˆå­¦è€…è§‚çœ‹ï¼Œå†…å®¹ç®—æ˜¯æ¯”è¾ƒå…¨é¢çš„ï¼Œè·Ÿå…¶ä»–å…¥é—¨çº§å›¾ä¹¦å·®åˆ«ä¸å¤§ï¼Œå…³äºäº‹ä»¶å¤„ç†è¿™ä¸€å—å†…å®¹å’Œå…¶ä»–çš„å¯¹æ¯”ç¨å¾®æœ‰äº›ä¸åŒï¼Œå…¶ä½™å·®ä¸å¤šã€‚ä½œä¸ºå…¥é—¨ä¹¦ç±æ¥è¯´ï¼Œç®—æ˜¯æ¯”è¾ƒå…¨é¢çš„äº†ï¼Œæ•´æœ¬ä¹¦çš„å†…å®¹ä¹Ÿæ²¡æœ‰å¾ˆå¤šï¼Œ300é¡µï¼Œæ€»çš„æ¥è¯´æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„ç¼ºç‚¹ã€‚Flutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—ä¹¦åFlutter å¼€å‘ä¹‹æ—…ä»å—åˆ°åŒ—ä½œè€…æ¨åŠ åº·å‡ºç‰ˆæ—¶é—´2020-11-01ç®€ä»‹æœ¬ä¹¦ä¸»è¦è®²è¿° Flutter æ¡†æ¶çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œæœ‰åŠ©äºè¯»è€…æ·±å…¥ç†è§£ Flutter æŠ€æœ¯çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ã€‚æ•´æœ¬ä¹¦æ²¡æœ‰å¤ªæ·±çš„å†…å®¹ï¼Œæœ‰ä¸€äº›åŸç†ä»‹ç»ï¼Œä¸»è¦æ˜¯æ¶‰åŠ Framework å±‚é¢çš„ï¼Œæœªæ¶‰åŠå¼•æ“æ–¹é¢æºç åˆ†æï¼Œå…¥é—¨çº§åˆ«ï¼Œä½“ç³»æ¯”è¾ƒå®Œæ•´ï¼Œæœ‰åŠ©äºå…¨é¢çš„ç†è§£ Flutter å®Œæ•´çš„ä½“ç³»ã€‚Flutter å¼€å‘å®æˆ˜è¯¦è§£ä¹¦åFlutter å¼€å‘å®æˆ˜è¯¦è§£ä½œè€…éƒ­æ ‘ç…œå‡ºç‰ˆæ—¶é—´2020-05-01ç®€ä»‹ã€Š Flutter å¼€å‘å®æˆ˜è¯¦è§£ ã€‹ä»¥å®æˆ˜ä¸ºå¯¼å‘ï¼Œç”±æµ…å…¥æ·±åœ°ä»‹ç»äº† Flutter å¼€å‘è¿‡ç¨‹ä¸­çš„åŸºç¡€ä½“ç³»ã€å®æˆ˜æŠ€å·§å’Œæºç åˆ†æã€‚é€šè¿‡æœ¬ä¹¦ï¼Œè¯»è€…å¯ä»¥å¿«é€ŸæŒæ¡ Flutter çš„å¼€å‘æŠ€èƒ½ï¼Œå¹¶é€šè¿‡å®æˆ˜å­¦ä¹  Flutter çš„æºç è®¾è®¡ã€‚ç¤ºä¾‹ä»£ç https://github.com/CarGuo/gsy_github_app_flutterç”±æµ…å…¥æ·±åœ°ä»‹ç»äº† Flutter å¼€å‘è¿‡ç¨‹ä¸­çš„åŸºç¡€ä½“ç³»ã€å®æˆ˜æŠ€å·§å’Œæºç åˆ†æï¼Œå†…å®¹å…¨é¢è¯¦ç»†ï¼Œç›¸è¾ƒä¸å‰é¢é‚£å‡ æœ¬ï¼Œè¿™æœ¬å†…å®¹ç®—æ˜¯ç¨å¾®æ·±å…¥ä¸€äº›çš„ï¼Œæ¶‰åŠåˆ° Framework å±‚æºç åˆ†æï¼Œæ‰€ä»¥é€‚åˆæœ‰ä¸€å®š Flutter å¼€å‘çš„è¯»è€…é˜…è¯»ã€‚è¿™æœ¬ä¹¦æ˜¯æˆ‘çœ‹çš„æ¯”è¾ƒä»”ç»†çš„ä¸€æœ¬äº†ï¼Œæ˜¯æˆ‘è®¤ä¸ºçœ‹è¿‡çš„æ‰€æœ‰å…¥é—¨çº§åˆ«å½“ä¸­æœ€å¥½çš„ä¸€æœ¬ä¹¦ã€‚Flutter å†…æ ¸æºç å‰–æä¹¦åFlutter å†…æ ¸æºç å‰–æä½œè€…èµµè£•å‡ºç‰ˆæ—¶é—´2022-01-01ç®€ä»‹æ¶‰åŠæºç çš„è·å–ä¸æ„å»ºï¼ŒåŠŸèƒ½æ¨¡å—çš„å®ç°ä»¥åŠ Flutter åº”ç”¨çš„æ€§èƒ½æ¢æµ‹ï¼Œç›‘æ§å’Œè°ƒä¼˜ï¼Œæ¨ªè·¨ Javaã€C++ã€Dartï¼Œè¦†ç›– Flutter 1.0 å’Œ 2.0 ç‰ˆæœ¬ã€‚è¿™æœ¬ä¹¦æ˜¯åœ¨æˆ‘çš„é˜…è¯»æ¸…å•é‡Œçš„ï¼Œè¿˜æ²¡å¼€å§‹çœ‹ï¼Œæ‰€ä»¥ä¹¦çš„è´¨é‡æˆ–è€…å†…å®¹æ¥å—éš¾æ˜“ç¨‹åº¦ç›®å‰è¿˜æ˜¯æœªçŸ¥ï¼Œä¸è¿‡è¿™æœ¬ç®—æ˜¯å¸‚é¢ä¸Šé’ˆå¯¹ Flutter åº•å±‚æºç åˆ†æçš„å”¯ä¸€ä¸€æœ¬ä¹¦äº†ï¼Œæƒ³è¦è¿›é˜¶çš„è¯ï¼Œè¿˜æ˜¯æ¨èé˜…è¯»è¿™æœ¬ä¹¦ã€‚é¡¾åæ€ä¹‰ï¼Œé€šè¿‡è¿™æœ¬ä¹¦çš„ä¹¦åå°±çŸ¥é“è¿™æœ¬ä¹¦çš„å†…å®¹æ¶‰åŠåˆ°æºç å±‚åˆ†æï¼Œé€‚åˆå¯¹è·¨å¹³å°æŠ€æœ¯æ„Ÿå…´è¶£çš„å¼€å‘äººå‘˜ã€å‰ç«¯å¼€å‘äººå‘˜ã€Android/iOS å¼€å‘äººå‘˜ï¼Œå¸Œæœ›æ·±å…¥äº†è§£ Flutter æˆ–æœ‰æ€§èƒ½è°ƒä¼˜éœ€æ±‚çš„å¼€å‘äººå‘˜ï¼Œå¯¹ç§»åŠ¨ç«¯æ¸²æŸ“æ¡†æ¶æ„Ÿå…´è¶£çš„å¼€å‘äººå‘˜ï¼Œä»¥åŠæ¸´æœ›æ·±å…¥äº†è§£ Flutter åº•å±‚å®ç°çš„å¼€å‘äººå‘˜é˜…è¯»ã€‚","tags":[{"name":"Flutter","slug":"Flutter","permalink":"https://orangeschen.cn/tags/Flutter/"},{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Clean Architecture","date":"2021-05-18T12:58:55.000Z","path":"front-end/clean-architecture.html","text":"æœ€æ—©åœ¨å®‰å“åº”ç”¨ä¸Šä½¿ç”¨é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"React && Angular","date":"2021-05-18T12:58:55.000Z","path":"front-end/react-and-angular.html","text":"React ä¸ Angular","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"React && Flutter","date":"2021-05-18T12:58:55.000Z","path":"front-end/react-and-flutter.html","text":"React ä¸ Flutter","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"React Hooks","date":"2021-05-18T12:58:55.000Z","path":"front-end/react-hooks.html","text":"é’©å­(hook)çš„ä½œç”¨ç»„ä»¶å°½é‡å†™æˆçº¯å‡½æ•°ï¼Œå¦‚æœéœ€è¦å¤–éƒ¨åŠŸèƒ½å’Œå‰¯ä½œç”¨ï¼Œå°±ç”¨é’©å­æŠŠå¤–éƒ¨ä»£ç å‹¾è¿›æ¥hookæ˜¯Reactå‡½æ•°ç»„ä»¶çš„å‰¯æ•ˆåº”è§£å†³æ–¹æ¡ˆï¼Œç”¨æ¥ä¸ºå‡½æ•°ç»„ä»¶å¼•å…¥å‰¯æ•ˆåº”useState() ä¿å­˜çŠ¶æ€useCOntext() ä¿å­˜ä¸Šä¸‹æ–‡useRef() ä¿å­˜å¼•ç”¨","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Fish Redux","date":"2021-05-17T16:00:00.000Z","path":"front-end/fish-redux.html","text":"Flutter Fish Redux","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"Flutter Root Widget","date":"2021-05-17T16:00:00.000Z","path":"front-end/root-widget.html","text":"Flutter Root Widget","tags":[{"name":"FrontEnd","slug":"FrontEnd","permalink":"https://orangeschen.cn/tags/FrontEnd/"}]},{"title":"2020æ€»ç»“ï½œå†™ç»™2021çš„è‡ªå·±","date":"2021-05-16T13:40:40.000Z","path":"life/review-2020.html","text":"å°±æŒºç§ƒç„¶çš„ï¼Œå…»ç”Ÿå£å·å–Šèµ·æ¥ï¼Œé˜²æ­¢çˆ†è‚ğŸ˜­å¼•è¨€2020æ˜¯ç‰¹æ®Šçš„ä¸€å¹´ï¼Œåœ°ç‹±å¼€ç«¯ï¼Œâ€˜æ´»ç€å°±å¥½â€™æˆäº†2020çš„slogonï¼Œæœç„¶ä»Šå¹´æ³¨å®šæ˜¯ä¸å¹³å‡¡çš„ä¸€å¹´ã€‚çœ‹å¤§å®¶åˆ°å¹´åº•æ€»ä¼šå†™ä¸€ä¸‹å¹´åº¦æ€»ç»“ï¼Œæƒ³äº†æƒ³ï¼Œè‡ªå·±ç°åœ¨çš„è®°å¿†åŠ›æ˜¯åœ¨é€æ¸è¡°å‡ï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦è®°å½•ä¸€ä¸‹è¿™ä¸€å¹´å‘ç”Ÿçš„äº‹æƒ…ï¼Œä»¥æ­¤æ¥é­ç­–ä»¥åçš„è‡ªå·±ã€‚å·¥ä½œå…ˆæ€»ç»“å·¥ä½œå§ï¼Œå·¥ä½œæ˜¯2020ä¸€æ•´å¹´çš„å¤§å¤´ã€‚2019å¹´11æœˆ12æ—¥åŠ å…¥çš„ç°åœ¨è¿™å®¶å…¬å¸ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œæœ¬æ¥æ˜¯ä½œä¸ºiOSå¼€å‘è¿›æ¥çš„ï¼Œç»“æœtitleæ˜¯å¤§å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œemmmm è¿™å…¶å®ä¹Ÿè¿˜å¥½ï¼Œæ¯•ç«Ÿè‡ªå·±å½“åˆä¹Ÿæ˜¯æƒ³è¶æœºäº†è§£äº†è§£å‰ç«¯çš„æŠ€æœ¯ã€‚å…¬å¸å‰æœŸå·¥ä½œæ°›å›´è¿˜æ˜¯å¾ˆæ„‰å¿«çš„ï¼ŒåŒäº‹éƒ½å¾ˆæœ‰è¶£ï¼Œå¼¹æ€§å·¥ä½œåˆ¶ï¼Œè™½ç„¶æ¯å¤©å·¥ä½œæ—¶é•¿éƒ½10ä¸ªå°æ—¶ä»¥ä¸Šï¼Œå¤§å°å‘¨ï¼Œå¹¶æ²¡æœ‰è§‰å¾—ç–²æƒ«ï¼Œåè€Œè§‰å¾—å¾ˆå……å®ã€‚ç›´åˆ°2020å¹´åï¼Œäººå‘˜å¼€å§‹å˜åŠ¨ï¼Œä¹‹å‰ä¸€ç›´åœ¨åšçš„appé¡¹ç›®ä¹Ÿç»ˆæ­¢äº†ã€‚å¼€å§‹è½¬æ‰‹å°ç¨‹åºå’Œå‰ç«¯å¼€å‘ï¼Œæ‘¸ç´¢åˆ°6æœˆä»½æ—¶ï¼Œäººå‘˜å†æ¬¡å‘ç”Ÿå˜åŠ¨ï¼Œå°ç»„å¼€å§‹è½¬å‘å·¥ç¨‹æ•ˆèƒ½è¿™å—ï¼Œä¸»è¦åšäº›åŸºå»ºç±»çš„å·¥ä½œï¼Œåç»­ä¹Ÿä¸»è¦åœ¨ç»´æŠ¤å‰ç«¯é¡¹ç›®å’Œè¿­ä»£éœ€æ±‚ä¸Šï¼Œä¸­é€”è¿˜æ¥æ‰‹äº†pythonçˆ¬è™«çš„å·¥ä½œå†…å®¹ã€‚è¿™ä¸€å¹´åªèƒ½è¯´æŠ€æœ¯æ·±åº¦å€’æ²¡å•¥å˜åŒ–ï¼Œå¹¿åº¦å€’æ˜¯æœ‰ä¸€å®šçš„æ‰©å±•äº†ã€‚åœ¨å…¬å¸çš„è§’è‰²æ„Ÿè§‰å°±æ˜¯ä¸€å—ç –ï¼Œå“ªé‡Œéœ€è¦å»å“ªé‡Œï¼Œæœ‰ç‚¹æ™•å¤´è½¬å‘ã€‚æŠ€æœ¯2020ç®—æ˜¯ç»™æˆ‘æ‰“å¼€äº†æ–°å¤§é—¨å§ï¼Œæ¥è§¦åˆ°äº†å¾ˆå¤šæ–°çš„æŠ€æœ¯ï¼Œæ–°è¯­è¨€ã€‚æŠ€æœ¯å’Œè¯­è¨€æ¥è§¦çš„ä¸å°‘ï¼Œä½†æ˜¯çœŸæ­£æ‹¿ä¸‹çš„å´æ²¡æœ‰ğŸ’”ã€‚iOS RNæ··åˆå¼€å‘ï¼Œsouceryæ¨¡ç‰ˆä»£ç ä½¿ç”¨ï¼Œreduxæ•°æ®æµç§»åŠ¨ç«¯ã€webç«¯å•å…ƒæµ‹è¯•ã€e2eæµ‹è¯•CIæµæ°´çº¿å®ç°dockeré•œåƒã€k8séƒ¨ç½²angularã€reactå‰ç«¯å¼€å‘æŠ€æœ¯wepyã€remaxå°ç¨‹åºå¼€å‘æ¡†æ¶scrapyçˆ¬è™«æ¡†æ¶, mongoDBã€kafkaä½¿ç”¨GraphQL BFFå±‚NestJSå®ç°A/Bå®éªŒå¹³å°å‰åç«¯å¼€å‘ï¼ˆgolangã€mongoDBã€gRPCã€Ng-Alain)DDDé¢†åŸŸé©±åŠ¨è®¾è®¡æ²Ÿé€šå…¬å¸çš„æµç¨‹å…¶å®æ˜¯æˆ‘è¿‡å»æ‰€æœ‰å…¬å¸ä¸­æµç¨‹æœ€å®Œå–„çš„ä¸€å®¶ï¼Œé¡¹ç›®å¼€å§‹éœ€è¦ç»å†-éœ€æ±‚è¯„å®¡-æ•…äº‹ç‚¹è¯„ä¼°-æ’æœŸ-DogFooding-Demoä¼š-ææµ‹-ä¸Šçº¿ï¼Œæ•´å¥—æµç¨‹åœ¨å…¬å¸æ‰§è¡Œçš„ç®—æ˜¯æ¯”è¾ƒå®Œå–„çš„äº†ï¼Œè¿™æ ·å¯ä»¥é¿å…å¯¹å·¥æœŸçš„é¢„ä¼°é”™è¯¯ï¼Œä»¥åŠä¸Šçº¿ä¹‹åæš´éœ²å‡ºå„ç§é—®é¢˜ã€‚ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å‡å°‘å¼€å‘çš„bugç‡å’Œæµ‹è¯•çš„å‹åŠ›ã€‚åœ¨è¿™å®¶å…¬å¸ä¹Ÿæ³¨é‡æ–‡æ¡£çš„ç¼–å†™å’Œé¡¹ç›®è¿›åº¦çš„è·Ÿè¸ªï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æœ‰é—®é¢˜ä¼šåŠæ—¶çš„æŠ›å‡ºï¼Œä¼šè®®ä¹Ÿä¼šæ•¢äºè¡¨è¿°è‡ªå·±çš„çœ‹æ³•ï¼ŒåŒæ—¶æ¯ä¸¤å‘¨ä¼šæœ‰ä¸¾åŠä¸€æ¬¡æŠ€æœ¯åˆ†äº«ï¼Œéƒ½æŒºé”»ç‚¼äººçš„ã€‚æ‰€ä»¥ä»Šå¹´æ–‡æ¡£è¾“å‡ºå’Œè¯­è¨€è¡¨è¾¾èƒ½åŠ›éƒ½æœ‰ä¸€å®šçš„æå‡ã€‚å±•æœ›2020å¹´è™½ç„¶æ¥è§¦çš„ä¸œè¥¿å¤šï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æ·±å…¥äº†è§£ã€‚2021å¹´è¿˜æ˜¯è¦æŒç»­ä¿æŒå­¦ä¹ ï¼Œæå‡æŠ€æœ¯å’Œç¼–ç¨‹æ€æƒ³ï¼Œä¹¦åœ¨ä¸åœä¹°ï¼Œä½†æ˜¯éƒ½æç½®ç€ğŸ˜‚ã€‚åœæ­¢è´­ä¹°æ–°ä¹¦ï¼Œè‡³å°‘å…ˆå°†æ‰‹ä¸Šçš„ä¹¦çœ‹å®Œåˆ·ç®—æ³•é¢˜ï¼Œleetcodeä¸Šä¿æŒæ´»è·ƒåº¦å°Šé‡ç»†èŠ‚ï¼Œå¼€å‘ä¸­é¿å…çŠ¯ä½çº§çš„ç»†èŠ‚é”™è¯¯çœ‹ç›¸å…³æºç ï¼Œæ·±å…¥ç†è§£ç”Ÿæ´»2020å› ä¸ºç–«æƒ…çš„æ¥ä¸´ï¼Œæ„Ÿè§‰è¿‡çš„é£å¿«ï¼Œçœ¨çœ¼å°±è¿æ¥2021ï¼Œæ€»æœ‰ç§é”™è§‰ï¼Œé™¤äº†å·¥ä½œï¼Œè²Œä¼¼2020æ²¡æœ‰ç•™ä¸‹ä»€ä¹ˆæ˜æ˜¾çš„ç—•è¿¹ã€‚ä½†æ˜¯æƒ³æ¥è¿˜æ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼ŒèŠ±å‘—è´¦å•æ¯ä¸ªæœˆå±…é«˜ä¸ä¸‹ï¼ˆä¹Ÿä¸çŸ¥é“ä¹°äº†å•¥ï¼‰ï¼Œåªèƒ½è¯´åœ¨è‡ªå·±èº«ä¸Šçš„æŠ•èµ„è¶Šæ¥è¶Šå¤šäº†ï¼Œå¸Œæœ›è‡ªå·±èƒ½å˜çš„æ›´å¥½å§ã€‚è½¨è¿¹å¹´åå›æ¥é¦–æ¬¡ç»å†çº¿ä¸ŠåŠå…¬ï¼Œåˆšå¼€å§‹è¿˜å¥½ï¼Œä¹…äº†å‘ç°ä¸Šç­æ—¶é—´å…¶å®æ›´é•¿ï¼ˆé‡åˆ°é—®é¢˜æ”¾ä¸ä¸‹ï¼Œä¼šä¸€ç›´èŠ±æ—¶é—´å»è§£å†³ï¼‰ï¼Œç›¸å½“äºæŠŠå·¥ä½œå¸¦è¿›äº†ç”Ÿæ´»å§å¹´ä¸­ä¹‹åå…¬å¸äººå‘˜å¼€å§‹å˜åŠ¨ï¼Œäººå‘˜å·¨å‡ä¹‹åï¼Œè´Ÿé¢æƒ…ç»ªçˆ†æ£šï¼Œåªèƒ½æ…¢æ…¢æ¶ˆåŒ–è·ŸåŒäº‹ç»„ç»‡äº†ä¸€æ¬¡æ¸…è¿œè‡ªé©¾æ¸¸ï¼Œæ¼‚æµå¾ˆå—¨ã€å¾ˆè§£å‹ï¼Œæ¸…è¿œé¸¡å¾ˆå¥½åƒå“ˆå“ˆå›½åº†å¤§å­¦å®¤å‹ç»“å©šï¼ˆåˆå½“äº†ä¸€æ¬¡ä¼´å¨˜ï¼‰ï¼Œå»äº†éƒ‘å·ã€æŸ³å·ï¼Œä½“éªŒäº†ä¸€æŠŠç©ºä¸­é£äººï¼Œè¡Œç¨‹çœŸçš„æ˜¯æ’æ»¡ï¼ˆäººçš„ç²¾åŠ›æ˜¯æ— é™çš„ï¼Œé€¼ä¸€é€¼å°±å‡ºæ¥äº†ï¼‰æ–¥å·¨èµ„åšäº†iclè¿‘è§†æ‰‹æœ¯ï¼Œç»ˆäºæ‘†è„±äº†çœ¼é•œï¼ˆè®¡åˆ’æ˜¯ä¸æˆ´çœ¼é•œä¹‹åä¼šä¿æŒé”»ç‚¼ï¼Œç»“æœä¸äº†äº†ä¹‹ï¼‰æ²‰æµ¸å¼å¯†é€ƒã€å‰§æœ¬æ€ä½“éªŒäº†ä¸€æ¬¡å‰©ä¸‹çš„å°±æ˜¯ä¸å®šæ—¶çš„ktvã€èšé¤äº†æ—…è¡Œä»Šå¹´æ—…è¡Œåªè‡ªé©¾å»äº†ä¸€æ¬¡æ¸…è¿œæ¼‚æµã€æ³¡æ¸©æ³‰ï¼Œæ¯”è¾ƒè¿œçš„å°±è·‘éƒ‘å·ï¼ˆé‡æ¸¸äº†ä¸‹å¤§å­¦ï¼‰ã€èˆé’¢å‚åŠ äº†å©šç¤¼ï¼Œå›äº†ä¸€è¶Ÿå®¶ï¼Œå…¶ä½™æ—¶é—´ä¸€ç›´éƒ½åœ¨æ·±åœ³ä¸¤ç‚¹ä¸€çº¿ç”Ÿæ´»ã€‚æŠ¤ç…§ä¸Šç›–ä¸ªæˆ³çš„è®¡åˆ’æˆåŠŸæ³¡æ±¤äº†ã€‚å­¦ä¹ æ–­æ–­ç»­ç»­ï¼ŒåšæŒä¸äº†å¤šä¹…åˆåœä¸‹äº†ğŸ˜­ï¼Œæ„å¿—åŠ›ä¸€å¦‚æ—¢å¾€çš„è–„å¼±ã€‚æœ¬æ¥è®¡åˆ’è€ƒæ•™èµ„çš„ï¼Œç»“æœæ¯«æ— æ„å¤–å»¶æœŸäº†ï¼Œè¿˜æ²¡å¼€å§‹å°±å·²ç„¶ç»“æŸã€‚ç”Ÿæ´»å±•æœ›å®šå‡ ä¸ªå°ç›®æ ‡ï¼Œè™½ç„¶ä¼šæ‰“è„¸ï¼Œæ¯•ç«Ÿæ¢¦æƒ³è¿˜æ˜¯è¦æœ‰çš„å¤šè¯»ä¹¦å¤šè¯»ä¹¦å¤šè¯»ä¹¦ï¼ˆé‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼‰å¤å­£æ¸¸æ³³è¿˜æ˜¯è¦æŠ“èµ·æ¥çš„è‡³å°‘å¾’æ­¥ä¸€æ¬¡é•¿é€”æ—…æ¸¸è‡³å°‘ä¸€æ¬¡ï¼ˆè®¡åˆ’å»é‡åº†ï¼‰ç©¿è¡£é£æ ¼è¿˜æ˜¯å¯ä»¥æ”¹å˜ä¸€ä¸‹çš„ï¼Œå­¦ä¼šåŒ–å¦†ï¼ˆæ•ˆæœè·Ÿå˜è„¸ä¸€æ ·çš„é‚£ç§ï¼‰é”»ç‚¼ï¼ˆè·‘æ­¥ã€keepéƒ½å¯ï¼‰ä½¿ç”¨äº‘å‡½æ•°å®ç°ä¸€ä¸ªç®€å•çš„å°ç¨‹åºï¼Œå¹¶å‘å¸ƒç»“æŸè¯­ä¸ç®¡æ˜¯å·¥ä½œè¿˜æ˜¯ç”Ÿæ´»ï¼Œåªè¦æœ‰çªç ´ï¼Œå¯¹äºæˆ‘æ¥è¯´å°±æ˜¯æœ‰æ”¶è·çš„ï¼Œandä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†æˆä¸ºæ›´å¥½çš„è‡ªå·±ã€‚","tags":[{"name":"Life","slug":"Life","permalink":"https://orangeschen.cn/tags/Life/"}]},{"title":"Metalå®ç°YUVè½¬RGBæ¸²æŸ“è§†é¢‘","date":"2018-05-08T16:00:00.000Z","path":"metal-yuv-to-rgb.html","text":"æœ¬æ¬¡ä¾‹å­ä½¿ç”¨çš„æ˜¯AVFoundationæä¾›çš„AVCaptureVideoDataOutputè·å–æ¯ä¸€å¸§çš„CVPixelBufferRefï¼Œè¯¦ç»†æ­¥éª¤å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šä¾‹å­ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»Metalä¸­å®ç°YUVè½¬RGBæ ¼å¼çš„ä¸€äº›ä¸»è¦æ­¥éª¤ï¼Œå’ŒOpenGLä¸­çš„æ­¥éª¤å·®ä¸å¤šï¼Œä¸»è¦æ˜¯APIå’Œç€è‰²å™¨ä¸åŒï¼Œæ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œè¿™ç¯‡æ–‡ç« é€‚åˆç†Ÿæ‚‰OpenGLè§†é¢‘æ¸²æŸ“å’Œæœ‰MetalåŸºç¡€çš„äººè§‚çœ‹ï¼Œä»£ç å°±ä¸ä¸€ä¸€æ³¨é‡Šäº†ï¼Œä¸»è¦æ˜¯æœ¬äººç†è§£çš„ä¹Ÿä¸æ˜¯å¾ˆæ·±ï¼Œæ€•è¯¯äººå­å¼Ÿã€‚ï¼ˆç¤ºä¾‹ä»£ç ä¸ºæ¨ªå±æ˜¾ç¤ºï¼Œæ‰€ä»¥çœ‹åˆ°çš„å±å¹•æ˜¯æ¨ªå±æ˜¾ç¤ºï¼‰æºä»£ç ä¸‹è½½åœ°å€1 é¦–å…ˆæ˜¯shaderä¸Šçš„ç‰‡å…ƒç€è‰²å™¨è½¬æ¢YUVåˆ°RGB123456789101112131415161718192021222324252627282930313233343536373839404142#include &lt;metal_stdlib&gt;using namespace metal;#define YUV_SHADER_ARGS VertexOut inFrag [[ stage_in ]],\\texture2d&lt;float&gt; lumaTex [[ texture(0) ]],\\texture2d&lt;float&gt; chromaTex [[ texture(1) ]],\\sampler bilinear [[ sampler(0) ]], \\constant ColorParameters *colorParameters [[ buffer(0) ]]&#x2F;&#x2F; RGBåˆ°YUVçš„è½¬æ¢çŸ©é˜µstruct VertexIn&#123; packed_float3 position; packed_float4 color; packed_float2 st;&#125;;struct VertexOut&#123; float4 position [[position]]; &#x2F;&#x2F;1 float4 color; float2 st;&#125;;struct ColorParameters&#123; float3x3 yuvToRGB;&#125;;vertex VertexOut texture_vertex( const device VertexIn* vertex_array [[ buffer(0) ]], &#x2F;&#x2F;1 unsigned int vid [[ vertex_id ]]) &#123; VertexIn VertexIn &#x3D; vertex_array[vid]; VertexOut VertexOut; VertexOut.position &#x3D; float4(VertexIn.position,1); &#x2F;&#x2F;3 VertexOut.color &#x3D; VertexIn.color; VertexOut.st &#x3D; VertexIn.st; return VertexOut;&#125;fragment half4 yuv_rgb(YUV_SHADER_ARGS)&#123; float3 yuv; yuv.x &#x3D; lumaTex.sample(bilinear, inFrag.st).r; yuv.yz &#x3D; chromaTex.sample(bilinear,inFrag.st).rg - float2(0.5); return half4(half3(colorParameters-&gt;yuvToRGB * yuv),yuv.x);&#125;2 æ·»åŠ çº¹ç†ç¼“å­˜CVMetalTextureCacheRefå’Œçº¹ç†MTLTextureå˜é‡123CVMetalTextureCacheRef _videoTextureCache; id&lt;MTLTexture&gt; _videoTexture[2]; CVPixelBufferRef _pixelBuffer;æ·»åŠ è½¬æ¢çŸ©é˜µçš„æ¥æ”¶å˜é‡1@property (nonatomic, strong) id&lt;MTLBuffer&gt; parametersBuffer;ä»¥ä¸‹å‡ ä¸ªéƒ½æ˜¯YUVè½¬RGBçš„çŸ©é˜µç®—æ³•ï¼Œç»™parametersBufferèµ‹å€¼ï¼Œæ‹·è´åˆ°GPUä¸­è®¡ç®—12345678910111213141516171819202122232425262728293031323334353637383940414243444546_parametersBuffer = [_device newBufferWithLength:sizeof(ColorParameters) * 2 options:MTLResourceOptionCPUCacheModeDefault]; ColorParameters matrix; simd::float3 A; simd::float3 B; simd::float3 C; // 1 // A.x = 1; // A.y = 1; // A.z = 1; // // B.x = 0; // B.y = -0.343; // B.z = 1.765; // // C.x = 1.4; // C.y = -0.765; // C.z = 0; // 2 // A.x = 1.164; // A.y = 1.164; // A.z = 1.164; // // B.x = 0; // B.y = -0.392; // B.z = 2.017; // // C.x = 1.596; // C.y = -0.813; // C.z = 0; // 3 A.x = 1.164; A.y = 1.164; A.z = 1.164; B.x = 0; B.y = -0.231; B.z = 2.112; C.x = 1.793; C.y = -0.533; C.z = 0; matrix.yuvToRGB = simd::float3x3&#123;A, B, C&#125;; memcpy(self.parametersBuffer.contents, &amp;matrix, sizeof(ColorParameters));è·å–æ¯ä¸€å¸§è§†é¢‘ä¿¡æ¯ç”Ÿæˆçº¹ç†çš„ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839- (void)makeYUVTexture:(CVPixelBufferRef)pixelBuffer &#123; CVMetalTextureRef y_texture ; float y_width = CVPixelBufferGetWidthOfPlane(pixelBuffer, 0); float y_height = CVPixelBufferGetHeightOfPlane(pixelBuffer, 0); CVMetalTextureCacheCreateTextureFromImage(kCFAllocatorDefault, _videoTextureCache, pixelBuffer, nil, MTLPixelFormatR8Unorm, y_width, y_height, 0, &amp;y_texture); CVMetalTextureRef uv_texture; float uv_width = CVPixelBufferGetWidthOfPlane(pixelBuffer, 1); float uv_height = CVPixelBufferGetHeightOfPlane(pixelBuffer, 1); CVMetalTextureCacheCreateTextureFromImage(kCFAllocatorDefault, _videoTextureCache, pixelBuffer, nil, MTLPixelFormatRG8Unorm, uv_width, uv_height, 1, &amp;uv_texture); id&lt;MTLTexture&gt; luma = CVMetalTextureGetTexture(y_texture); id&lt;MTLTexture&gt; chroma = CVMetalTextureGetTexture(uv_texture); _videoTexture[0] = luma; _videoTexture[1] = chroma; CVBufferRelease(y_texture); CVBufferRelease(uv_texture);&#125;- (void)display:(CVPixelBufferRef)overlay &#123; if (!overlay) &#123; return; &#125; if (!_videoTextureCache) &#123; NSLog(@\"No video texture cache\"); return; &#125; [self makeYUVTexture:overlay];&#125;- (void)setVideoTexture &#123; CVMetalTextureCacheFlush(_videoTextureCache, 0); CVReturn err = CVMetalTextureCacheCreate(kCFAllocatorDefault, NULL, _device, NULL, &amp;_videoTextureCache); if (err) &#123; NSLog(@\"&gt;&gt; ERROR: Could not create a texture cache\"); assert(0); &#125;&#125;ï¼ˆæœ€åPSï¼š æœ‰å¤§ç¥çŸ¥é“æ€ä¹ˆä½¿ç”¨Metalå®ç°æ¸²æŸ“åˆ°çº¹ç†çš„ä¹ˆï¼Œæ±‚æŒ‡å¯¼ï¼‰","tags":[{"name":"Metal","slug":"Metal","permalink":"https://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"https://orangeschen.cn/tags/iOS/"}]},{"title":"Metalå›¾ç‰‡æ¸²æŸ“","date":"2018-05-08T16:00:00.000Z","path":"metal-draw-picture.html","text":"æœ¬ç« å†…å®¹ä¸»è¦æ˜¯åœ¨ä¸Šä¸€ç¯‡ã€ç»˜åˆ¶ä¸‰è§’å½¢ã€‘çš„åŸºç¡€ä¸Šæ·»åŠ äº†å›¾ç‰‡æ¸²æŸ“çš„åŠŸèƒ½ï¼Œåˆ†åˆ«è¯´æ˜äº†ä½¿ç”¨Metalå’ŒMetalKitä¸­åˆ›å»ºçº¹ç†çš„æ–¹æ³•ã€‚1ã€é¦–å…ˆä¿®æ”¹Metal shaderçš„ç€è‰²é‡Œçš„å†…å®¹æ·»åŠ é¡¶ç‚¹è¾“å…¥å’Œè¾“å‡ºçš„ç»“æ„ä½“123456789101112&#x2F;&#x2F; è¾“å…¥çš„é¡¶ç‚¹å’Œçº¹ç†åæ ‡ struct VertexIn &#123; packed_float3 position; packed_float2 st; &#125;;&#x2F;&#x2F; è¾“å‡ºé¡¶ç‚¹å’Œçº¹ç†åæ ‡ï¼Œå› ä¸ºéœ€è¦æ¸²æŸ“çº¹ç†ï¼Œå¯ä»¥ä¸ç”¨è¾“å…¥é¡¶ç‚¹é¢œè‰² struct VertexOut &#123; float4 position [[position]]; float2 st; &#125;;é¡¶ç‚¹å‡½æ•°å’Œç‰‡æ®µå‡½æ•°å†…å®¹12345678910111213141516&#x2F;&#x2F; æ·»åŠ çº¹ç†é¡¶ç‚¹åæ ‡vertex VertexOut texture_vertex(uint vid[[vertex_id]], const device VertexIn *vertex_array[[buffer(0)]])&#123; VertexOut outVertex; VertexIn vertexIn &#x3D; vertex_array[vid]; outVertex.position &#x3D; float4(vertexIn.position, 1.0); outVertex.st &#x3D; vertexIn.st;&#x2F;&#x2F; outVertex.color &#x3D; color[vid]; return outVertex;&#125;;fragment float4 texture_fragment(VertextInOut inFrag[[stage_in]], texture2d&lt;float&gt; texas[[texture(0)]])&#123; constexpr sampler defaultSampler; float4 rgba &#x3D; texas.sample(defaultSampler, inFrag.st).rgba; return rgba;&#125;;2ã€åŠ è½½å›¾ç‰‡åˆ›å»ºMetalçº¹ç†Metal Frameworkä¸­åœ¨å¤„ç†è´´å›¾ä¸Šä½¿ç”¨CGImageåœ¨CGContextä¸Šdrawçš„æ–¹æ³•æ¥å–å¾—å›¾åƒ, ä½†æ˜¯é€šè¿‡drawæ–¹æ³•ç»˜åˆ¶çš„å›¾åƒæ˜¯ä¸Šä¸‹é¢ å€’çš„ã€‚é¦–å…ˆè¦è¯´çš„æ˜¯ï¼Œåœ¨iOSçš„ä¸åŒframeworkä¸­ä½¿ç”¨ç€ä¸åŒçš„åæ ‡ç³»ï¼šUIKit ï¼ yè½´å‘ä¸‹Core Graphics(Quartz) ï¼ yè½´å‘ä¸ŠOpenGL ES ï¼ yè½´å‘ä¸ŠUIKitæ˜¯iPhone SDKçš„Cocoa Touchå±‚çš„æ ¸å¿ƒframeworkï¼Œæ˜¯iPhoneåº”ç”¨ç¨‹åºå›¾å½¢ç•Œé¢å’Œäº‹ä»¶é©±åŠ¨çš„åŸºç¡€ï¼Œå®ƒå’Œä¼ ç»Ÿwindowsæ¡Œé¢ä¸€æ ·ï¼Œåæ ‡ç³»æ˜¯yè½´å‘ä¸‹çš„; Core Graphics(Quartz)ä¸€ä¸ªåŸºäº2Dçš„å›¾å½¢ç»˜åˆ¶å¼•æ“ï¼Œå®ƒçš„åæ ‡ç³»åˆ™æ˜¯yè½´å‘ä¸Šçš„ï¼›è€ŒOpenGL ESæ˜¯iPhone SDKçš„2Då’Œ3Dç»˜åˆ¶å¼•æ“ï¼Œå®ƒä½¿ç”¨å·¦æ‰‹åæ ‡ç³»ï¼Œå®ƒçš„åæ ‡ç³»ä¹Ÿæ˜¯yè½´å‘ä¸Šçš„ï¼Œå¦‚æœä¸è€ƒè™‘zè½´ï¼Œåœ¨ äºŒç»´ä¸‹å®ƒçš„åæ ‡ç³»å’ŒQuartzæ˜¯ä¸€æ ·çš„ã€‚æ³¨ï¼šä¸çŸ¥é“æ˜¯ä¸æ˜¯APIæ›´æ–°ç­‰åŸå› ï¼Œæœ‰å°ä¼™ä¼´è¯´å›¾ç‰‡å€’ç½®çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œç»è¿‡æµ‹è¯•ï¼Œå‘ç°CGContextDrawImageç»˜åˆ¶çš„å›¾ç‰‡å·²ç»ä¸éœ€è¦å¤„ç†å€’ç½®çš„é—®é¢˜äº†ï¼Œå…·ä½“åŸå› è¿˜æœ‰å¾…è¯å®ï¼Œæˆ–è€…è¯´æˆ‘è¿™äº›è§‚ç‚¹æœ‰è¯¯çš„è¯å¸Œæœ›æœ‰äººèƒ½è¯¦ç»†æŒ‡å‡ºä»¥ä¸‹å†…å®¹å¯ä»¥å¿½ç•¥ğŸ˜†å½“é€šè¿‡CGContextDrawImageç»˜åˆ¶å›¾ç‰‡åˆ°ä¸€ä¸ªcontextä¸­æ—¶ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯UIImageçš„CGImageRefï¼Œå› ä¸ºUIKitå’ŒCGåæ ‡ç³»yè½´ç›¸åï¼Œæ‰€ä»¥å›¾ç‰‡ç»˜åˆ¶å°†ä¼šä¸Šä¸‹é¢ å€’ã€‚è§£å†³æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼Œè§£å†³æ–¹æ³•ä¸€ï¼šåœ¨ç»˜åˆ¶åˆ°contextå‰é€šè¿‡çŸ©é˜µå‚ç›´ç¿»è½¬åæ ‡ç³»è§£å†³æ–¹æ³•äºŒï¼šä½¿ç”¨UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘è§£å†³æ–¹æ³•ä¸‰ï¼šå‚ç›´ç¿»è½¬æŠ•å½±çŸ©é˜µ,è¿™ç§æ–¹æ³•é€šè¿‡è®¾ç½®ä¸Šä¸‹é¢ å€’çš„æŠ•å½±çŸ©é˜µï¼Œä½¿å¾—åŸæœ¬yè½´å‘ä¸Šçš„GLåæ ‡ç³»çœ‹èµ·æ¥å˜æˆäº†yè½´å‘ä¸‹ï¼Œå¹¶ä¸”åæ ‡åŸç‚¹ä»å±å¹•å·¦ä¸‹è§’ç§»åˆ°äº†å±å¹•å·¦ä¸Šè§’ã€‚å¦‚æœä½ ä¹ æƒ¯ä½¿ç”¨yè½´å‘ä¸‹çš„åæ ‡ç³»è¿›è¡ŒäºŒç»´æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒåŒæ—¶åŸæœ¬é¢ å€’çš„å›¾ç‰‡ç»è¿‡å†æ¬¡é¢ å€’åå›åˆ°äº†æ­£ç¡®çš„æ–¹å‘ï¼šæœ¬äººèƒ½åŠ›æœ‰é™ï¼Œå¯¹äºæˆ‘æ¥è¯´çŸ©é˜µçš„å¤„ç†è¿˜æ˜¯æœ‰éš¾åº¦çš„ï¼Œæ‰€ä»¥é€‰æ‹©ç¬¬äºŒç§ç›¸å¯¹ç®€å•ä¸€äº›çš„æ–¹æ³•æ¥è§£å†³å›¾ç‰‡ä¸Šä¸‹é¢ å€’çš„é—®é¢˜ã€‚æ–°å»ºSwiftæ–‡ä»¶ï¼Œå¼•å…¥å¤´æ–‡ä»¶123import Metalimport UIKitimport CoreGraphicsæ·»åŠ å›¾ç‰‡åŠ è½½æ–¹æ³•ï¼Œè°ƒç”¨makeTexture()æ–¹æ³•ç”Ÿæˆçº¹ç†1234567891011121314151617181920212223242526272829303132var type: MTLTextureType!var texture: MTLTexture!// åœ¨å¤„ç†è´´å›¾ä¸Šä½¿ç”¨CGImageåœ¨CGContextä¸Šdrawçš„æ–¹æ³•æ¥å–å¾—å›¾åƒ, ä½†æ˜¯é€šè¿‡drawæ–¹æ³•ç»˜åˆ¶çš„å›¾åƒæ˜¯ä¸Šä¸‹é¢ å€’çš„ï¼Œå¯ä»¥é€šè¿‡UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘ï¼Œç”Ÿæˆçº¹ç†func loadIntoTextureWithDevice(device: MTLDevice, name: String, ext: String) -&gt; Bool &#123; let path = Bundle.main.path(forResource: name, ofType: ext) if !(path != nil) &#123; return false &#125; let image = UIImage(contentsOfFile: path!) let width = (image?.cgImage)!.width let height = (image?.cgImage)!.height let dataSize = width * height * 4 let data = UnsafeMutablePointer&lt;UInt8&gt;.allocate(capacity: dataSize) let colorSpace = CGColorSpaceCreateDeviceRGB() let context = CGContext(data: data, width: width, height: height, bitsPerComponent: 8, bytesPerRow: 4 * width, space: colorSpace, bitmapInfo: CGImageAlphaInfo.premultipliedLast.rawValue); context?.draw((image?.cgImage)!, in: CGRect(x: 0, y: 0, width: CGFloat(width), height: CGFloat(height))) // é€šè¿‡UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘ // ä¸çŸ¥é“æ˜¯ä¸æ˜¯APIæ›´æ–°äº† å·²ç»ä¸éœ€è¦è¿™ä¸€æ­¥å¤„ç†å›¾ç‰‡æ–¹å‘äº† // UIGraphicsPushContext(context!); // image?.draw(in: CGRect(x: 0, y: 0, width: CGFloat(width), height: CGFloat(height))) let textDes = MTLTextureDescriptor.texture2DDescriptor(pixelFormat: .rgba8Unorm, width: Int(width), height: Int(height), mipmapped: false) type = textDes.textureType texture = device.makeTexture(descriptor: textDes) if !(texture != nil) &#123; return false &#125; texture.replace(region: MTLRegionMake2D(0, 0, Int(width), Int(height)), mipmapLevel: 0, withBytes: context!.data!, bytesPerRow: width * 4) // UIGraphicsPopContext() free(data) return true&#125;MetalKit Frameworkåˆ™ç›´æ¥æä¾›äº†MTKTextureLoaderåˆ›å»ºçº¹ç†å¼•å…¥MetalKitå¤´æ–‡ä»¶12import Foundationimport MetalKitMTKTextureLoaderåŠ è½½å›¾ç‰‡åˆ›å»ºçº¹ç†ï¼ŒMTKTextureLoaderä¸­æä¾›äº†å¼‚æ­¥å’ŒåŒæ­¥åŠ è½½çš„æ–¹æ³•1234567891011121314151617181920212223242526272829enum TextureError: Error &#123; case UIImageCreationError case MTKTextureLoaderError&#125;/*----------åˆ›å»ºMetalçº¹ç†-------------- * @param device è®¾å¤‡ * @param name å›¾ç‰‡åç§° * @retun MTLTexture çº¹ç† */func makeTexture(device: MTLDevice, name: String) throws -&gt; MTLTexture &#123; guard let image = UIImage(named: name) else &#123; throw TextureError.UIImageCreationError &#125; // å¤„ç†åçš„å›¾ç‰‡æ˜¯å€’ç½®ï¼Œè¦å…ˆå°†å…¶å€’ç½®è¿‡æ¥æ‰èƒ½æ˜¾ç¤ºå‡ºæ­£å›¾åƒ, æˆ–è€…ä¿®æ”¹çº¹ç†åæ ‡ï¼Œå°†çº¹ç†åæ ‡å·¦ä¸Šè§’è®¾ç½®ä¸º(0,0)ï¼Œè¿™ä¸€æ­¥éª¤å¯ä»¥çœç•¥ let mirrorImage = UIImage(cgImage: (image.cgImage)!, scale: 1, orientation: UIImageOrientation.downMirrored) let scaledImage = UIImage.scaleToSize(mirrorImage, size: image.size) do &#123; let textureLoader = MTKTextureLoader(device: device) let textureLoaderOption:[String: NSNumber] = [ MTKTextureLoaderOptionSRGB: false] // å¼‚æ­¥åŠ è½½ // try textureLoader.newTexture(with: image.cgImage!, options: textureLoaderOption, completionHandler: &#123; (&lt;#MTLTexture?#&gt;, &lt;#Error?#&gt;) in // // &#125;) // åŒæ­¥æ ¹æ®å›¾ç‰‡åˆ›å»ºæ–°çš„Metalçº¹ç† // Synchronously loads image data and creates a new Metal texturefrom a given bitmap image. return try textureLoader.newTexture(with: scaledImage.cgImage!, options: textureLoaderOption) &#125;&#125;123456789 // è‡ªå®šä¹‰UIImageçš„ç±»æ–¹æ³•ï¼Œè®¾ç½®å›¾ç‰‡å¤§å°extension UIImage &#123; class func scaleToSize(_ image: UIImage, size: CGSize)-&gt;UIImage &#123; UIGraphicsBeginImageContext(size) image.draw(in: CGRect(origin: CGPoint.zero, size: size)) let scaledImage = UIGraphicsGetImageFromCurrentImageContext() UIGraphicsEndImageContext() return scaledImage! &#125;3ã€è·å–çº¹ç†åæ ‡ï¼Œæ¸²æŸ“å›¾ç‰‡ä¹‹å‰ç»˜åˆ¶ä¸‰è§’å½¢æ˜¯ä½¿ç”¨é¡¶ç‚¹ç»˜åˆ¶çš„ï¼Œè¿™æ¬¡ä½¿ç”¨ç´¢å¼•ç»˜åˆ¶ä¸€ä¸ªå››è¾¹å½¢ã€‚æ·»åŠ çº¹ç†å±æ€§1var quaTexture: MTLTexture! = nilæ·»åŠ é¡¶ç‚¹buffer1var indexBuffer: MTLBuffer! = nilæ·»åŠ é¡¶ç‚¹å’Œç´¢å¼•æ•°ç»„123456789101112131415 // 3.1 åœ¨CPUåˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„ï¼Œéœ€è¦é€šè¿‡æŠŠå®ƒç§»åŠ¨åˆ°ä¸€ä¸ªMTLBufferï¼Œæ¥å‘é€è¿™äº›æ•°æ®åˆ°GPUã€‚ let vertexData:[Float] = [// 0.0, 1.0, 0.0,// -1.0, -1.0, 0.0,// 1.0, -1.0, 0.0 //position s, t -0.5, -0.5, 0, 0, 0, 0.5, -0.5, 0, 1, 0, 0.5, 0.5, 0, 1, 1, -0.5, 0.5, 0, 0, 1, ] let indices:[Int32] = [ 0, 1, 2, 0, 2, 3 ]åˆ›å»ºä¸€ä¸ªæ–°çš„indexBufferï¼Œå­˜æ”¾ç´¢å¼•æ•°ç»„123 // 3.3 åœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„indexBufferï¼Œå­˜æ”¾ç´¢å¼•æ•°ç»„ï¼Œä»CPUé‡Œè¾“é€data indexBuffer = device.makeBuffer(bytes: indices, length: indices.count * 4, options: MTLResourceOptions(rawValue: UInt(0)))indexBuffer.label = \"Indices\"ç¼–è¯‘shader1234// 6.1 é€šè¿‡è°ƒç”¨device.newDefaultLibraryæ–¹æ³•è·å¾—çš„MTLibraryå¯¹è±¡è®¿é—®åˆ°ä½ é¡¹ç›®ä¸­çš„é¢„ç¼–è¯‘shaders,ç„¶åé€šè¿‡åå­—æ£€ç´¢æ¯ä¸ªshaderlet defaultLibrary = device.newDefaultLibrary() let fragmentProgram = defaultLibrary?.makeFunction(name: \"texture_fragment\")let vertextProgram = defaultLibrary?.makeFunction(name: \"texture_vertex\")åŠ è½½çº¹ç†12345678910111213// åŠ è½½çº¹ç† // 1 ä½¿ç”¨Metal let loaded = loadTntoTextureWithDevice(device: device, name: \"lena\", ext: \"png\") if !loaded &#123; print(\"Failed to load texture\") &#125; quaTexture = texture// 2 ä½¿ç”¨MetalKit do &#123; quaTexture = try makeTexture(device: device, name: \"lena\") &#125; catch &#123; fatalError(\"Error: Can not load texture\") &#125;åœ¨renderæ–¹æ³•ä¸­é…ç½®æ¸²æŸ“å‘½ä»¤ç¼–ç å™¨ï¼Œè°ƒç”¨setFragmentTextureæ·»åŠ çº¹ç†ï¼ŒdrawIndexedPrimitivesæ ¹æ®ç´¢å¼•æ•°ç»„ç»˜åˆ¶å›¾å½¢ã€‚123renderEncoder.setFragmentTexture(quaTexture, at: 0) // æ ¹æ®ç´¢å¼•ç”»å›¾renderEncoder.drawIndexedPrimitives(type: .triangle, indexCount: indices.count, indexType: .uint32, indexBuffer: indexBuffer, indexBufferOffset: 0)æœ€ç»ˆæ•ˆæœå›¾å¦‚å›¾æ‰€ç¤ºï¼Œå¯¹äºè¿™äº›åŸç†çš„ä¸œè¥¿äº†è§£è¿˜ä¸æ˜¯å¾ˆæ·±ï¼Œç½‘ä¸Šçš„èµ„æ–™å¤ªå°‘ï¼Œèƒ½åŠ›æœ‰é™ï¼Œåªèƒ½ç¢ç£¨ä¸€äº›ç®€å•çš„ä¸œè¥¿ã€‚å¦‚æœå¯¹Metalæ„Ÿå…´è¶£çš„å¯ä»¥ä¸‹è½½Metal Swift Demo, GitHubä¸Šå¶ç„¶çœ‹åˆ°åˆ«äººå†™çš„Demoï¼Œé‡Œé¢æœ‰çº¹ç†å’ŒçŸ©é˜µï¼ŒModelIOå’ŒMetalKitçš„ç»“åˆä½¿ç”¨ç­‰ä¾‹å­ã€‚æœ€åçŒ®ä¸ŠDemoä¾‹å­","tags":[{"name":"Metal","slug":"Metal","permalink":"https://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"https://orangeschen.cn/tags/iOS/"}]},{"title":"Metalå…¥é—¨ï¼ˆä½¿ç”¨Metalç”»ä¸€ä¸ªä¸‰è§’å½¢ï¼‰","date":"2018-05-01T16:00:00.000Z","path":"metal-learn-base.html","text":"å­¦ä¹ ä½¿ç”¨è‹¹æœGPUåŠ é€Ÿ3Dç»˜å›¾çš„æ–°API:MetalMetalå’ŒOpenGL ESç›¸ä¼¼ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªåº•å±‚APIï¼Œè´Ÿè´£å’Œ3Dç»˜å›¾ç¡¬ä»¶äº¤äº’ã€‚å®ƒä»¬ä¹‹é—´çš„ä¸åŒåœ¨äºï¼ŒMetalä¸æ˜¯è·¨å¹³å°çš„, Metal æ˜¯ç”¨ Objective-C ç¼– å†™çš„ï¼ŒåŸºäº Foundationï¼Œä½¿ç”¨ GCD åœ¨ CPU å’Œ GPU ä¹‹é—´ä¿æŒåŒæ­¥ã€‚ä¸ä¹‹ç›¸åçš„ï¼Œå®ƒè®¾è®¡çš„åœ¨è‹¹æœç¡¬ä»¶ä¸Šè¿è¡Œå¾—æå…¶é«˜æ•ˆï¼Œä¸OpenGL ESç›¸æ¯”ï¼Œå®ƒæä¾›äº†æ›´å¿«çš„é€Ÿåº¦å’Œæ›´ä½çš„å¼€é”€ã€‚å®ƒæ˜¯ä¸€ä¸ªGPUä¸Šä¸€ä¸ªç®€å•çš„å°è£…ï¼Œæ‰€ä»¥èƒ½å¤Ÿå®Œæˆå‡ ä¹æ‰€æœ‰äº‹æƒ…ï¼Œåƒåœ¨å±å¹•ä¸Šæ¸²æŸ“ä¸€ä¸ªç²¾çµï¼ˆspriteï¼‰æˆ–è€…æ˜¯ä¸€ä¸ª3Dæ¨¡å‹ã€‚ä½†ä½ è¦ç¼–å†™å®Œæˆè¿™äº›äº‹æƒ…çš„æ‰€æœ‰ä»£ç ã€‚è¿™æ ·éº»çƒ¦çš„ä»£ä»·æ˜¯ï¼Œä½ æ‹¥æœ‰äº†GPUçš„åŠ›é‡å’Œæ§åˆ¶ã€‚ä¼˜ç‚¹ï¼š1ã€ä½¿ç¡¬ä»¶è¾¾åˆ°è¿è¡Œæ•ˆç‡çš„å³°å€¼ï¼šå› ä¸ºMetaléå¸¸åº•å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç¡¬ä»¶è¾¾åˆ°è¿è¡Œæ•ˆç‡çš„å³°å€¼ï¼Œå¯¹ä½ çš„æ¸¸æˆå¦‚ä½•è¿è¡Œæœ‰ç€å®Œå…¨çš„æ§åˆ¶ã€‚2ã€è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å­¦ä¹ ç»å†ï¼šå­¦ä¹ Metalæ•™å¯¼ä½ å¾ˆå¤šå…³äº3Dç»˜å›¾ç¼–ç¨‹çš„æ¦‚å¿µï¼Œç¼–å†™ä½ è‡ªå·±çš„æ¸¸æˆå¼•æ“ï¼Œä»¥åŠé«˜å±‚(higher level)æ¸¸æˆæ¡†æ¶å¦‚ä½•è¿ä½œã€‚å…³äºmetalè¯¦ç»†çš„ä»‹ç»å¯å‚è€ƒ:ä»¥ä¸‹æ˜¯ä½¿ç”¨Metalå’ŒSwiftæ¥åˆ›å»ºä¸€ä¸ªæœ‰åŸºæœ¬è„‰ç»œçš„åº”ç”¨ï¼šç”»ä¸€ä¸ªç®€å•çš„ä¸‰è§’å½¢æ³¨æ„ï¼šMetalåº”ç”¨ä¸èƒ½è·‘åœ¨iOSæ¨¡æ‹Ÿå™¨ä¸Šï¼Œå®ƒä»¬éœ€è¦ä¸€ä¸ªè®¾å¤‡ï¼Œè®¾å¤‡ä¸Šè£…è½½ç€è‹¹æœA7èŠ¯ç‰‡æˆ–è€…æ›´æ–°çš„èŠ¯ç‰‡ã€‚æ‰€ä»¥éœ€è¦ä¸€å°è¿™æ ·çš„è®¾å¤‡(iPhone 5S,iPad Air,iPad mini2)æ¥å®Œæˆä»£ç çš„æµ‹è¯•ã€‚æ‰“å¼€Xcode é€šè¿‡iOS\\Application\\Single View Application templateåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚ä½¿ç”¨TriangleSwiftä½œä¸ºé¡¹ç›®åç§°ï¼Œè®¾ç½®å¼€å‘è¯­è¨€ä¸ºSwiftï¼Œè®¾ç½®è®¾å¤‡ä¸ºé€šç”¨è®¾å¤‡(Universal)ã€‚ç‚¹å‡»Nextï¼Œé€‰æ‹©ä¸€ä¸ªç›®å½•ï¼Œç‚¹å‡»Createã€‚æœ‰ä¸ƒä¸ªæ­¥éª¤æ¥è®¾ç½®metalï¼š1 åˆ›å»ºä¸€ä¸ªMTLDevice2 åˆ›å»ºä¸€ä¸ªCAMetalLayer3 åˆ›å»ºä¸€ä¸ªVertex Buffer4 åˆ›å»ºä¸€ä¸ªVertex Shader5 åˆ›å»ºä¸€ä¸ªFragment Shader6 åˆ›å»ºä¸€ä¸ªRender Pipeline7 åˆ›å»ºä¸€ä¸ªCommand Queue1 åˆ›å»ºä¸€ä¸ªMTLDeviceä½¿ç”¨Metalä½ è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è·å–ä¸€ä¸ªMTLDeviceçš„å¼•ç”¨ã€‚ä¸ºäº†å®Œæˆè¿™ç‚¹ï¼Œæ‰“å¼€ViewController.swift å¹¶æ·»åŠ ä¸‹é¢çš„importè¯­å¥1import Metalå¯¼å…¥äº†Metalæ¡†æ¶ï¼Œæ‰€ä»¥ä½ èƒ½å¤Ÿä½¿ç”¨Metalçš„ç±»ï¼ˆåƒè¿™æ–‡ä»¶ä¸­çš„MTLDeviceï¼‰ã€‚æ¥ç€ï¼Œåœ¨ViewControllerç±»ä¸­æ·»åŠ ä»¥ä¸‹å±æ€§ï¼šåœ¨viewDidLoadå‡½æ•°å†…åˆå§‹åŒ–è¿™ä¸ªå±æ€§12// 1ã€åˆ›å»ºä¸€ä¸ªMTLDevice, ä½ å¯ä»¥æŠŠä¸€ä¸ªMTLDeviceæƒ³è±¡æˆæ˜¯ä½ å’ŒCPUçš„ç›´æ¥è¿æ¥ã€‚ä½ å°†é€šè¿‡ä½¿ç”¨MTLDeviceåˆ›å»ºæ‰€æœ‰å…¶ä»–ä½ éœ€è¦çš„Metalå¯¹è±¡ï¼ˆåƒæ˜¯command queuesï¼Œbuffersï¼Œtexturesï¼‰ã€‚var device: MTLDevice! = nil2 åˆ›å»ºä¸€ä¸ªCAMetalLayeråœ¨iOSé‡Œï¼Œä½ åœ¨å±å¹•ä¸Šçœ‹è§çš„æ‰€æœ‰ä¸œè¥¿ï¼Œè¢«ä¸€ä¸ªCALayeræ‰€æ‰¿è½½ã€‚å­˜åœ¨ä¸åŒç‰¹æ•ˆçš„CALayerçš„å­ç±»ï¼Œæ¯”å¦‚ï¼šæ¸å˜å±‚(gradient layers)ã€å½¢çŠ¶å±‚ï¼ˆshapelayersï¼‰ã€é‡å¤å±‚(replicator layers) ç­‰ç­‰ã€‚å¦‚æœä½ æƒ³è¦ç”¨Metalåœ¨å±å¹•ä¸Šç”»ä¸€äº›ä¸œè¥¿ï¼Œä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªç‰¹åˆ«çš„CALayerå­ç±»ï¼ŒCAMetalLayerã€‚å› ä¸ºCAMetalLayeræ˜¯QuartzCoreæ¡†æ¶çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯Metalæ¡†æ¶é‡Œçš„ï¼Œé¦–å…ˆåœ¨è¿™ä¸ªæ–‡ä»¶çš„ä¸Šæ–¹æ·»åŠ importè¯­å¥1import QuartzCoreæŠŠæ–°å±æ€§æ·»åŠ åˆ°ç±»ä¸­ï¼š12// 2ã€åˆ›å»ºä¸€ä¸ªCAMetalLayervar metalLayer: CAMetalLayer! = nilè®¾ç½®metalLayer123456789101112131415// 2.1 åˆ›å»ºCAMetalLayermetalLayer = CAMetalLayer()// 2.2 å¿…é¡»æ˜ç¡®layerä½¿ç”¨çš„MTLDeviceï¼Œç®€å•åœ°è®¾ç½®æ—©å‰è·å–çš„devicemetalLayer.device = device// 2.3 æŠŠåƒç´ æ ¼å¼ï¼ˆpixel formatï¼‰è®¾ç½®ä¸ºBGRA8Unormï¼Œå®ƒä»£è¡¨\"8å­—èŠ‚ä»£è¡¨è“è‰²ã€ç»¿è‰²ã€çº¢è‰²å’Œé€æ˜åº¦ï¼Œé€šè¿‡åœ¨0åˆ°1ä¹‹é—´å•ä½åŒ–çš„å€¼æ¥è¡¨ç¤º\"ã€‚è¿™æ¬¡ä¸¤ç§ç”¨åœ¨CAMetalLayerçš„åƒç´ æ ¼å¼ä¹‹ä¸€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½ è¿™æ ·å†™å°±å¯ä»¥äº†ã€‚metalLayer.pixelFormat = .bgra8Unorm// 2.4 è‹¹æœé¼“åŠ±å°†framebufferOnlyè®¾ç½®ä¸ºtrueï¼Œæ¥å¢å¼ºè¡¨ç°æ•ˆç‡ã€‚é™¤éä½ éœ€è¦å¯¹ä»layerç”Ÿæˆçš„çº¹ç†ï¼ˆtexturesï¼‰å–æ ·ï¼Œæˆ–è€…ä½ éœ€è¦åœ¨layerç»˜å›¾çº¹ç†(drawable textures)æ¿€æ´»ä¸€äº›è®¡ç®—å†…æ ¸ï¼Œå¦åˆ™ä½ ä¸éœ€è¦è®¾ç½®ã€‚ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä½ ä¸ç”¨è®¾ç½®ï¼‰metalLayer.framebufferOnly = true// 2.5 æŠŠlayerçš„frameè®¾ç½®ä¸ºviewçš„framemetalLayer.frame = view.layer.framevar drawableSize = self.view.bounds.sizedrawableSize.width *= self.view.contentScaleFactordrawableSize.height *= self.view.contentScaleFactormetalLayer.drawableSize = drawableSizeview.layer.addSublayer(metalLayer)3 åˆ›å»ºä¸€ä¸ªVertex Bufferåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºã€‚åœ¨ä½ çš„ç±»ä¸­æ·»åŠ ä¸‹åˆ—çš„å¸¸é‡å±æ€§12345678// 3ã€åˆ›å»ºä¸€ä¸ªVertex Buffervar vertexBuffer: MTLBuffer! = nil// 3.1 åœ¨CPUåˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„ï¼Œéœ€è¦é€šè¿‡æŠŠå®ƒç§»åŠ¨åˆ°ä¸€ä¸ªMTLBufferï¼Œæ¥å‘é€è¿™äº›æ•°æ®åˆ°GPUã€‚let vertexData:[Float] = [ 0.0, 1.0, 0.0, -1.0, -1.0, 0.0, 1.0, -1.0, 0.0]åœ¨MTLDeviceä¸Šè°ƒç”¨makeBuffer(bytes:, length:, options:)ï¼Œåœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„bufferï¼Œä»CPUé‡Œè¾“é€dataã€‚optionsä¸èƒ½ä¸ºç©ºã€‚1234// 3.2 è·å–vertex dataçš„å­—èŠ‚å¤§å°ã€‚ä½ é€šè¿‡æŠŠå…ƒç´ çš„å¤§å°å’Œæ•°ç»„å…ƒç´ ä¸ªæ•°ç›¸ä¹˜æ¥å¾—åˆ°let dataSize = vertexData.count * 4// 3.3 åœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„bufferï¼Œä»CPUé‡Œè¾“é€datavertexBuffer = device.makeBuffer(bytes: vertexData, length: dataSize, options: MTLResourceOptions(rawValue: UInt(0)))4 åˆ›å»ºä¸€ä¸ªVertex Shaderä½ ä¹‹å‰åˆ›å»ºçš„é¡¶ç‚¹å°†æˆä¸ºæ¥ä¸‹æ¥å†™çš„ä¸€ä¸ªå«vertext shaderçš„å°ç¨‹åºçš„è¾“å…¥ã€‚ä¸€ä¸ªvertex shader æ˜¯ä¸€ä¸ªåœ¨GPUä¸Šè¿è¡Œçš„å°ç¨‹åºï¼Œå®ƒç”±åƒc++çš„ä¸€é—¨è¯­è¨€ç¼–å†™ï¼Œé‚£é—¨è¯­è¨€å«åšMetal Shading Languageã€‚ä¸€ä¸ªvertex shaderè¢«æ¯ä¸ªé¡¶ç‚¹è°ƒç”¨ï¼Œå®ƒçš„å·¥ä½œæ˜¯æ¥å—é¡¶ç‚¹çš„ä¿¡æ¯ï¼ˆå¦‚ï¼šä½ç½®å’Œé¢œè‰²ã€çº¹ç†åæ ‡ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ½œåœ¨çš„ä¿®æ­£ä½ç½®ï¼ˆå¯èƒ½è¿˜æœ‰åˆ«çš„ç›¸å…³ä¿¡æ¯ï¼‰ç‚¹å‡»File\\New\\Fileï¼Œé€‰æ‹©iOS\\Source\\Metal Fileï¼Œç„¶åç‚¹å‡»Nextã€‚è¾“å…¥Shader.metalä½œä¸ºæ–‡ä»¶åï¼Œç„¶åç‚¹å‡»Createã€‚1234567891011121314// ä¸€ä¸ªvertex shaderè¢«æ¯ä¸ªé¡¶ç‚¹è°ƒç”¨ï¼Œå®ƒçš„å·¥ä½œæ˜¯æ¥å—é¡¶ç‚¹çš„ä¿¡æ¯ï¼ˆå¦‚ï¼šä½ç½®å’Œé¢œè‰²ã€çº¹ç†åæ ‡ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ½œåœ¨çš„ä¿®æ­£ä½ç½®ï¼ˆå¯èƒ½è¿˜æœ‰åˆ«çš„ç›¸å…³ä¿¡æ¯ï¼‰#include &lt;metal_stdlib&gt;using namespace metal;/** * 1ã€æ‰€æœ‰çš„vertex shaderså¿…é¡»ä»¥å…³é”®å­—vertexå¼€å¤´ã€‚å‡½æ•°å¿…é¡»è‡³å°‘è¿”å›é¡¶ç‚¹çš„æœ€ç»ˆä½ç½®â€”â€”ä½ é€šè¿‡æŒ‡å®šfloat4ï¼ˆä¸€ä¸ªå…ƒç´ ä¸º4ä¸ªæµ®ç‚¹æ•°çš„å‘é‡ï¼‰ã€‚ç„¶åä½ ç»™ä¸€ä¸ªåå­—ç»™vetex shaderï¼Œä»¥åä½ å°†ç”¨è¿™ä¸ªåå­—æ¥è®¿é—®è¿™ä¸ªvertex shaderã€‚ * 2ã€vertex shaderä¼šæ¥å—ä¸€ä¸ªåå«vertex_idçš„å±æ€§çš„ç‰¹å®šå‚æ•°ï¼Œå®ƒæ„å‘³ç€å®ƒä¼šè¢«vertexæ•°ç»„é‡Œç‰¹å®šçš„é¡¶ç‚¹æ‰€è£…å…¥ã€‚ * 3ã€ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå…ƒç´ ä¸ºpacked_float4(ä¸€ä¸ªå‘é‡åŒ…å«4ä¸ªæµ®ç‚¹æ•°)çš„æ•°ç»„çš„æŒ‡é’ˆï¼Œå¦‚ï¼šæ¯ä¸ªé¡¶ç‚¹çš„ä½ç½®ã€‚è¿™ä¸ª [[ ... ]] è¯­æ³•è¢«ç”¨åœ¨å£°æ˜é‚£äº›èƒ½è¢«ç”¨ä½œç‰¹å®šé¢å¤–ä¿¡æ¯çš„å±æ€§ï¼Œåƒæ˜¯èµ„æºä½ç½®ï¼Œshaderè¾“å…¥ï¼Œå†…å»ºå˜é‡ã€‚è¿™é‡Œä½ æŠŠè¿™ä¸ªå‚æ•°ç”¨ [[ buffer(0) ]] æ ‡è®°ï¼Œæ¥æŒ‡æ˜è¿™ä¸ªå‚æ•°å°†ä¼šè¢«åœ¨ä½ ä»£ç ä¸­ä½ å‘é€åˆ°ä½ çš„vertex shaderçš„ç¬¬ä¸€å—buffer dataæ‰€éå†ã€‚ * 4ã€åŸºäºvertex idæ¥æ£€ç´¢vertexæ•°ç»„ä¸­å¯¹åº”ä½ç½®çš„vertexå¹¶æŠŠå®ƒè¿”å›ã€‚å‘é‡å¿…é¡»ä¸ºä¸€ä¸ªfloat4ç±»å‹vertex float4 basic_vertex ( constant packed_float3* vertex_array[[buffer(0)]], unsigned int vid[[vertex_id]])&#123; return float4(vertex_array[vid], 1.0);&#125; */5 åˆ›å»ºä¸€ä¸ªFragment Shaderå®Œæˆvertex shaderåï¼Œå¦ä¸€ä¸ªshaderï¼Œå®ƒè¢«æ¯ä¸ªåœ¨å±å¹•ä¸Šçš„fragment(think pixel)è°ƒç”¨ï¼Œå®ƒå°±æ˜¯fragment shaderã€‚fragment shaderé€šè¿‡å†…æ’(interpolating)vertex shaderçš„è¾“å‡ºæ¥è·å¾—è‡ªå·±çš„è¾“å…¥ã€‚1234567/* 1. æ‰€æœ‰fragment shaderså¿…é¡»ä»¥fragmentå…³é”®å­—å¼€å§‹ã€‚è¿™ä¸ªå‡½æ•°å¿…é¡»è‡³å°‘è¿”å›fragmentçš„æœ€ç»ˆé¢œè‰²â€”â€”ä½ é€šè¿‡æŒ‡å®šhalf4ï¼ˆä¸€ä¸ªé¢œè‰²çš„RGBAå€¼ï¼‰æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚æ³¨æ„ï¼Œhalf4æ¯”float4åœ¨å†…å­˜ä¸Šæ›´æœ‰æ•ˆç‡ï¼Œå› ä¸ºï¼Œä½ å†™å…¥äº†æ›´å°‘çš„GPUå†…å­˜ã€‚ 2. è¿™é‡Œä½ è¿”å›(0.6,0.6,0.6,0.6)çš„é¢œè‰²ï¼Œä¹Ÿå°±æ˜¯ç°è‰²ã€‚ */fragment half4 basic_fragment() &#123; return half4(0.6);&#125;6 åˆ›å»ºä¸€ä¸ªRender Pipelineç°åœ¨ä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªvertex shaderå’Œä¸€ä¸ªfragment shaderï¼Œä½ éœ€è¦ç»„åˆå®ƒä»¬ï¼ˆåŠ ä¸Šä¸€äº›é…ç½®æ•°æ®ï¼‰åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒåå«render pipelineã€‚Metalçš„æ¸²æŸ“å™¨ï¼ˆshadersï¼‰æ˜¯é¢„ç¼–è¯‘çš„ï¼Œrender pipeline é…ç½®ä¼šåœ¨ä½ ç¬¬ä¸€æ¬¡è®¾ç½®å®ƒçš„æ—¶å€™è¢«ç¼–è¯‘ï¼Œæ‰€ä»¥æ‰€æœ‰äº‹æƒ…éƒ½æå…¶é«˜æ•ˆã€‚é¦–å…ˆåœ¨ViewController.swifté‡Œæ·»åŠ ä¸€ä¸ªå±æ€§ï¼š12// 6ã€åˆ›å»ºä¸€ä¸ªRender Pipelinevar pipelineState: MTLRenderPipelineState! = nilåœ¨viewDidLoadæ–¹æ³•æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š12345678// 6.1 é€šè¿‡è°ƒç”¨device.newDefaultLibraryæ–¹æ³•è·å¾—çš„MTLibraryå¯¹è±¡è®¿é—®åˆ°ä½ é¡¹ç›®ä¸­çš„é¢„ç¼–è¯‘shaders,ç„¶åé€šè¿‡åå­—æ£€ç´¢æ¯ä¸ªshader let defaultLibrary = device.newDefaultLibrary() let fragmentProgram = defaultLibrary?.makeFunction(name: \"basic_fragment\") let vertextProgram = defaultLibrary?.makeFunction(name: \"basic_vertex\") // 6.2 è¿™é‡Œè®¾ç½®ä½ çš„render pipelineã€‚å®ƒåŒ…å«ä½ æƒ³è¦ä½¿ç”¨çš„shadersã€é¢œè‰²é™„ä»¶ï¼ˆcolor attachmentï¼‰çš„åƒç´ æ ¼å¼(pixel format)ã€‚ï¼ˆä¾‹å¦‚ï¼šä½ æ¸²æŸ“åˆ°çš„è¾“å…¥ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯CAMetalLayerï¼‰ let pipelineStateDescriptor = MTLRenderPipelineDescriptor() pipelineStateDescriptor.vertexFunction = vertextProgram pipelineStateDescriptor.fragmentFunction = fragmentProgram pipelineStateDescriptor.colorAttachments[0].pixelFormat = .bgra8Unorm7 åˆ›å»ºä¸€ä¸ªCommand Queueä½ éœ€è¦åšçš„æœ€ç»ˆçš„è®¾ç½®æ­¥éª¤ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªMTLCommandQueueã€‚æŠŠè¿™ä¸ªæƒ³è±¡æˆæ˜¯ä¸€ä¸ªåˆ—è¡¨è£…è½½ç€ä½ å‘Šè¯‰GPUä¸€æ¬¡è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¦åˆ›å»ºä¸€ä¸ªcommand queueï¼Œç®€å•åœ°æ·»åŠ ä¸€ä¸ªå±æ€§ï¼š12// 7ã€åˆ›å»ºä¸€ä¸ªCommand Queuevar commandQueue: MTLCommandQueue! = nilæŠŠä¸‹é¢è¿™è¡Œæ·»åŠ åˆ°viewDidLoadä¸­ï¼š12// 7.1 åˆå§‹åŒ–commandQueuecommandQueue = device.makeCommandQueue()é¢„è®¾ç½®çš„ä»£ç åˆ°è¿™é‡Œå®Œæˆäº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ¸²æŸ“ä¸‰è§’å½¢äº†ï¼Œå®ƒå°†éœ€è¦åœ¨äº”ä¸ªæ­¥éª¤æ¥å®Œæˆï¼š1 åˆ›å»ºä¸€ä¸ªDisplay linkã€‚2 åˆ›å»ºä¸€ä¸ªRender Pass Descriptor3 åˆ›å»ºä¸€ä¸ªCommand Buffer4 åˆ›å»ºä¸€ä¸ªRender Command Encoder5 æäº¤Command Bufferçš„å†…å®¹æ³¨æ„ï¼šç†è®ºä¸Šè¿™ä¸ªåº”ç”¨å®é™…ä¸Šä¸éœ€è¦æ¯å¸§æ¸²æŸ“ï¼Œå› ä¸ºä¸‰è§’å½¢è¢«ç»˜åˆ¶ä¹‹åä¸ä¼šåŠ¨ã€‚ä½†æ˜¯ï¼Œå¤§éƒ¨åˆ†åº”ç”¨ä¼šæœ‰ç‰©ä½“çš„ç§»åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šé‚£æ ·åšã€‚1 åˆ›å»ºä¸€ä¸ªDisplay linkåœ¨iOSå¹³å°ä¸Šï¼Œé€šè¿‡CADisplayLink ç±»ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå‡½æ•°åœ¨æ¯æ¬¡è®¾å¤‡å±å¹•åˆ·æ–°çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œè¿™æ ·ä½ å°±å¯ä»¥é‡ç»˜å±å¹•ã€‚ä¸ºäº†ä½¿ç”¨å®ƒï¼Œåœ¨ç±»é‡Œæ·»åŠ ä¸€ä¸ªæ–°çš„å±æ€§ï¼š12// 8ã€åˆ›å»ºä¸€ä¸ªDisplay Linkvar timer: CADisplayLink! = nilåˆå§‹åŒ–timer123// 8.1 åˆå§‹åŒ– timerï¼Œè®¾ç½®timerï¼Œè®©å®ƒæ¯æ¬¡åˆ·æ–°å±å¹•çš„æ—¶å€™è°ƒç”¨ä¸€ä¸ªåå«drawloopçš„æ–¹æ³•timer = CADisplayLink(target: self, selector: #selector(ViewController.drawloop))timer.add(to: RunLoop.main, forMode: RunLoopMode.defaultRunLoopMode)æ¸²æŸ“çš„ä»£ç åœ¨render()ä¸­å®ç°12345678func render() &#123; //TODO&#125;func drawloop() &#123; self.render() &#125;2 åˆ›å»ºä¸€ä¸ªRender Pass Descriptor123456789// metal layerä¸Šè°ƒç”¨nextDrawable() ï¼Œå®ƒä¼šè¿”å›ä½ éœ€è¦ç»˜åˆ¶åˆ°å±å¹•ä¸Šçš„çº¹ç†(texture)let drawable = metalLayer.nextDrawable()// 8ã€åˆ›å»ºä¸€ä¸ªRender Pass Descriptorï¼Œé…ç½®ä»€ä¹ˆçº¹ç†ä¼šè¢«æ¸²æŸ“åˆ°ã€clear colorï¼Œä»¥åŠå…¶ä»–çš„é…ç½®let renderPassDesciptor = MTLRenderPassDescriptor()renderPassDesciptor.colorAttachments[0].texture = drawable?.texture// è®¾ç½®load actionä¸ºclearï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç»˜åˆ¶ä¹‹å‰ï¼ŒæŠŠçº¹ç†æ¸…ç©ºrenderPassDesciptor.colorAttachments[0].loadAction = .clear// ç»˜åˆ¶çš„èƒŒæ™¯é¢œè‰²è®¾ç½®ä¸ºç»¿è‰²renderPassDesciptor.colorAttachments[0].clearColor = MTLClearColorMake(0.0, 0.8, 0.5, 1.0)3 åˆ›å»ºä¸€ä¸ªCommand Bufferä¸€ä¸ªcommand bufferåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¸²æŸ“æŒ‡ä»¤ï¼ˆrender commandsï¼‰ã€‚123// 9ã€åˆ›å»ºä¸€ä¸ªCommand Buffer// ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡ä¸ºä¸€ç³»åˆ—è¿™ä¸€å¸§æƒ³è¦æ‰§è¡Œçš„æ¸²æŸ“å‘½ä»¤ã€‚æ³¨æ„åœ¨ä½ æäº¤command bufferä¹‹å‰ï¼Œæ²¡æœ‰äº‹æƒ…ä¼šçœŸæ­£å‘ç”Ÿï¼Œè¿™æ ·ç»™ä½ å¯¹äº‹ç‰©åœ¨ä½•æ—¶å‘ç”Ÿæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ§åˆ¶ã€‚let commandBuffer = commandQueue.makeCommandBuffer()4 åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å‘½ä»¤ç¼–ç å™¨(Render Command Encoder)12345678910111213141516// 10ã€åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å‘½ä»¤ç¼–ç å™¨(Render Command Encoder) // åˆ›å»ºä¸€ä¸ªcommand encoderï¼Œå¹¶æŒ‡å®šä½ ä¹‹å‰åˆ›å»ºçš„pipelineå’Œé¡¶ç‚¹ let renderEncoder = commandBuffer.makeRenderCommandEncoder(descriptor: renderPassDesciptor) renderEncoder.setRenderPipelineState(pipelineState) renderEncoder.setVertexBuffer(vertexBuffer, offset: 0, at: 0) /** ç»˜åˆ¶å›¾å½¢ - parameter type: ç”»ä¸‰è§’å½¢ - parameter vertexStart: ä»vertex buffer ä¸‹æ ‡ä¸º0çš„é¡¶ç‚¹å¼€å§‹ - parameter vertexCount: é¡¶ç‚¹æ•° - parameter instanceCount: æ€»å…±æœ‰1ä¸ªä¸‰è§’å½¢ */ renderEncoder.drawPrimitives(type: .triangle, vertexStart: 0, vertexCount: 3, instanceCount: 1) // å®Œæˆåï¼Œè°ƒç”¨endEncoding() renderEncoder.endEncoding()5 æäº¤Command Buffer1234// ä¿è¯æ–°çº¹ç†ä¼šåœ¨ç»˜åˆ¶å®Œæˆåç«‹å³å‡ºç°commandBuffer.present(drawable!)// æäº¤äº‹åŠ¡(transaction), æŠŠä»»åŠ¡äº¤ç»™GPUcommandBuffer.commit()å­¦ä¹ èµ„æ–™â€¢ è‹¹æœMetalå¼€å‘è€…æ–‡æ¡£ï¼Œæœ‰å¾ˆå¤šæ–‡æ¡£ã€å½•åƒã€æ ·ä¾‹ä»£ç çš„é“¾æ¥ã€‚â€¢ è‹¹æœçš„Metalç¼–ç¨‹æŒ‡å¯¼â€¢ è‹¹æœçš„Metal Shading Language æŒ‡å¯¼â€¢ WWDC2014 Metalå½•åƒ","tags":[{"name":"Metal","slug":"Metal","permalink":"https://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"https://orangeschen.cn/tags/iOS/"}]},{"title":"iOS-private-api-checkerç§æœ‰APIæ£€æµ‹å·¥å…·ä½¿ç”¨è¯¦ç»†æ­¥éª¤","date":"2018-04-01T16:00:00.000Z","path":"private-api-checker.html","text":"iOS-private-api-checkerç§æœ‰APIæ£€æŸ¥è¯¦ç»†æ­¥éª¤ï¼ˆæ¶‰åŠåˆ° Pythonã€Flaskã€sqlite ç¯å¢ƒï¼‰1ã€ä¸‹è½½iOS-private-api-checker-master https://github.com/hustcc/iOS-private-api-checker2ã€ä¸‹è½½å·²ç»buildå¥½çš„ios_private.dbåº“(æœ¬äººèƒ½åŠ›æœ‰é™ï¼Œä¸ä¼šbuildï¼Œè¿™ä¸ªæ˜¯å¤§ç¥buildå¥½çš„ï¼Œsdk7.0ç‰ˆæœ¬ï¼Œä¸æ˜¯æœ€æ–°çš„ï¼Œæ‰€ä»¥æœ‰äº›ç§æœ‰åº“æŸ¥ä¸å‡ºæ¥(PS: æˆ–è€…æœ‰äº›å·²ç»å…¬å¼€çš„åº“æ£€æµ‹ä¸ºç§æœ‰åº“ï¼ï¼è¯¦æƒ…è¯·çœ‹ä¸Šé¢çš„é“¾æ¥ï¼Œgithubä¸Šæœ‰æ•™ç¨‹ï¼Œå†™è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³å°è¯•ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå‡†ç¡®æ€§ä¸æ•¢ä¿è¯)ï¼Œgithubä¸Šæœ‰æ•™ç¨‹ï¼Œæœ‰èƒ½åŠ›çš„å¯ä»¥è‡ªå·±build^^)ï¼Œå°† ios_private.db æ”¾å…¥åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œä¸»è¦ä¿®æ”¹å¯å†™æƒé™ï¼›ï¼ˆå¤‡æ³¨ï¼šios_private.db ä¸‹è½½åœ°å€ï¼š é“¾æ¥: https://pan.baidu.com/s/1d7YlSa å¯†ç : fimxï¼‰3ã€åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª tmp ç›®å½•ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼Œæ³¨æ„ä¿®æ”¹å¯å†™æƒé™ï¼‰ï¼Œæˆ–è€…å°†tmpçš„æ–‡ä»¶å¤¹çš„æƒé™è®¾ç½®ä¸º777ï¼Œå…ˆè¿›terminalï¼Œç„¶åè¾“å…¥Wallyçš„å‘½ä»¤ï¼Œåé¢æ·»åŠ ä½ çš„ç›®å½•åã€‚1sudo chmod -R 777 ç›®å½•å4ã€åœ¨ç»ˆç«¯è¾“å…¥sqlite3 , å‡ºç°è¿™ä¸ªè¡¨ç¤ºå·²ç»å®‰è£…äº†sqliteï¼Œæ²¡æœ‰åˆ™å‚è€ƒ http://www.runoob.com/sqlite/sqlite-installation.html è¿›è¡Œå®‰è£…å®‰è£…sqlite5ã€é…ç½®flaskç¯å¢ƒ5.1 Macç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…å¥½äº†Python 2.75.2 å®‰è£…pythonçš„åŒ…ç®¡ç†å™¨pip ï¼Œå…ˆä¸‹è½½ get-pip.py ï¼š https://bootstrap.pypa.io/get-pip.pyæ‰§è¡Œå®‰è£…å‘½ä»¤1sudo python get-pip.py5.3 å®‰è£…virtualenvï¼Œvirtualenv ä¸ºæ¯ä¸ªä¸åŒé¡¹ç›®æä¾›ä¸€ä»½ Python å®‰è£…ã€‚å®ƒå¹¶æ²¡æœ‰çœŸæ­£å®‰è£…å¤šä¸ª Python å‰¯æœ¬ï¼Œä½†æ˜¯å®ƒç¡®å®æä¾›äº†ä¸€ç§å·§å¦™çš„æ–¹å¼æ¥è®©å„é¡¹ç›®ç¯å¢ƒä¿æŒç‹¬ç«‹ã€‚1sudo pip install virtualenv5.4 å¼€å§‹é…ç½®flaskç¯å¢ƒ1234567891011è¿›åˆ°é¡¹ç›®ç›®å½•$ cd é¡¹ç›®è·¯å¾„åˆ›å»ºflaskæ–‡ä»¶å¤¹$ virtualenv flask$ cd flaskæ¿€æ´»ç¯å¢ƒ$ source bin/activateå®‰è£…flask$ pip install flaskå›åˆ°æ ¹ç›®å½•$ cd -6 ã€å®‰è£… macholib1pip install macholib7ã€æœ€åè¿è¡Œ run_webï¼ˆæˆ–è€… ï¼‰1python run_web.pyåœ¨æµè§ˆå™¨ä¸­è¾“å…¥127.0.0.1:9527 å°†ipaæ‹–å…¥ä¸Šä¼ æ¡†ç­‰å¾…å³å¯çœ‹åˆ°æ£€æŸ¥ç»“æœ","tags":[{"name":"iOS","slug":"iOS","permalink":"https://orangeschen.cn/tags/iOS/"}]},{"title":"Hello World","date":"2017-11-08T13:40:40.000Z","path":"hello-world.html","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.Quick StartCreate a new post1$ hexo new \"My New Post\"More info: WritingRun server1$ hexo serverMore info: ServerGenerate static files1$ hexo generateMore info: GeneratingDeploy to remote sites1$ hexo deployMore info: Deployment","tags":[]}]