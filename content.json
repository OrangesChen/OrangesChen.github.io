[{"title":"2020æ€»ç»“ï½œå†™ç»™2021çš„è‡ªå·±","date":"2021-05-16T13:40:40.000Z","path":"2021/05/16/life/review-2020/","text":"å°±æŒºç§ƒç„¶çš„ï¼Œå…»ç”Ÿå£å·å–Šèµ·æ¥ï¼Œé˜²æ­¢çˆ†è‚ğŸ˜­ å¼•è¨€2020æ˜¯ç‰¹æ®Šçš„ä¸€å¹´ï¼Œåœ°ç‹±å¼€ç«¯ï¼Œâ€˜æ´»ç€å°±å¥½â€™æˆäº†2020çš„slogonï¼Œæœç„¶ä»Šå¹´æ³¨å®šæ˜¯ä¸å¹³å‡¡çš„ä¸€å¹´ã€‚çœ‹å¤§å®¶åˆ°å¹´åº•æ€»ä¼šå†™ä¸€ä¸‹å¹´åº¦æ€»ç»“ï¼Œæƒ³äº†æƒ³ï¼Œè‡ªå·±ç°åœ¨çš„è®°å¿†åŠ›æ˜¯åœ¨é€æ¸è¡°å‡ï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦è®°å½•ä¸€ä¸‹è¿™ä¸€å¹´å‘ç”Ÿçš„äº‹æƒ…ï¼Œä»¥æ­¤æ¥é­ç­–ä»¥åçš„è‡ªå·±ã€‚ å·¥ä½œå…ˆæ€»ç»“å·¥ä½œå§ï¼Œå·¥ä½œæ˜¯2020ä¸€æ•´å¹´çš„å¤§å¤´ã€‚2019å¹´11æœˆ12æ—¥åŠ å…¥çš„ç°åœ¨è¿™å®¶å…¬å¸ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œæœ¬æ¥æ˜¯ä½œä¸ºiOSå¼€å‘è¿›æ¥çš„ï¼Œç»“æœtitleæ˜¯å¤§å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œemmmm è¿™å…¶å®ä¹Ÿè¿˜å¥½ï¼Œæ¯•ç«Ÿè‡ªå·±å½“åˆä¹Ÿæ˜¯æƒ³è¶æœºäº†è§£äº†è§£å‰ç«¯çš„æŠ€æœ¯ã€‚å…¬å¸å‰æœŸå·¥ä½œæ°›å›´è¿˜æ˜¯å¾ˆæ„‰å¿«çš„ï¼ŒåŒäº‹éƒ½å¾ˆæœ‰è¶£ï¼Œå¼¹æ€§å·¥ä½œåˆ¶ï¼Œè™½ç„¶æ¯å¤©å·¥ä½œæ—¶é•¿éƒ½10ä¸ªå°æ—¶ä»¥ä¸Šï¼Œå¤§å°å‘¨ï¼Œå¹¶æ²¡æœ‰è§‰å¾—ç–²æƒ«ï¼Œåè€Œè§‰å¾—å¾ˆå……å®ã€‚ç›´åˆ°2020å¹´åï¼Œäººå‘˜å¼€å§‹å˜åŠ¨ï¼Œä¹‹å‰ä¸€ç›´åœ¨åšçš„appé¡¹ç›®ä¹Ÿç»ˆæ­¢äº†ã€‚å¼€å§‹è½¬æ‰‹å°ç¨‹åºå’Œå‰ç«¯å¼€å‘ï¼Œæ‘¸ç´¢åˆ°6æœˆä»½æ—¶ï¼Œäººå‘˜å†æ¬¡å‘ç”Ÿå˜åŠ¨ï¼Œå°ç»„å¼€å§‹è½¬å‘å·¥ç¨‹æ•ˆèƒ½è¿™å—ï¼Œä¸»è¦åšäº›åŸºå»ºç±»çš„å·¥ä½œï¼Œåç»­ä¹Ÿä¸»è¦åœ¨ç»´æŠ¤å‰ç«¯é¡¹ç›®å’Œè¿­ä»£éœ€æ±‚ä¸Šï¼Œä¸­é€”è¿˜æ¥æ‰‹äº†pythonçˆ¬è™«çš„å·¥ä½œå†…å®¹ã€‚è¿™ä¸€å¹´åªèƒ½è¯´æŠ€æœ¯æ·±åº¦å€’æ²¡å•¥å˜åŒ–ï¼Œå¹¿åº¦å€’æ˜¯æœ‰ä¸€å®šçš„æ‰©å±•äº†ã€‚åœ¨å…¬å¸çš„è§’è‰²æ„Ÿè§‰å°±æ˜¯ä¸€å—ç –ï¼Œå“ªé‡Œéœ€è¦å»å“ªé‡Œï¼Œæœ‰ç‚¹æ™•å¤´è½¬å‘ã€‚ æŠ€æœ¯2020ç®—æ˜¯ç»™æˆ‘æ‰“å¼€äº†æ–°å¤§é—¨å§ï¼Œæ¥è§¦åˆ°äº†å¾ˆå¤šæ–°çš„æŠ€æœ¯ï¼Œæ–°è¯­è¨€ã€‚æŠ€æœ¯å’Œè¯­è¨€æ¥è§¦çš„ä¸å°‘ï¼Œä½†æ˜¯çœŸæ­£æ‹¿ä¸‹çš„å´æ²¡æœ‰ğŸ’”ã€‚ iOS RNæ··åˆå¼€å‘ï¼Œsouceryæ¨¡ç‰ˆä»£ç ä½¿ç”¨ï¼Œreduxæ•°æ®æµ ç§»åŠ¨ç«¯ã€webç«¯å•å…ƒæµ‹è¯•ã€e2eæµ‹è¯• CIæµæ°´çº¿å®ç° dockeré•œåƒã€k8séƒ¨ç½² angularã€reactå‰ç«¯å¼€å‘æŠ€æœ¯ wepyã€remaxå°ç¨‹åºå¼€å‘æ¡†æ¶ scrapyçˆ¬è™«æ¡†æ¶, mongoDBã€kafkaä½¿ç”¨ GraphQL BFFå±‚NestJSå®ç° A/Bå®éªŒå¹³å°å‰åç«¯å¼€å‘ï¼ˆgolangã€mongoDBã€gRPCã€Ng-Alain) DDDé¢†åŸŸé©±åŠ¨è®¾è®¡ æ²Ÿé€šå…¬å¸çš„æµç¨‹å…¶å®æ˜¯æˆ‘è¿‡å»æ‰€æœ‰å…¬å¸ä¸­æµç¨‹æœ€å®Œå–„çš„ä¸€å®¶ï¼Œé¡¹ç›®å¼€å§‹éœ€è¦ç»å†-éœ€æ±‚è¯„å®¡-æ•…äº‹ç‚¹è¯„ä¼°-æ’æœŸ-DogFooding-Demoä¼š-ææµ‹-ä¸Šçº¿ï¼Œæ•´å¥—æµç¨‹åœ¨å…¬å¸æ‰§è¡Œçš„ç®—æ˜¯æ¯”è¾ƒå®Œå–„çš„äº†ï¼Œè¿™æ ·å¯ä»¥é¿å…å¯¹å·¥æœŸçš„é¢„ä¼°é”™è¯¯ï¼Œä»¥åŠä¸Šçº¿ä¹‹åæš´éœ²å‡ºå„ç§é—®é¢˜ã€‚ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å‡å°‘å¼€å‘çš„bugç‡å’Œæµ‹è¯•çš„å‹åŠ›ã€‚åœ¨è¿™å®¶å…¬å¸ä¹Ÿæ³¨é‡æ–‡æ¡£çš„ç¼–å†™å’Œé¡¹ç›®è¿›åº¦çš„è·Ÿè¸ªï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æœ‰é—®é¢˜ä¼šåŠæ—¶çš„æŠ›å‡ºï¼Œä¼šè®®ä¹Ÿä¼šæ•¢äºè¡¨è¿°è‡ªå·±çš„çœ‹æ³•ï¼ŒåŒæ—¶æ¯ä¸¤å‘¨ä¼šæœ‰ä¸¾åŠä¸€æ¬¡æŠ€æœ¯åˆ†äº«ï¼Œéƒ½æŒºé”»ç‚¼äººçš„ã€‚æ‰€ä»¥ä»Šå¹´æ–‡æ¡£è¾“å‡ºå’Œè¯­è¨€è¡¨è¾¾èƒ½åŠ›éƒ½æœ‰ä¸€å®šçš„æå‡ã€‚ å±•æœ›2020å¹´è™½ç„¶æ¥è§¦çš„ä¸œè¥¿å¤šï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æ·±å…¥äº†è§£ã€‚2021å¹´è¿˜æ˜¯è¦æŒç»­ä¿æŒå­¦ä¹ ï¼Œæå‡æŠ€æœ¯å’Œç¼–ç¨‹æ€æƒ³ï¼Œä¹¦åœ¨ä¸åœä¹°ï¼Œä½†æ˜¯éƒ½æç½®ç€ğŸ˜‚ã€‚ åœæ­¢è´­ä¹°æ–°ä¹¦ï¼Œè‡³å°‘å…ˆå°†æ‰‹ä¸Šçš„ä¹¦çœ‹å®Œ åˆ·ç®—æ³•é¢˜ï¼Œleetcodeä¸Šä¿æŒæ´»è·ƒåº¦ å°Šé‡ç»†èŠ‚ï¼Œå¼€å‘ä¸­é¿å…çŠ¯ä½çº§çš„ç»†èŠ‚é”™è¯¯ çœ‹ç›¸å…³æºç ï¼Œæ·±å…¥ç†è§£ ç”Ÿæ´»2020å› ä¸ºç–«æƒ…çš„æ¥ä¸´ï¼Œæ„Ÿè§‰è¿‡çš„é£å¿«ï¼Œçœ¨çœ¼å°±è¿æ¥2021ï¼Œæ€»æœ‰ç§é”™è§‰ï¼Œé™¤äº†å·¥ä½œï¼Œè²Œä¼¼2020æ²¡æœ‰ç•™ä¸‹ä»€ä¹ˆæ˜æ˜¾çš„ç—•è¿¹ã€‚ä½†æ˜¯æƒ³æ¥è¿˜æ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼ŒèŠ±å‘—è´¦å•æ¯ä¸ªæœˆå±…é«˜ä¸ä¸‹ï¼ˆä¹Ÿä¸çŸ¥é“ä¹°äº†å•¥ï¼‰ï¼Œåªèƒ½è¯´åœ¨è‡ªå·±èº«ä¸Šçš„æŠ•èµ„è¶Šæ¥è¶Šå¤šäº†ï¼Œå¸Œæœ›è‡ªå·±èƒ½å˜çš„æ›´å¥½å§ã€‚ è½¨è¿¹ å¹´åå›æ¥é¦–æ¬¡ç»å†çº¿ä¸ŠåŠå…¬ï¼Œåˆšå¼€å§‹è¿˜å¥½ï¼Œä¹…äº†å‘ç°ä¸Šç­æ—¶é—´å…¶å®æ›´é•¿ï¼ˆé‡åˆ°é—®é¢˜æ”¾ä¸ä¸‹ï¼Œä¼šä¸€ç›´èŠ±æ—¶é—´å»è§£å†³ï¼‰ï¼Œç›¸å½“äºæŠŠå·¥ä½œå¸¦è¿›äº†ç”Ÿæ´»å§ å¹´ä¸­ä¹‹åå…¬å¸äººå‘˜å¼€å§‹å˜åŠ¨ï¼Œäººå‘˜å·¨å‡ä¹‹åï¼Œè´Ÿé¢æƒ…ç»ªçˆ†æ£šï¼Œåªèƒ½æ…¢æ…¢æ¶ˆåŒ– è·ŸåŒäº‹ç»„ç»‡äº†ä¸€æ¬¡æ¸…è¿œè‡ªé©¾æ¸¸ï¼Œæ¼‚æµå¾ˆå—¨ã€å¾ˆè§£å‹ï¼Œæ¸…è¿œé¸¡å¾ˆå¥½åƒå“ˆå“ˆ å›½åº†å¤§å­¦å®¤å‹ç»“å©šï¼ˆåˆå½“äº†ä¸€æ¬¡ä¼´å¨˜ï¼‰ï¼Œå»äº†éƒ‘å·ã€æŸ³å·ï¼Œä½“éªŒäº†ä¸€æŠŠç©ºä¸­é£äººï¼Œè¡Œç¨‹çœŸçš„æ˜¯æ’æ»¡ï¼ˆäººçš„ç²¾åŠ›æ˜¯æ— é™çš„ï¼Œé€¼ä¸€é€¼å°±å‡ºæ¥äº†ï¼‰ æ–¥å·¨èµ„åšäº†iclè¿‘è§†æ‰‹æœ¯ï¼Œç»ˆäºæ‘†è„±äº†çœ¼é•œï¼ˆè®¡åˆ’æ˜¯ä¸æˆ´çœ¼é•œä¹‹åä¼šä¿æŒé”»ç‚¼ï¼Œç»“æœä¸äº†äº†ä¹‹ï¼‰ æ²‰æµ¸å¼å¯†é€ƒã€å‰§æœ¬æ€ä½“éªŒäº†ä¸€æ¬¡ å‰©ä¸‹çš„å°±æ˜¯ä¸å®šæ—¶çš„ktvã€èšé¤äº† æ—…è¡Œä»Šå¹´æ—…è¡Œåªè‡ªé©¾å»äº†ä¸€æ¬¡æ¸…è¿œæ¼‚æµã€æ³¡æ¸©æ³‰ï¼Œæ¯”è¾ƒè¿œçš„å°±è·‘éƒ‘å·ï¼ˆé‡æ¸¸äº†ä¸‹å¤§å­¦ï¼‰ã€èˆé’¢å‚åŠ äº†å©šç¤¼ï¼Œå›äº†ä¸€è¶Ÿå®¶ï¼Œå…¶ä½™æ—¶é—´ä¸€ç›´éƒ½åœ¨æ·±åœ³ä¸¤ç‚¹ä¸€çº¿ç”Ÿæ´»ã€‚æŠ¤ç…§ä¸Šç›–ä¸ªæˆ³çš„è®¡åˆ’æˆåŠŸæ³¡æ±¤äº†ã€‚ å­¦ä¹ æ–­æ–­ç»­ç»­ï¼ŒåšæŒä¸äº†å¤šä¹…åˆåœä¸‹äº†ğŸ˜­ï¼Œæ„å¿—åŠ›ä¸€å¦‚æ—¢å¾€çš„è–„å¼±ã€‚æœ¬æ¥è®¡åˆ’è€ƒæ•™èµ„çš„ï¼Œç»“æœæ¯«æ— æ„å¤–å»¶æœŸäº†ï¼Œè¿˜æ²¡å¼€å§‹å°±å·²ç„¶ç»“æŸã€‚ ç”Ÿæ´»å±•æœ›å®šå‡ ä¸ªå°ç›®æ ‡ï¼Œè™½ç„¶ä¼šæ‰“è„¸ï¼Œæ¯•ç«Ÿæ¢¦æƒ³è¿˜æ˜¯è¦æœ‰çš„ å¤šè¯»ä¹¦å¤šè¯»ä¹¦å¤šè¯»ä¹¦ï¼ˆé‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼‰ å¤å­£æ¸¸æ³³è¿˜æ˜¯è¦æŠ“èµ·æ¥çš„ è‡³å°‘å¾’æ­¥ä¸€æ¬¡ é•¿é€”æ—…æ¸¸è‡³å°‘ä¸€æ¬¡ï¼ˆè®¡åˆ’å»é‡åº†ï¼‰ ç©¿è¡£é£æ ¼è¿˜æ˜¯å¯ä»¥æ”¹å˜ä¸€ä¸‹çš„ï¼Œå­¦ä¼šåŒ–å¦†ï¼ˆæ•ˆæœè·Ÿå˜è„¸ä¸€æ ·çš„é‚£ç§ï¼‰ é”»ç‚¼ï¼ˆè·‘æ­¥ã€keepéƒ½å¯ï¼‰ ä½¿ç”¨äº‘å‡½æ•°å®ç°ä¸€ä¸ªç®€å•çš„å°ç¨‹åºï¼Œå¹¶å‘å¸ƒ ç»“æŸè¯­ä¸ç®¡æ˜¯å·¥ä½œè¿˜æ˜¯ç”Ÿæ´»ï¼Œåªè¦æœ‰çªç ´ï¼Œå¯¹äºæˆ‘æ¥è¯´å°±æ˜¯æœ‰æ”¶è·çš„ï¼Œandä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†æˆä¸ºæ›´å¥½çš„è‡ªå·±ã€‚","tags":[{"name":"Life","slug":"Life","permalink":"http://orangeschen.cn/tags/Life/"}]},{"title":"Metalå®ç°YUVè½¬RGBæ¸²æŸ“è§†é¢‘","date":"2018-05-08T16:00:00.000Z","path":"2018/05/09/metal-yuv-to-rgb/","text":"æœ¬æ¬¡ä¾‹å­ä½¿ç”¨çš„æ˜¯AVFoundationæä¾›çš„AVCaptureVideoDataOutputè·å–æ¯ä¸€å¸§çš„CVPixelBufferRefï¼Œè¯¦ç»†æ­¥éª¤å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šä¾‹å­ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»Metalä¸­å®ç°YUVè½¬RGBæ ¼å¼çš„ä¸€äº›ä¸»è¦æ­¥éª¤ï¼Œå’ŒOpenGLä¸­çš„æ­¥éª¤å·®ä¸å¤šï¼Œä¸»è¦æ˜¯APIå’Œç€è‰²å™¨ä¸åŒï¼Œæ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œè¿™ç¯‡æ–‡ç« é€‚åˆç†Ÿæ‚‰OpenGLè§†é¢‘æ¸²æŸ“å’Œæœ‰MetalåŸºç¡€çš„äººè§‚çœ‹ï¼Œä»£ç å°±ä¸ä¸€ä¸€æ³¨é‡Šäº†ï¼Œä¸»è¦æ˜¯æœ¬äººç†è§£çš„ä¹Ÿä¸æ˜¯å¾ˆæ·±ï¼Œæ€•è¯¯äººå­å¼Ÿã€‚ï¼ˆç¤ºä¾‹ä»£ç ä¸ºæ¨ªå±æ˜¾ç¤ºï¼Œæ‰€ä»¥çœ‹åˆ°çš„å±å¹•æ˜¯æ¨ªå±æ˜¾ç¤ºï¼‰æºä»£ç ä¸‹è½½åœ°å€ 1 é¦–å…ˆæ˜¯shaderä¸Šçš„ç‰‡å…ƒç€è‰²å™¨è½¬æ¢YUVåˆ°RGB123456789101112131415161718192021222324252627282930313233343536373839404142#include &lt;metal_stdlib&gt;using namespace metal;#define YUV_SHADER_ARGS VertexOut inFrag [[ stage_in ]],\\texture2d&lt;float&gt; lumaTex [[ texture(0) ]],\\texture2d&lt;float&gt; chromaTex [[ texture(1) ]],\\sampler bilinear [[ sampler(0) ]], \\constant ColorParameters *colorParameters [[ buffer(0) ]]&#x2F;&#x2F; RGBåˆ°YUVçš„è½¬æ¢çŸ©é˜µstruct VertexIn&#123; packed_float3 position; packed_float4 color; packed_float2 st;&#125;;struct VertexOut&#123; float4 position [[position]]; &#x2F;&#x2F;1 float4 color; float2 st;&#125;;struct ColorParameters&#123; float3x3 yuvToRGB;&#125;;vertex VertexOut texture_vertex( const device VertexIn* vertex_array [[ buffer(0) ]], &#x2F;&#x2F;1 unsigned int vid [[ vertex_id ]]) &#123; VertexIn VertexIn &#x3D; vertex_array[vid]; VertexOut VertexOut; VertexOut.position &#x3D; float4(VertexIn.position,1); &#x2F;&#x2F;3 VertexOut.color &#x3D; VertexIn.color; VertexOut.st &#x3D; VertexIn.st; return VertexOut;&#125;fragment half4 yuv_rgb(YUV_SHADER_ARGS)&#123; float3 yuv; yuv.x &#x3D; lumaTex.sample(bilinear, inFrag.st).r; yuv.yz &#x3D; chromaTex.sample(bilinear,inFrag.st).rg - float2(0.5); return half4(half3(colorParameters-&gt;yuvToRGB * yuv),yuv.x);&#125; 2 æ·»åŠ çº¹ç†ç¼“å­˜CVMetalTextureCacheRefå’Œçº¹ç†MTLTextureå˜é‡123CVMetalTextureCacheRef _videoTextureCache; id&lt;MTLTexture&gt; _videoTexture[2]; CVPixelBufferRef _pixelBuffer; æ·»åŠ è½¬æ¢çŸ©é˜µçš„æ¥æ”¶å˜é‡ 1@property (nonatomic, strong) id&lt;MTLBuffer&gt; parametersBuffer; ä»¥ä¸‹å‡ ä¸ªéƒ½æ˜¯YUVè½¬RGBçš„çŸ©é˜µç®—æ³•ï¼Œç»™parametersBufferèµ‹å€¼ï¼Œæ‹·è´åˆ°GPUä¸­è®¡ç®— 12345678910111213141516171819202122232425262728293031323334353637383940414243444546_parametersBuffer &#x3D; [_device newBufferWithLength:sizeof(ColorParameters) * 2 options:MTLResourceOptionCPUCacheModeDefault]; ColorParameters matrix; simd::float3 A; simd::float3 B; simd::float3 C; &#x2F;&#x2F; 1 &#x2F;&#x2F; A.x &#x3D; 1; &#x2F;&#x2F; A.y &#x3D; 1; &#x2F;&#x2F; A.z &#x3D; 1; &#x2F;&#x2F; &#x2F;&#x2F; B.x &#x3D; 0; &#x2F;&#x2F; B.y &#x3D; -0.343; &#x2F;&#x2F; B.z &#x3D; 1.765; &#x2F;&#x2F; &#x2F;&#x2F; C.x &#x3D; 1.4; &#x2F;&#x2F; C.y &#x3D; -0.765; &#x2F;&#x2F; C.z &#x3D; 0; &#x2F;&#x2F; 2 &#x2F;&#x2F; A.x &#x3D; 1.164; &#x2F;&#x2F; A.y &#x3D; 1.164; &#x2F;&#x2F; A.z &#x3D; 1.164; &#x2F;&#x2F; &#x2F;&#x2F; B.x &#x3D; 0; &#x2F;&#x2F; B.y &#x3D; -0.392; &#x2F;&#x2F; B.z &#x3D; 2.017; &#x2F;&#x2F; &#x2F;&#x2F; C.x &#x3D; 1.596; &#x2F;&#x2F; C.y &#x3D; -0.813; &#x2F;&#x2F; C.z &#x3D; 0; &#x2F;&#x2F; 3 A.x &#x3D; 1.164; A.y &#x3D; 1.164; A.z &#x3D; 1.164; B.x &#x3D; 0; B.y &#x3D; -0.231; B.z &#x3D; 2.112; C.x &#x3D; 1.793; C.y &#x3D; -0.533; C.z &#x3D; 0; matrix.yuvToRGB &#x3D; simd::float3x3&#123;A, B, C&#125;; memcpy(self.parametersBuffer.contents, &amp;matrix, sizeof(ColorParameters)); è·å–æ¯ä¸€å¸§è§†é¢‘ä¿¡æ¯ç”Ÿæˆçº¹ç†çš„ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839- (void)makeYUVTexture:(CVPixelBufferRef)pixelBuffer &#123; CVMetalTextureRef y_texture ; float y_width &#x3D; CVPixelBufferGetWidthOfPlane(pixelBuffer, 0); float y_height &#x3D; CVPixelBufferGetHeightOfPlane(pixelBuffer, 0); CVMetalTextureCacheCreateTextureFromImage(kCFAllocatorDefault, _videoTextureCache, pixelBuffer, nil, MTLPixelFormatR8Unorm, y_width, y_height, 0, &amp;y_texture); CVMetalTextureRef uv_texture; float uv_width &#x3D; CVPixelBufferGetWidthOfPlane(pixelBuffer, 1); float uv_height &#x3D; CVPixelBufferGetHeightOfPlane(pixelBuffer, 1); CVMetalTextureCacheCreateTextureFromImage(kCFAllocatorDefault, _videoTextureCache, pixelBuffer, nil, MTLPixelFormatRG8Unorm, uv_width, uv_height, 1, &amp;uv_texture); id&lt;MTLTexture&gt; luma &#x3D; CVMetalTextureGetTexture(y_texture); id&lt;MTLTexture&gt; chroma &#x3D; CVMetalTextureGetTexture(uv_texture); _videoTexture[0] &#x3D; luma; _videoTexture[1] &#x3D; chroma; CVBufferRelease(y_texture); CVBufferRelease(uv_texture);&#125;- (void)display:(CVPixelBufferRef)overlay &#123; if (!overlay) &#123; return; &#125; if (!_videoTextureCache) &#123; NSLog(@&quot;No video texture cache&quot;); return; &#125; [self makeYUVTexture:overlay];&#125;- (void)setVideoTexture &#123; CVMetalTextureCacheFlush(_videoTextureCache, 0); CVReturn err &#x3D; CVMetalTextureCacheCreate(kCFAllocatorDefault, NULL, _device, NULL, &amp;_videoTextureCache); if (err) &#123; NSLog(@&quot;&gt;&gt; ERROR: Could not create a texture cache&quot;); assert(0); &#125;&#125; #ï¼ˆæœ€åPSï¼š æœ‰å¤§ç¥çŸ¥é“æ€ä¹ˆä½¿ç”¨Metalå®ç°æ¸²æŸ“åˆ°çº¹ç†çš„ä¹ˆï¼Œæ±‚æŒ‡å¯¼ï¼‰","tags":[{"name":"Metal","slug":"Metal","permalink":"http://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"http://orangeschen.cn/tags/iOS/"}]},{"title":"Metalå›¾ç‰‡æ¸²æŸ“","date":"2018-05-08T16:00:00.000Z","path":"2018/05/09/metal-draw-picture/","text":"æœ¬ç« å†…å®¹ä¸»è¦æ˜¯åœ¨ä¸Šä¸€ç¯‡ç»˜åˆ¶ä¸‰è§’å½¢çš„åŸºç¡€ä¸Šæ·»åŠ äº†å›¾ç‰‡æ¸²æŸ“çš„åŠŸèƒ½ï¼Œåˆ†åˆ«è¯´æ˜äº†ä½¿ç”¨Metalå’ŒMetalKitä¸­åˆ›å»ºçº¹ç†çš„æ–¹æ³•ã€‚ 1ã€é¦–å…ˆä¿®æ”¹Metal shaderçš„ç€è‰²é‡Œçš„å†…å®¹ æ·»åŠ é¡¶ç‚¹è¾“å…¥å’Œè¾“å‡ºçš„ç»“æ„ä½“123456789101112&#x2F;&#x2F; è¾“å…¥çš„é¡¶ç‚¹å’Œçº¹ç†åæ ‡ struct VertexIn &#123; packed_float3 position; packed_float2 st; &#125;;&#x2F;&#x2F; è¾“å‡ºé¡¶ç‚¹å’Œçº¹ç†åæ ‡ï¼Œå› ä¸ºéœ€è¦æ¸²æŸ“çº¹ç†ï¼Œå¯ä»¥ä¸ç”¨è¾“å…¥é¡¶ç‚¹é¢œè‰² struct VertexOut &#123; float4 position [[position]]; float2 st; &#125;; é¡¶ç‚¹å‡½æ•°å’Œç‰‡æ®µå‡½æ•°å†…å®¹12345678910111213141516&#x2F;&#x2F; æ·»åŠ çº¹ç†é¡¶ç‚¹åæ ‡vertex VertexOut texture_vertex(uint vid[[vertex_id]], const device VertexIn *vertex_array[[buffer(0)]])&#123; VertexOut outVertex; VertexIn vertexIn &#x3D; vertex_array[vid]; outVertex.position &#x3D; float4(vertexIn.position, 1.0); outVertex.st &#x3D; vertexIn.st;&#x2F;&#x2F; outVertex.color &#x3D; color[vid]; return outVertex;&#125;;fragment float4 texture_fragment(VertextInOut inFrag[[stage_in]], texture2d&lt;float&gt; texas[[texture(0)]])&#123; constexpr sampler defaultSampler; float4 rgba &#x3D; texas.sample(defaultSampler, inFrag.st).rgba; return rgba;&#125;; 2ã€åŠ è½½å›¾ç‰‡åˆ›å»ºMetalçº¹ç† Metal Frameworkä¸­åœ¨å¤„ç†è´´å›¾ä¸Šä½¿ç”¨CGImageåœ¨CGContextä¸Šdrawçš„æ–¹æ³•æ¥å–å¾—å›¾åƒ, ä½†æ˜¯é€šè¿‡drawæ–¹æ³•ç»˜åˆ¶çš„å›¾åƒæ˜¯ä¸Šä¸‹é¢ å€’çš„ã€‚ é¦–å…ˆè¦è¯´çš„æ˜¯ï¼Œåœ¨iOSçš„ä¸åŒframeworkä¸­ä½¿ç”¨ç€ä¸åŒçš„åæ ‡ç³»ï¼š UIKit ï¼ yè½´å‘ä¸‹Core Graphics(Quartz) ï¼ yè½´å‘ä¸ŠOpenGL ES ï¼ yè½´å‘ä¸ŠUIKitæ˜¯iPhone SDKçš„Cocoa Touchå±‚çš„æ ¸å¿ƒframeworkï¼Œæ˜¯iPhoneåº”ç”¨ç¨‹åºå›¾å½¢ç•Œé¢å’Œäº‹ä»¶é©±åŠ¨çš„åŸºç¡€ï¼Œå®ƒå’Œä¼ ç»Ÿwindowsæ¡Œé¢ä¸€æ ·ï¼Œåæ ‡ç³»æ˜¯yè½´å‘ä¸‹çš„; Core Graphics(Quartz)ä¸€ä¸ªåŸºäº2Dçš„å›¾å½¢ç»˜åˆ¶å¼•æ“ï¼Œå®ƒçš„åæ ‡ç³»åˆ™æ˜¯yè½´å‘ä¸Šçš„ï¼›è€ŒOpenGL ESæ˜¯iPhone SDKçš„2Då’Œ3Dç»˜åˆ¶å¼•æ“ï¼Œå®ƒä½¿ç”¨å·¦æ‰‹åæ ‡ç³»ï¼Œå®ƒçš„åæ ‡ç³»ä¹Ÿæ˜¯yè½´å‘ä¸Šçš„ï¼Œå¦‚æœä¸è€ƒè™‘zè½´ï¼Œåœ¨ äºŒç»´ä¸‹å®ƒçš„åæ ‡ç³»å’ŒQuartzæ˜¯ä¸€æ ·çš„ã€‚ æ³¨ï¼šä¸çŸ¥é“æ˜¯ä¸æ˜¯APIæ›´æ–°ç­‰åŸå› ï¼Œæœ‰å°ä¼™ä¼´è¯´å›¾ç‰‡å€’ç½®çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œç»è¿‡æµ‹è¯•ï¼Œå‘ç°CGContextDrawImageç»˜åˆ¶çš„å›¾ç‰‡å·²ç»ä¸éœ€è¦å¤„ç†å€’ç½®çš„é—®é¢˜äº†ï¼Œå…·ä½“åŸå› è¿˜æœ‰å¾…è¯å®ï¼Œæˆ–è€…è¯´æˆ‘è¿™äº›è§‚ç‚¹æœ‰è¯¯çš„è¯å¸Œæœ›æœ‰äººèƒ½è¯¦ç»†æŒ‡å‡º ä»¥ä¸‹å†…å®¹å¯ä»¥å¿½ç•¥ğŸ˜†å½“é€šè¿‡CGContextDrawImageç»˜åˆ¶å›¾ç‰‡åˆ°ä¸€ä¸ªcontextä¸­æ—¶ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯UIImageçš„CGImageRefï¼Œå› ä¸ºUIKitå’ŒCGåæ ‡ç³»yè½´ç›¸åï¼Œæ‰€ä»¥å›¾ç‰‡ç»˜åˆ¶å°†ä¼šä¸Šä¸‹é¢ å€’ã€‚è§£å†³æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼Œè§£å†³æ–¹æ³•ä¸€ï¼šåœ¨ç»˜åˆ¶åˆ°contextå‰é€šè¿‡çŸ©é˜µå‚ç›´ç¿»è½¬åæ ‡ç³»è§£å†³æ–¹æ³•äºŒï¼šä½¿ç”¨UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘è§£å†³æ–¹æ³•ä¸‰ï¼šå‚ç›´ç¿»è½¬æŠ•å½±çŸ©é˜µ,è¿™ç§æ–¹æ³•é€šè¿‡è®¾ç½®ä¸Šä¸‹é¢ å€’çš„æŠ•å½±çŸ©é˜µï¼Œä½¿å¾—åŸæœ¬yè½´å‘ä¸Šçš„GLåæ ‡ç³»çœ‹èµ·æ¥å˜æˆäº†yè½´å‘ä¸‹ï¼Œå¹¶ä¸”åæ ‡åŸç‚¹ä»å±å¹•å·¦ä¸‹è§’ç§»åˆ°äº†å±å¹•å·¦ä¸Šè§’ã€‚å¦‚æœä½ ä¹ æƒ¯ä½¿ç”¨yè½´å‘ä¸‹çš„åæ ‡ç³»è¿›è¡ŒäºŒç»´æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒåŒæ—¶åŸæœ¬é¢ å€’çš„å›¾ç‰‡ç»è¿‡å†æ¬¡é¢ å€’åå›åˆ°äº†æ­£ç¡®çš„æ–¹å‘ï¼š æœ¬äººèƒ½åŠ›æœ‰é™ï¼Œå¯¹äºæˆ‘æ¥è¯´çŸ©é˜µçš„å¤„ç†è¿˜æ˜¯æœ‰éš¾åº¦çš„ï¼Œæ‰€ä»¥é€‰æ‹©ç¬¬äºŒç§ç›¸å¯¹ç®€å•ä¸€äº›çš„æ–¹æ³•æ¥è§£å†³å›¾ç‰‡ä¸Šä¸‹é¢ å€’çš„é—®é¢˜ã€‚ æ–°å»ºSwiftæ–‡ä»¶ï¼Œå¼•å…¥å¤´æ–‡ä»¶123import Metalimport UIKitimport CoreGraphics æ·»åŠ å›¾ç‰‡åŠ è½½æ–¹æ³•ï¼Œè°ƒç”¨makeTexture()æ–¹æ³•ç”Ÿæˆçº¹ç†1234567891011121314151617181920212223242526272829303132var type: MTLTextureType!var texture: MTLTexture!&#x2F;&#x2F; åœ¨å¤„ç†è´´å›¾ä¸Šä½¿ç”¨CGImageåœ¨CGContextä¸Šdrawçš„æ–¹æ³•æ¥å–å¾—å›¾åƒ, ä½†æ˜¯é€šè¿‡drawæ–¹æ³•ç»˜åˆ¶çš„å›¾åƒæ˜¯ä¸Šä¸‹é¢ å€’çš„ï¼Œå¯ä»¥é€šè¿‡UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘ï¼Œç”Ÿæˆçº¹ç†func loadIntoTextureWithDevice(device: MTLDevice, name: String, ext: String) -&gt; Bool &#123; let path &#x3D; Bundle.main.path(forResource: name, ofType: ext) if !(path !&#x3D; nil) &#123; return false &#125; let image &#x3D; UIImage(contentsOfFile: path!) let width &#x3D; (image?.cgImage)!.width let height &#x3D; (image?.cgImage)!.height let dataSize &#x3D; width * height * 4 let data &#x3D; UnsafeMutablePointer&lt;UInt8&gt;.allocate(capacity: dataSize) let colorSpace &#x3D; CGColorSpaceCreateDeviceRGB() let context &#x3D; CGContext(data: data, width: width, height: height, bitsPerComponent: 8, bytesPerRow: 4 * width, space: colorSpace, bitmapInfo: CGImageAlphaInfo.premultipliedLast.rawValue); context?.draw((image?.cgImage)!, in: CGRect(x: 0, y: 0, width: CGFloat(width), height: CGFloat(height))) &#x2F;&#x2F; é€šè¿‡UIImageçš„drawInRectå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨èƒ½è‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„æ­£ç¡®æ–¹å‘ &#x2F;&#x2F; ä¸çŸ¥é“æ˜¯ä¸æ˜¯APIæ›´æ–°äº† å·²ç»ä¸éœ€è¦è¿™ä¸€æ­¥å¤„ç†å›¾ç‰‡æ–¹å‘äº† &#x2F;&#x2F; UIGraphicsPushContext(context!); &#x2F;&#x2F; image?.draw(in: CGRect(x: 0, y: 0, width: CGFloat(width), height: CGFloat(height))) let textDes &#x3D; MTLTextureDescriptor.texture2DDescriptor(pixelFormat: .rgba8Unorm, width: Int(width), height: Int(height), mipmapped: false) type &#x3D; textDes.textureType texture &#x3D; device.makeTexture(descriptor: textDes) if !(texture !&#x3D; nil) &#123; return false &#125; texture.replace(region: MTLRegionMake2D(0, 0, Int(width), Int(height)), mipmapLevel: 0, withBytes: context!.data!, bytesPerRow: width * 4) &#x2F;&#x2F; UIGraphicsPopContext() free(data) return true&#125; MetalKit Frameworkåˆ™ç›´æ¥æä¾›äº†MTKTextureLoaderåˆ›å»ºçº¹ç† å¼•å…¥MetalKitå¤´æ–‡ä»¶12import Foundationimport MetalKit MTKTextureLoaderåŠ è½½å›¾ç‰‡åˆ›å»ºçº¹ç†ï¼ŒMTKTextureLoaderä¸­æä¾›äº†å¼‚æ­¥å’ŒåŒæ­¥åŠ è½½çš„æ–¹æ³•1234567891011121314151617181920212223242526272829enum TextureError: Error &#123; case UIImageCreationError case MTKTextureLoaderError&#125;&#x2F;*----------åˆ›å»ºMetalçº¹ç†-------------- * @param device è®¾å¤‡ * @param name å›¾ç‰‡åç§° * @retun MTLTexture çº¹ç† *&#x2F;func makeTexture(device: MTLDevice, name: String) throws -&gt; MTLTexture &#123; guard let image &#x3D; UIImage(named: name) else &#123; throw TextureError.UIImageCreationError &#125; &#x2F;&#x2F; å¤„ç†åçš„å›¾ç‰‡æ˜¯å€’ç½®ï¼Œè¦å…ˆå°†å…¶å€’ç½®è¿‡æ¥æ‰èƒ½æ˜¾ç¤ºå‡ºæ­£å›¾åƒ, æˆ–è€…ä¿®æ”¹çº¹ç†åæ ‡ï¼Œå°†çº¹ç†åæ ‡å·¦ä¸Šè§’è®¾ç½®ä¸º(0,0)ï¼Œè¿™ä¸€æ­¥éª¤å¯ä»¥çœç•¥ let mirrorImage &#x3D; UIImage(cgImage: (image.cgImage)!, scale: 1, orientation: UIImageOrientation.downMirrored) let scaledImage &#x3D; UIImage.scaleToSize(mirrorImage, size: image.size) do &#123; let textureLoader &#x3D; MTKTextureLoader(device: device) let textureLoaderOption:[String: NSNumber] &#x3D; [ MTKTextureLoaderOptionSRGB: false] &#x2F;&#x2F; å¼‚æ­¥åŠ è½½ &#x2F;&#x2F; try textureLoader.newTexture(with: image.cgImage!, options: textureLoaderOption, completionHandler: &#123; (&lt;#MTLTexture?#&gt;, &lt;#Error?#&gt;) in &#x2F;&#x2F; &#x2F;&#x2F; &#125;) &#x2F;&#x2F; åŒæ­¥æ ¹æ®å›¾ç‰‡åˆ›å»ºæ–°çš„Metalçº¹ç† &#x2F;&#x2F; Synchronously loads image data and creates a new Metal texturefrom a given bitmap image. return try textureLoader.newTexture(with: scaledImage.cgImage!, options: textureLoaderOption) &#125;&#125; 123456789 &#x2F;&#x2F; è‡ªå®šä¹‰UIImageçš„ç±»æ–¹æ³•ï¼Œè®¾ç½®å›¾ç‰‡å¤§å°extension UIImage &#123; class func scaleToSize(_ image: UIImage, size: CGSize)-&gt;UIImage &#123; UIGraphicsBeginImageContext(size) image.draw(in: CGRect(origin: CGPoint.zero, size: size)) let scaledImage &#x3D; UIGraphicsGetImageFromCurrentImageContext() UIGraphicsEndImageContext() return scaledImage! &#125; 3ã€è·å–çº¹ç†åæ ‡ï¼Œæ¸²æŸ“å›¾ç‰‡ ä¹‹å‰ç»˜åˆ¶ä¸‰è§’å½¢æ˜¯ä½¿ç”¨é¡¶ç‚¹ç»˜åˆ¶çš„ï¼Œè¿™æ¬¡ä½¿ç”¨ç´¢å¼•ç»˜åˆ¶ä¸€ä¸ªå››è¾¹å½¢ã€‚ æ·»åŠ çº¹ç†å±æ€§1var quaTexture: MTLTexture! &#x3D; nil æ·»åŠ é¡¶ç‚¹buffer1var indexBuffer: MTLBuffer! &#x3D; nil æ·»åŠ é¡¶ç‚¹å’Œç´¢å¼•æ•°ç»„123456789101112131415 &#x2F;&#x2F; 3.1 åœ¨CPUåˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„ï¼Œéœ€è¦é€šè¿‡æŠŠå®ƒç§»åŠ¨åˆ°ä¸€ä¸ªMTLBufferï¼Œæ¥å‘é€è¿™äº›æ•°æ®åˆ°GPUã€‚ let vertexData:[Float] &#x3D; [&#x2F;&#x2F; 0.0, 1.0, 0.0,&#x2F;&#x2F; -1.0, -1.0, 0.0,&#x2F;&#x2F; 1.0, -1.0, 0.0 &#x2F;&#x2F;position s, t -0.5, -0.5, 0, 0, 0, 0.5, -0.5, 0, 1, 0, 0.5, 0.5, 0, 1, 1, -0.5, 0.5, 0, 0, 1, ] let indices:[Int32] &#x3D; [ 0, 1, 2, 0, 2, 3 ] åˆ›å»ºä¸€ä¸ªæ–°çš„indexBufferï¼Œå­˜æ”¾ç´¢å¼•æ•°ç»„123 &#x2F;&#x2F; 3.3 åœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„indexBufferï¼Œå­˜æ”¾ç´¢å¼•æ•°ç»„ï¼Œä»CPUé‡Œè¾“é€data indexBuffer &#x3D; device.makeBuffer(bytes: indices, length: indices.count * 4, options: MTLResourceOptions(rawValue: UInt(0)))indexBuffer.label &#x3D; &quot;Indices&quot; ç¼–è¯‘shader1234&#x2F;&#x2F; 6.1 é€šè¿‡è°ƒç”¨device.newDefaultLibraryæ–¹æ³•è·å¾—çš„MTLibraryå¯¹è±¡è®¿é—®åˆ°ä½ é¡¹ç›®ä¸­çš„é¢„ç¼–è¯‘shaders,ç„¶åé€šè¿‡åå­—æ£€ç´¢æ¯ä¸ªshaderlet defaultLibrary &#x3D; device.newDefaultLibrary() let fragmentProgram &#x3D; defaultLibrary?.makeFunction(name: &quot;texture_fragment&quot;)let vertextProgram &#x3D; defaultLibrary?.makeFunction(name: &quot;texture_vertex&quot;) åŠ è½½çº¹ç†12345678910111213&#x2F;&#x2F; åŠ è½½çº¹ç† &#x2F;&#x2F; 1 ä½¿ç”¨Metal let loaded &#x3D; loadTntoTextureWithDevice(device: device, name: &quot;lena&quot;, ext: &quot;png&quot;) if !loaded &#123; print(&quot;Failed to load texture&quot;) &#125; quaTexture &#x3D; texture&#x2F;&#x2F; 2 ä½¿ç”¨MetalKit do &#123; quaTexture &#x3D; try makeTexture(device: device, name: &quot;lena&quot;) &#125; catch &#123; fatalError(&quot;Error: Can not load texture&quot;) &#125; åœ¨renderæ–¹æ³•ä¸­é…ç½®æ¸²æŸ“å‘½ä»¤ç¼–ç å™¨ï¼Œè°ƒç”¨setFragmentTextureæ·»åŠ çº¹ç†ï¼ŒdrawIndexedPrimitivesæ ¹æ®ç´¢å¼•æ•°ç»„ç»˜åˆ¶å›¾å½¢ã€‚123renderEncoder.setFragmentTexture(quaTexture, at: 0) &#x2F;&#x2F; æ ¹æ®ç´¢å¼•ç”»å›¾renderEncoder.drawIndexedPrimitives(type: .triangle, indexCount: indices.count, indexType: .uint32, indexBuffer: indexBuffer, indexBufferOffset: 0) æœ€ç»ˆæ•ˆæœå›¾å¦‚å›¾æ‰€ç¤ºï¼Œå¯¹äºè¿™äº›åŸç†çš„ä¸œè¥¿äº†è§£è¿˜ä¸æ˜¯å¾ˆæ·±ï¼Œç½‘ä¸Šçš„èµ„æ–™å¤ªå°‘ï¼Œèƒ½åŠ›æœ‰é™ï¼Œåªèƒ½ç¢ç£¨ä¸€äº›ç®€å•çš„ä¸œè¥¿ã€‚ å¦‚æœå¯¹Metalæ„Ÿå…´è¶£çš„å¯ä»¥ä¸‹è½½Metal Swift Demo, GitHubä¸Šå¶ç„¶çœ‹åˆ°åˆ«äººå†™çš„Demoï¼Œé‡Œé¢æœ‰çº¹ç†å’ŒçŸ©é˜µï¼ŒModelIOå’ŒMetalKitçš„ç»“åˆä½¿ç”¨ç­‰ä¾‹å­ã€‚ æœ€åçŒ®ä¸ŠDemoä¾‹å­","tags":[{"name":"Metal","slug":"Metal","permalink":"http://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"http://orangeschen.cn/tags/iOS/"}]},{"title":"Metalå…¥é—¨ï¼ˆä½¿ç”¨Metalç”»ä¸€ä¸ªä¸‰è§’å½¢ï¼‰","date":"2018-05-01T16:00:00.000Z","path":"2018/05/02/metal-learn-base/","text":"å­¦ä¹ ä½¿ç”¨è‹¹æœGPUåŠ é€Ÿ3Dç»˜å›¾çš„æ–°API:MetalMetalå’ŒOpenGL ESç›¸ä¼¼ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªåº•å±‚APIï¼Œè´Ÿè´£å’Œ3Dç»˜å›¾ç¡¬ä»¶äº¤äº’ã€‚å®ƒä»¬ä¹‹é—´çš„ä¸åŒåœ¨äºï¼ŒMetalä¸æ˜¯è·¨å¹³å°çš„, Metal æ˜¯ç”¨ Objective-C ç¼– å†™çš„ï¼ŒåŸºäº Foundationï¼Œä½¿ç”¨ GCD åœ¨ CPU å’Œ GPU ä¹‹é—´ä¿æŒåŒæ­¥ã€‚ä¸ä¹‹ç›¸åçš„ï¼Œå®ƒè®¾è®¡çš„åœ¨è‹¹æœç¡¬ä»¶ä¸Šè¿è¡Œå¾—æå…¶é«˜æ•ˆï¼Œä¸OpenGL ESç›¸æ¯”ï¼Œå®ƒæä¾›äº†æ›´å¿«çš„é€Ÿåº¦å’Œæ›´ä½çš„å¼€é”€ã€‚å®ƒæ˜¯ä¸€ä¸ªGPUä¸Šä¸€ä¸ªç®€å•çš„å°è£…ï¼Œæ‰€ä»¥èƒ½å¤Ÿå®Œæˆå‡ ä¹æ‰€æœ‰äº‹æƒ…ï¼Œåƒåœ¨å±å¹•ä¸Šæ¸²æŸ“ä¸€ä¸ªç²¾çµï¼ˆspriteï¼‰æˆ–è€…æ˜¯ä¸€ä¸ª3Dæ¨¡å‹ã€‚ä½†ä½ è¦ç¼–å†™å®Œæˆè¿™äº›äº‹æƒ…çš„æ‰€æœ‰ä»£ç ã€‚è¿™æ ·éº»çƒ¦çš„ä»£ä»·æ˜¯ï¼Œä½ æ‹¥æœ‰äº†GPUçš„åŠ›é‡å’Œæ§åˆ¶ã€‚ä¼˜ç‚¹ï¼š1ã€ä½¿ç¡¬ä»¶è¾¾åˆ°è¿è¡Œæ•ˆç‡çš„å³°å€¼ï¼šå› ä¸ºMetaléå¸¸åº•å±‚ï¼Œå®ƒå…è®¸ä½ ä½¿ç¡¬ä»¶è¾¾åˆ°è¿è¡Œæ•ˆç‡çš„å³°å€¼ï¼Œå¯¹ä½ çš„æ¸¸æˆå¦‚ä½•è¿è¡Œæœ‰ç€å®Œå…¨çš„æ§åˆ¶ã€‚2ã€è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å­¦ä¹ ç»å†ï¼šå­¦ä¹ Metalæ•™å¯¼ä½ å¾ˆå¤šå…³äº3Dç»˜å›¾ç¼–ç¨‹çš„æ¦‚å¿µï¼Œç¼–å†™ä½ è‡ªå·±çš„æ¸¸æˆå¼•æ“ï¼Œä»¥åŠé«˜å±‚(higher level)æ¸¸æˆæ¡†æ¶å¦‚ä½•è¿ä½œã€‚ å…³äºmetalè¯¦ç»†çš„ä»‹ç»å¯å‚è€ƒ: ä»¥ä¸‹æ˜¯ä½¿ç”¨Metalå’ŒSwiftæ¥åˆ›å»ºä¸€ä¸ªæœ‰åŸºæœ¬è„‰ç»œçš„åº”ç”¨ï¼šç”»ä¸€ä¸ªç®€å•çš„ä¸‰è§’å½¢ã€‚æ³¨æ„ï¼šMetalåº”ç”¨ä¸èƒ½è·‘åœ¨iOSæ¨¡æ‹Ÿå™¨ä¸Šï¼Œå®ƒä»¬éœ€è¦ä¸€ä¸ªè®¾å¤‡ï¼Œè®¾å¤‡ä¸Šè£…è½½ç€è‹¹æœA7èŠ¯ç‰‡æˆ–è€…æ›´æ–°çš„èŠ¯ç‰‡ã€‚æ‰€ä»¥éœ€è¦ä¸€å°è¿™æ ·çš„è®¾å¤‡(iPhone 5S,iPad Air,iPad mini2)æ¥å®Œæˆä»£ç çš„æµ‹è¯•ã€‚æ‰“å¼€Xcode é€šè¿‡iOS\\Application\\Single View Application templateåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚ä½¿ç”¨TriangleSwiftä½œä¸ºé¡¹ç›®åç§°ï¼Œè®¾ç½®å¼€å‘è¯­è¨€ä¸ºSwiftï¼Œè®¾ç½®è®¾å¤‡ä¸ºé€šç”¨è®¾å¤‡(Universal)ã€‚ç‚¹å‡»Nextï¼Œé€‰æ‹©ä¸€ä¸ªç›®å½•ï¼Œç‚¹å‡»Createã€‚æœ‰ä¸ƒä¸ªæ­¥éª¤æ¥è®¾ç½®metalï¼š1 åˆ›å»ºä¸€ä¸ªMTLDevice2 åˆ›å»ºä¸€ä¸ªCAMetalLayer3 åˆ›å»ºä¸€ä¸ªVertex Buffer4 åˆ›å»ºä¸€ä¸ªVertex Shader5 åˆ›å»ºä¸€ä¸ªFragment Shader6 åˆ›å»ºä¸€ä¸ªRender Pipeline7 åˆ›å»ºä¸€ä¸ªCommand Queue 1 åˆ›å»ºä¸€ä¸ªMTLDeviceä½¿ç”¨Metalä½ è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è·å–ä¸€ä¸ªMTLDeviceçš„å¼•ç”¨ã€‚ä¸ºäº†å®Œæˆè¿™ç‚¹ï¼Œæ‰“å¼€ViewController.swift å¹¶æ·»åŠ ä¸‹é¢çš„importè¯­å¥ 1import Metal å¯¼å…¥äº†Metalæ¡†æ¶ï¼Œæ‰€ä»¥ä½ èƒ½å¤Ÿä½¿ç”¨Metalçš„ç±»ï¼ˆåƒè¿™æ–‡ä»¶ä¸­çš„MTLDeviceï¼‰ã€‚æ¥ç€ï¼Œåœ¨ViewControllerç±»ä¸­æ·»åŠ ä»¥ä¸‹å±æ€§ï¼šåœ¨viewDidLoadå‡½æ•°å†…åˆå§‹åŒ–è¿™ä¸ªå±æ€§ 12&#x2F;&#x2F; 1ã€åˆ›å»ºä¸€ä¸ªMTLDevice, ä½ å¯ä»¥æŠŠä¸€ä¸ªMTLDeviceæƒ³è±¡æˆæ˜¯ä½ å’ŒCPUçš„ç›´æ¥è¿æ¥ã€‚ä½ å°†é€šè¿‡ä½¿ç”¨MTLDeviceåˆ›å»ºæ‰€æœ‰å…¶ä»–ä½ éœ€è¦çš„Metalå¯¹è±¡ï¼ˆåƒæ˜¯command queuesï¼Œbuffersï¼Œtexturesï¼‰ã€‚var device: MTLDevice! &#x3D; nil 2 åˆ›å»ºä¸€ä¸ªCAMetalLayeråœ¨iOSé‡Œï¼Œä½ åœ¨å±å¹•ä¸Šçœ‹è§çš„æ‰€æœ‰ä¸œè¥¿ï¼Œè¢«ä¸€ä¸ªCALayeræ‰€æ‰¿è½½ã€‚å­˜åœ¨ä¸åŒç‰¹æ•ˆçš„CALayerçš„å­ç±»ï¼Œæ¯”å¦‚ï¼šæ¸å˜å±‚(gradient layers)ã€å½¢çŠ¶å±‚ï¼ˆshapelayersï¼‰ã€é‡å¤å±‚(replicator layers) ç­‰ç­‰ã€‚å¦‚æœä½ æƒ³è¦ç”¨Metalåœ¨å±å¹•ä¸Šç”»ä¸€äº›ä¸œè¥¿ï¼Œä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªç‰¹åˆ«çš„CALayerå­ç±»ï¼ŒCAMetalLayerã€‚å› ä¸ºCAMetalLayeræ˜¯QuartzCoreæ¡†æ¶çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯Metalæ¡†æ¶é‡Œçš„ï¼Œé¦–å…ˆåœ¨è¿™ä¸ªæ–‡ä»¶çš„ä¸Šæ–¹æ·»åŠ importè¯­å¥ 1import QuartzCore æŠŠæ–°å±æ€§æ·»åŠ åˆ°ç±»ä¸­ï¼š 12&#x2F;&#x2F; 2ã€åˆ›å»ºä¸€ä¸ªCAMetalLayervar metalLayer: CAMetalLayer! &#x3D; nil è®¾ç½®metalLayer 123456789101112131415&#x2F;&#x2F; 2.1 åˆ›å»ºCAMetalLayermetalLayer &#x3D; CAMetalLayer()&#x2F;&#x2F; 2.2 å¿…é¡»æ˜ç¡®layerä½¿ç”¨çš„MTLDeviceï¼Œç®€å•åœ°è®¾ç½®æ—©å‰è·å–çš„devicemetalLayer.device &#x3D; device&#x2F;&#x2F; 2.3 æŠŠåƒç´ æ ¼å¼ï¼ˆpixel formatï¼‰è®¾ç½®ä¸ºBGRA8Unormï¼Œå®ƒä»£è¡¨&quot;8å­—èŠ‚ä»£è¡¨è“è‰²ã€ç»¿è‰²ã€çº¢è‰²å’Œé€æ˜åº¦ï¼Œé€šè¿‡åœ¨0åˆ°1ä¹‹é—´å•ä½åŒ–çš„å€¼æ¥è¡¨ç¤º&quot;ã€‚è¿™æ¬¡ä¸¤ç§ç”¨åœ¨CAMetalLayerçš„åƒç´ æ ¼å¼ä¹‹ä¸€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½ è¿™æ ·å†™å°±å¯ä»¥äº†ã€‚metalLayer.pixelFormat &#x3D; .bgra8Unorm&#x2F;&#x2F; 2.4 è‹¹æœé¼“åŠ±å°†framebufferOnlyè®¾ç½®ä¸ºtrueï¼Œæ¥å¢å¼ºè¡¨ç°æ•ˆç‡ã€‚é™¤éä½ éœ€è¦å¯¹ä»layerç”Ÿæˆçš„çº¹ç†ï¼ˆtexturesï¼‰å–æ ·ï¼Œæˆ–è€…ä½ éœ€è¦åœ¨layerç»˜å›¾çº¹ç†(drawable textures)æ¿€æ´»ä¸€äº›è®¡ç®—å†…æ ¸ï¼Œå¦åˆ™ä½ ä¸éœ€è¦è®¾ç½®ã€‚ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä½ ä¸ç”¨è®¾ç½®ï¼‰metalLayer.framebufferOnly &#x3D; true&#x2F;&#x2F; 2.5 æŠŠlayerçš„frameè®¾ç½®ä¸ºviewçš„framemetalLayer.frame &#x3D; view.layer.framevar drawableSize &#x3D; self.view.bounds.sizedrawableSize.width *&#x3D; self.view.contentScaleFactordrawableSize.height *&#x3D; self.view.contentScaleFactormetalLayer.drawableSize &#x3D; drawableSizeview.layer.addSublayer(metalLayer) 3 åˆ›å»ºä¸€ä¸ªVertex Bufferåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºã€‚åœ¨ä½ çš„ç±»ä¸­æ·»åŠ ä¸‹åˆ—çš„å¸¸é‡å±æ€§ 12345678&#x2F;&#x2F; 3ã€åˆ›å»ºä¸€ä¸ªVertex Buffervar vertexBuffer: MTLBuffer! &#x3D; nil&#x2F;&#x2F; 3.1 åœ¨CPUåˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„ï¼Œéœ€è¦é€šè¿‡æŠŠå®ƒç§»åŠ¨åˆ°ä¸€ä¸ªMTLBufferï¼Œæ¥å‘é€è¿™äº›æ•°æ®åˆ°GPUã€‚let vertexData:[Float] &#x3D; [ 0.0, 1.0, 0.0, -1.0, -1.0, 0.0, 1.0, -1.0, 0.0] åœ¨MTLDeviceä¸Šè°ƒç”¨makeBuffer(bytes:, length:, options:)ï¼Œåœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„bufferï¼Œä»CPUé‡Œè¾“é€dataã€‚optionsä¸èƒ½ä¸ºç©ºã€‚ 1234&#x2F;&#x2F; 3.2 è·å–vertex dataçš„å­—èŠ‚å¤§å°ã€‚ä½ é€šè¿‡æŠŠå…ƒç´ çš„å¤§å°å’Œæ•°ç»„å…ƒç´ ä¸ªæ•°ç›¸ä¹˜æ¥å¾—åˆ°let dataSize &#x3D; vertexData.count * 4&#x2F;&#x2F; 3.3 åœ¨GPUåˆ›å»ºä¸€ä¸ªæ–°çš„bufferï¼Œä»CPUé‡Œè¾“é€datavertexBuffer &#x3D; device.makeBuffer(bytes: vertexData, length: dataSize, options: MTLResourceOptions(rawValue: UInt(0))) 4 åˆ›å»ºä¸€ä¸ªVertex Shaderä½ ä¹‹å‰åˆ›å»ºçš„é¡¶ç‚¹å°†æˆä¸ºæ¥ä¸‹æ¥å†™çš„ä¸€ä¸ªå«vertext shaderçš„å°ç¨‹åºçš„è¾“å…¥ã€‚ä¸€ä¸ªvertex shader æ˜¯ä¸€ä¸ªåœ¨GPUä¸Šè¿è¡Œçš„å°ç¨‹åºï¼Œå®ƒç”±åƒc++çš„ä¸€é—¨è¯­è¨€ç¼–å†™ï¼Œé‚£é—¨è¯­è¨€å«åšMetal Shading Languageã€‚ä¸€ä¸ªvertex shaderè¢«æ¯ä¸ªé¡¶ç‚¹è°ƒç”¨ï¼Œå®ƒçš„å·¥ä½œæ˜¯æ¥å—é¡¶ç‚¹çš„ä¿¡æ¯ï¼ˆå¦‚ï¼šä½ç½®å’Œé¢œè‰²ã€çº¹ç†åæ ‡ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ½œåœ¨çš„ä¿®æ­£ä½ç½®ï¼ˆå¯èƒ½è¿˜æœ‰åˆ«çš„ç›¸å…³ä¿¡æ¯ï¼‰ç‚¹å‡»File\\New\\Fileï¼Œé€‰æ‹©iOS\\Source\\Metal Fileï¼Œç„¶åç‚¹å‡»Nextã€‚è¾“å…¥Shader.metalä½œä¸ºæ–‡ä»¶åï¼Œç„¶åç‚¹å‡»Createã€‚ 1234567891011121314&#x2F;&#x2F; ä¸€ä¸ªvertex shaderè¢«æ¯ä¸ªé¡¶ç‚¹è°ƒç”¨ï¼Œå®ƒçš„å·¥ä½œæ˜¯æ¥å—é¡¶ç‚¹çš„ä¿¡æ¯ï¼ˆå¦‚ï¼šä½ç½®å’Œé¢œè‰²ã€çº¹ç†åæ ‡ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ½œåœ¨çš„ä¿®æ­£ä½ç½®ï¼ˆå¯èƒ½è¿˜æœ‰åˆ«çš„ç›¸å…³ä¿¡æ¯ï¼‰#include &lt;metal_stdlib&gt;using namespace metal;&#x2F;** * 1ã€æ‰€æœ‰çš„vertex shaderså¿…é¡»ä»¥å…³é”®å­—vertexå¼€å¤´ã€‚å‡½æ•°å¿…é¡»è‡³å°‘è¿”å›é¡¶ç‚¹çš„æœ€ç»ˆä½ç½®â€”â€”ä½ é€šè¿‡æŒ‡å®šfloat4ï¼ˆä¸€ä¸ªå…ƒç´ ä¸º4ä¸ªæµ®ç‚¹æ•°çš„å‘é‡ï¼‰ã€‚ç„¶åä½ ç»™ä¸€ä¸ªåå­—ç»™vetex shaderï¼Œä»¥åä½ å°†ç”¨è¿™ä¸ªåå­—æ¥è®¿é—®è¿™ä¸ªvertex shaderã€‚ * 2ã€vertex shaderä¼šæ¥å—ä¸€ä¸ªåå«vertex_idçš„å±æ€§çš„ç‰¹å®šå‚æ•°ï¼Œå®ƒæ„å‘³ç€å®ƒä¼šè¢«vertexæ•°ç»„é‡Œç‰¹å®šçš„é¡¶ç‚¹æ‰€è£…å…¥ã€‚ * 3ã€ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå…ƒç´ ä¸ºpacked_float4(ä¸€ä¸ªå‘é‡åŒ…å«4ä¸ªæµ®ç‚¹æ•°)çš„æ•°ç»„çš„æŒ‡é’ˆï¼Œå¦‚ï¼šæ¯ä¸ªé¡¶ç‚¹çš„ä½ç½®ã€‚è¿™ä¸ª [[ ... ]] è¯­æ³•è¢«ç”¨åœ¨å£°æ˜é‚£äº›èƒ½è¢«ç”¨ä½œç‰¹å®šé¢å¤–ä¿¡æ¯çš„å±æ€§ï¼Œåƒæ˜¯èµ„æºä½ç½®ï¼Œshaderè¾“å…¥ï¼Œå†…å»ºå˜é‡ã€‚è¿™é‡Œä½ æŠŠè¿™ä¸ªå‚æ•°ç”¨ [[ buffer(0) ]] æ ‡è®°ï¼Œæ¥æŒ‡æ˜è¿™ä¸ªå‚æ•°å°†ä¼šè¢«åœ¨ä½ ä»£ç ä¸­ä½ å‘é€åˆ°ä½ çš„vertex shaderçš„ç¬¬ä¸€å—buffer dataæ‰€éå†ã€‚ * 4ã€åŸºäºvertex idæ¥æ£€ç´¢vertexæ•°ç»„ä¸­å¯¹åº”ä½ç½®çš„vertexå¹¶æŠŠå®ƒè¿”å›ã€‚å‘é‡å¿…é¡»ä¸ºä¸€ä¸ªfloat4ç±»å‹vertex float4 basic_vertex ( constant packed_float3* vertex_array[[buffer(0)]], unsigned int vid[[vertex_id]])&#123; return float4(vertex_array[vid], 1.0);&#125; *&#x2F; 5 åˆ›å»ºä¸€ä¸ªFragment Shaderå®Œæˆvertex shaderåï¼Œå¦ä¸€ä¸ªshaderï¼Œå®ƒè¢«æ¯ä¸ªåœ¨å±å¹•ä¸Šçš„fragment(think pixel)è°ƒç”¨ï¼Œå®ƒå°±æ˜¯fragment shaderã€‚fragment shaderé€šè¿‡å†…æ’(interpolating)vertex shaderçš„è¾“å‡ºæ¥è·å¾—è‡ªå·±çš„è¾“å…¥ã€‚ 1234567&#x2F;* 1. æ‰€æœ‰fragment shaderså¿…é¡»ä»¥fragmentå…³é”®å­—å¼€å§‹ã€‚è¿™ä¸ªå‡½æ•°å¿…é¡»è‡³å°‘è¿”å›fragmentçš„æœ€ç»ˆé¢œè‰²â€”â€”ä½ é€šè¿‡æŒ‡å®šhalf4ï¼ˆä¸€ä¸ªé¢œè‰²çš„RGBAå€¼ï¼‰æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚æ³¨æ„ï¼Œhalf4æ¯”float4åœ¨å†…å­˜ä¸Šæ›´æœ‰æ•ˆç‡ï¼Œå› ä¸ºï¼Œä½ å†™å…¥äº†æ›´å°‘çš„GPUå†…å­˜ã€‚ 2. è¿™é‡Œä½ è¿”å›(0.6,0.6,0.6,0.6)çš„é¢œè‰²ï¼Œä¹Ÿå°±æ˜¯ç°è‰²ã€‚ *&#x2F;fragment half4 basic_fragment() &#123; return half4(0.6);&#125; 6 åˆ›å»ºä¸€ä¸ªRender Pipelineç°åœ¨ä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªvertex shaderå’Œä¸€ä¸ªfragment shaderï¼Œä½ éœ€è¦ç»„åˆå®ƒä»¬ï¼ˆåŠ ä¸Šä¸€äº›é…ç½®æ•°æ®ï¼‰åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒåå«render pipelineã€‚Metalçš„æ¸²æŸ“å™¨ï¼ˆshadersï¼‰æ˜¯é¢„ç¼–è¯‘çš„ï¼Œrender pipeline é…ç½®ä¼šåœ¨ä½ ç¬¬ä¸€æ¬¡è®¾ç½®å®ƒçš„æ—¶å€™è¢«ç¼–è¯‘ï¼Œæ‰€ä»¥æ‰€æœ‰äº‹æƒ…éƒ½æå…¶é«˜æ•ˆã€‚é¦–å…ˆåœ¨ViewController.swifté‡Œæ·»åŠ ä¸€ä¸ªå±æ€§ï¼š 12&#x2F;&#x2F; 6ã€åˆ›å»ºä¸€ä¸ªRender Pipelinevar pipelineState: MTLRenderPipelineState! &#x3D; nil åœ¨viewDidLoadæ–¹æ³•æœ€åæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š 12345678&#x2F;&#x2F; 6.1 é€šè¿‡è°ƒç”¨device.newDefaultLibraryæ–¹æ³•è·å¾—çš„MTLibraryå¯¹è±¡è®¿é—®åˆ°ä½ é¡¹ç›®ä¸­çš„é¢„ç¼–è¯‘shaders,ç„¶åé€šè¿‡åå­—æ£€ç´¢æ¯ä¸ªshader let defaultLibrary &#x3D; device.newDefaultLibrary() let fragmentProgram &#x3D; defaultLibrary?.makeFunction(name: &quot;basic_fragment&quot;) let vertextProgram &#x3D; defaultLibrary?.makeFunction(name: &quot;basic_vertex&quot;) &#x2F;&#x2F; 6.2 è¿™é‡Œè®¾ç½®ä½ çš„render pipelineã€‚å®ƒåŒ…å«ä½ æƒ³è¦ä½¿ç”¨çš„shadersã€é¢œè‰²é™„ä»¶ï¼ˆcolor attachmentï¼‰çš„åƒç´ æ ¼å¼(pixel format)ã€‚ï¼ˆä¾‹å¦‚ï¼šä½ æ¸²æŸ“åˆ°çš„è¾“å…¥ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯CAMetalLayerï¼‰ let pipelineStateDescriptor &#x3D; MTLRenderPipelineDescriptor() pipelineStateDescriptor.vertexFunction &#x3D; vertextProgram pipelineStateDescriptor.fragmentFunction &#x3D; fragmentProgram pipelineStateDescriptor.colorAttachments[0].pixelFormat &#x3D; .bgra8Unorm 7 åˆ›å»ºä¸€ä¸ªCommand Queueä½ éœ€è¦åšçš„æœ€ç»ˆçš„è®¾ç½®æ­¥éª¤ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªMTLCommandQueueã€‚æŠŠè¿™ä¸ªæƒ³è±¡æˆæ˜¯ä¸€ä¸ªåˆ—è¡¨è£…è½½ç€ä½ å‘Šè¯‰GPUä¸€æ¬¡è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¦åˆ›å»ºä¸€ä¸ªcommand queueï¼Œç®€å•åœ°æ·»åŠ ä¸€ä¸ªå±æ€§ï¼š 12&#x2F;&#x2F; 7ã€åˆ›å»ºä¸€ä¸ªCommand Queuevar commandQueue: MTLCommandQueue! &#x3D; nil æŠŠä¸‹é¢è¿™è¡Œæ·»åŠ åˆ°viewDidLoadä¸­ï¼š 12&#x2F;&#x2F; 7.1 åˆå§‹åŒ–commandQueuecommandQueue &#x3D; device.makeCommandQueue() é¢„è®¾ç½®çš„ä»£ç åˆ°è¿™é‡Œå®Œæˆäº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ¸²æŸ“ä¸‰è§’å½¢äº†ï¼Œå®ƒå°†éœ€è¦åœ¨äº”ä¸ªæ­¥éª¤æ¥å®Œæˆï¼š1 åˆ›å»ºä¸€ä¸ªDisplay linkã€‚2 åˆ›å»ºä¸€ä¸ªRender Pass Descriptor3 åˆ›å»ºä¸€ä¸ªCommand Buffer4 åˆ›å»ºä¸€ä¸ªRender Command Encoder5 æäº¤Command Bufferçš„å†…å®¹æ³¨æ„ï¼šç†è®ºä¸Šè¿™ä¸ªåº”ç”¨å®é™…ä¸Šä¸éœ€è¦æ¯å¸§æ¸²æŸ“ï¼Œå› ä¸ºä¸‰è§’å½¢è¢«ç»˜åˆ¶ä¹‹åä¸ä¼šåŠ¨ã€‚ä½†æ˜¯ï¼Œå¤§éƒ¨åˆ†åº”ç”¨ä¼šæœ‰ç‰©ä½“çš„ç§»åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šé‚£æ ·åšã€‚ 1 åˆ›å»ºä¸€ä¸ªDisplay linkåœ¨iOSå¹³å°ä¸Šï¼Œé€šè¿‡CADisplayLink ç±»ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå‡½æ•°åœ¨æ¯æ¬¡è®¾å¤‡å±å¹•åˆ·æ–°çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œè¿™æ ·ä½ å°±å¯ä»¥é‡ç»˜å±å¹•ã€‚ä¸ºäº†ä½¿ç”¨å®ƒï¼Œåœ¨ç±»é‡Œæ·»åŠ ä¸€ä¸ªæ–°çš„å±æ€§ï¼š 12&#x2F;&#x2F; 8ã€åˆ›å»ºä¸€ä¸ªDisplay Linkvar timer: CADisplayLink! &#x3D; nil åˆå§‹åŒ–timer 123&#x2F;&#x2F; 8.1 åˆå§‹åŒ– timerï¼Œè®¾ç½®timerï¼Œè®©å®ƒæ¯æ¬¡åˆ·æ–°å±å¹•çš„æ—¶å€™è°ƒç”¨ä¸€ä¸ªåå«drawloopçš„æ–¹æ³•timer &#x3D; CADisplayLink(target: self, selector: #selector(ViewController.drawloop))timer.add(to: RunLoop.main, forMode: RunLoopMode.defaultRunLoopMode) æ¸²æŸ“çš„ä»£ç åœ¨render()ä¸­å®ç° 12345678func render() &#123; &#x2F;&#x2F;TODO&#125;func drawloop() &#123; self.render() &#125; 2 åˆ›å»ºä¸€ä¸ªRender Pass Descriptor123456789&#x2F;&#x2F; metal layerä¸Šè°ƒç”¨nextDrawable() ï¼Œå®ƒä¼šè¿”å›ä½ éœ€è¦ç»˜åˆ¶åˆ°å±å¹•ä¸Šçš„çº¹ç†(texture)let drawable &#x3D; metalLayer.nextDrawable()&#x2F;&#x2F; 8ã€åˆ›å»ºä¸€ä¸ªRender Pass Descriptorï¼Œé…ç½®ä»€ä¹ˆçº¹ç†ä¼šè¢«æ¸²æŸ“åˆ°ã€clear colorï¼Œä»¥åŠå…¶ä»–çš„é…ç½®let renderPassDesciptor &#x3D; MTLRenderPassDescriptor()renderPassDesciptor.colorAttachments[0].texture &#x3D; drawable?.texture&#x2F;&#x2F; è®¾ç½®load actionä¸ºclearï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç»˜åˆ¶ä¹‹å‰ï¼ŒæŠŠçº¹ç†æ¸…ç©ºrenderPassDesciptor.colorAttachments[0].loadAction &#x3D; .clear&#x2F;&#x2F; ç»˜åˆ¶çš„èƒŒæ™¯é¢œè‰²è®¾ç½®ä¸ºç»¿è‰²renderPassDesciptor.colorAttachments[0].clearColor &#x3D; MTLClearColorMake(0.0, 0.8, 0.5, 1.0) 3 åˆ›å»ºä¸€ä¸ªCommand Bufferä¸€ä¸ªcommand bufferåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¸²æŸ“æŒ‡ä»¤ï¼ˆrender commandsï¼‰ã€‚ 123&#x2F;&#x2F; 9ã€åˆ›å»ºä¸€ä¸ªCommand Buffer&#x2F;&#x2F; ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡ä¸ºä¸€ç³»åˆ—è¿™ä¸€å¸§æƒ³è¦æ‰§è¡Œçš„æ¸²æŸ“å‘½ä»¤ã€‚æ³¨æ„åœ¨ä½ æäº¤command bufferä¹‹å‰ï¼Œæ²¡æœ‰äº‹æƒ…ä¼šçœŸæ­£å‘ç”Ÿï¼Œè¿™æ ·ç»™ä½ å¯¹äº‹ç‰©åœ¨ä½•æ—¶å‘ç”Ÿæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ§åˆ¶ã€‚let commandBuffer &#x3D; commandQueue.makeCommandBuffer() 4 åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å‘½ä»¤ç¼–ç å™¨(Render Command Encoder)12345678910111213141516171819 &#x2F;&#x2F; 10ã€åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å‘½ä»¤ç¼–ç å™¨(Render Command Encoder) &#x2F;&#x2F; åˆ›å»ºä¸€ä¸ªcommand encoderï¼Œå¹¶æŒ‡å®šä½ ä¹‹å‰åˆ›å»ºçš„pipelineå’Œé¡¶ç‚¹ let renderEncoder &#x3D; commandBuffer.makeRenderCommandEncoder(descriptor: renderPassDesciptor) renderEncoder.setRenderPipelineState(pipelineState) renderEncoder.setVertexBuffer(vertexBuffer, offset: 0, at: 0) &#x2F;** ç»˜åˆ¶å›¾å½¢ - parameter type: ç”»ä¸‰è§’å½¢ - parameter vertexStart: ä»vertex buffer ä¸‹æ ‡ä¸º0çš„é¡¶ç‚¹å¼€å§‹ - parameter vertexCount: é¡¶ç‚¹æ•° - parameter instanceCount: æ€»å…±æœ‰1ä¸ªä¸‰è§’å½¢ *&#x2F; renderEncoder.drawPrimitives(type: .triangle, vertexStart: 0, vertexCount: 3, instanceCount: 1) &#x2F;&#x2F; å®Œæˆåï¼Œè°ƒç”¨endEncoding() renderEncoder.endEncoding()&#96;&#96;&#96; ##### 5 æäº¤Command Buffer // ä¿è¯æ–°çº¹ç†ä¼šåœ¨ç»˜åˆ¶å®Œæˆåç«‹å³å‡ºç° commandBuffer.present(drawable!) // æäº¤äº‹åŠ¡(transaction), æŠŠä»»åŠ¡äº¤ç»™GPU commandBuffer.commit()##### å­¦ä¹ èµ„æ–™ï¼š â€¢ è‹¹æœMetal[å¼€å‘è€…æ–‡æ¡£](https://developer.apple.com/metal/)ï¼Œæœ‰å¾ˆå¤šæ–‡æ¡£ã€å½•åƒã€æ ·ä¾‹ä»£ç çš„é“¾æ¥ã€‚ â€¢ è‹¹æœçš„Metal[ç¼–ç¨‹æŒ‡å¯¼](https://developer.apple.com/library/prerelease/ios/documentation/Miscellaneous/Conceptual/MTLProgGuide/Introduction/Introduction.html) â€¢ è‹¹æœçš„Metal [Shading Language æŒ‡å¯¼](https://developer.apple.com/library/prerelease/ios/documentation/Metal/Reference/MetalShadingLanguageGuide/Introduction/Introduction.html) â€¢ [WWDC2014 Metalå½•åƒ](https://developer.apple.com/videos/wwdc/2014/)","tags":[{"name":"Metal","slug":"Metal","permalink":"http://orangeschen.cn/tags/Metal/"},{"name":"iOS","slug":"iOS","permalink":"http://orangeschen.cn/tags/iOS/"}]},{"title":"iOS-private-api-checkerç§æœ‰APIæ£€æµ‹å·¥å…·ä½¿ç”¨è¯¦ç»†æ­¥éª¤","date":"2018-04-01T16:00:00.000Z","path":"2018/04/02/private-api-checker/","text":"iOS-private-api-checkerç§æœ‰APIæ£€æŸ¥è¯¦ç»†æ­¥éª¤ï¼ˆæ¶‰åŠåˆ° Pythonã€Flaskã€sqlite ç¯å¢ƒï¼‰1ã€ä¸‹è½½iOS-private-api-checker-master https://github.com/hustcc/iOS-private-api-checker 2ã€ä¸‹è½½å·²ç»buildå¥½çš„ios_private.dbåº“(æœ¬äººèƒ½åŠ›æœ‰é™ï¼Œä¸ä¼šbuildï¼Œè¿™ä¸ªæ˜¯å¤§ç¥buildå¥½çš„ï¼Œsdk7.0ç‰ˆæœ¬ï¼Œä¸æ˜¯æœ€æ–°çš„ï¼Œæ‰€ä»¥æœ‰äº›ç§æœ‰åº“æŸ¥ä¸å‡ºæ¥(PS: æˆ–è€…æœ‰äº›å·²ç»å…¬å¼€çš„åº“æ£€æµ‹ä¸ºç§æœ‰åº“ï¼ï¼è¯¦æƒ…è¯·çœ‹ä¸Šé¢çš„é“¾æ¥ï¼Œgithubä¸Šæœ‰æ•™ç¨‹ï¼Œå†™è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³å°è¯•ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œå‡†ç¡®æ€§ä¸æ•¢ä¿è¯)ï¼Œgithubä¸Šæœ‰æ•™ç¨‹ï¼Œæœ‰èƒ½åŠ›çš„å¯ä»¥è‡ªå·±build^^)ï¼Œå°† ios_private.db æ”¾å…¥åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œä¸»è¦ä¿®æ”¹å¯å†™æƒé™ï¼› ï¼ˆå¤‡æ³¨ï¼šios_private.db ä¸‹è½½åœ°å€ï¼š é“¾æ¥: https://pan.baidu.com/s/1d7YlSa å¯†ç : fimxï¼‰ 3ã€åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª tmp ç›®å½•ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼Œæ³¨æ„ä¿®æ”¹å¯å†™æƒé™ï¼‰ï¼Œæˆ–è€…å°†tmpçš„æ–‡ä»¶å¤¹çš„æƒé™è®¾ç½®ä¸º777ï¼Œå…ˆè¿›terminalï¼Œç„¶åè¾“å…¥Wallyçš„å‘½ä»¤ï¼Œåé¢æ·»åŠ ä½ çš„ç›®å½•åã€‚ 1$ sudo chmod -R 777 ç›®å½•å 4ã€åœ¨ç»ˆç«¯è¾“å…¥sqlite3 , å‡ºç°è¿™ä¸ªè¡¨ç¤ºå·²ç»å®‰è£…äº†sqliteï¼Œæ²¡æœ‰åˆ™å‚è€ƒ http://www.runoob.com/sqlite/sqlite-installation.html è¿›è¡Œå®‰è£… å®‰è£…sqlite5ã€é…ç½®flaskç¯å¢ƒ 5.1 Macç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…å¥½äº†Python 2.7 5.2 å®‰è£…pythonçš„åŒ…ç®¡ç†å™¨pip ï¼Œå…ˆä¸‹è½½ get-pip.py ï¼š https://bootstrap.pypa.io/get-pip.py æ‰§è¡Œå®‰è£…å‘½ä»¤ 1$ sudo python get-pip.py 5.3 å®‰è£…virtualenvï¼Œvirtualenv ä¸ºæ¯ä¸ªä¸åŒé¡¹ç›®æä¾›ä¸€ä»½ Python å®‰è£…ã€‚å®ƒå¹¶æ²¡æœ‰çœŸæ­£å®‰è£…å¤šä¸ª Python å‰¯æœ¬ï¼Œä½†æ˜¯å®ƒç¡®å®æä¾›äº†ä¸€ç§å·§å¦™çš„æ–¹å¼æ¥è®©å„é¡¹ç›®ç¯å¢ƒä¿æŒç‹¬ç«‹ã€‚ 1$ sudo pip install virtualenv 5.4 å¼€å§‹é…ç½®flaskç¯å¢ƒ 1234567891011è¿›åˆ°é¡¹ç›®ç›®å½•$ cd é¡¹ç›®è·¯å¾„åˆ›å»ºflaskæ–‡ä»¶å¤¹$ virtualenv flask$ cd flaskæ¿€æ´»ç¯å¢ƒ$ source bin/activateå®‰è£…flask$ pip install flaskå›åˆ°æ ¹ç›®å½•$ cd - 6 ã€å®‰è£… macholib 1$ pip install macholib 7ã€æœ€åè¿è¡Œ run_webï¼ˆæˆ–è€… ï¼‰ 1$ python run_web.py åœ¨æµè§ˆå™¨ä¸­è¾“å…¥127.0.0.1:9527 å°†ipaæ‹–å…¥ä¸Šä¼ æ¡†ç­‰å¾…å³å¯çœ‹åˆ°æ£€æŸ¥ç»“æœ","tags":[{"name":"iOS","slug":"iOS","permalink":"http://orangeschen.cn/tags/iOS/"}]},{"title":"Hello World","date":"2017-11-08T13:40:40.000Z","path":"2017/11/08/hello-world/","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new \"My New Post\" More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","tags":[]}]